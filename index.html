<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Карта операторов — OpenLayers</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.2.4/ol.css">
  <script src="https://cdn.jsdelivr.net/npm/ol@v9.2.4/dist/ol.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html, body, #map { height:100%; margin:0 }
    .ol-popup {
      position:absolute; background:white; padding:8px 10px; border-radius:8px;
      border:1px solid #e5e7eb; box-shadow:0 2px 12px rgba(0,0,0,.15);
      min-width:180px;
    }
    .ol-popup:after, .ol-popup:before {
      top:100%; border:solid transparent; content:" "; height:0; width:0; position:absolute; pointer-events:none;
    }
    .ol-popup:after { border-top-color:#fff; border-width:10px; left:24px; margin-left:-10px; }
    .ol-popup:before { border-top-color:#e5e7eb; border-width:11px; left:24px; margin-left:-11px; }
  </style>
</head>
<body>
<div id="map"></div>

<script>
const OPS_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ60bXKqgYfT7N7M5Le0ZWLn4r1ybhUxuYwzAg4hjroeMZHUT_omLa4GwahRBfrEzlG8RKLWMhrKiOP/pub?gid=304610077&single=true&output=csv';
const POINTS_CSV_URL =
  'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ60bXKqgYfT7N7M5Le0ZWLn4r1ybhUxuYwzAg4hjroeMZHUT_omLa4GwahRBfrEzlG8RKLWMhrKiOP/pub?gid=0&single=true&output=csv';

const map = new ol.Map({
  target: 'map',
  layers: [ new ol.layer.Tile({ source: new ol.source.OSM() }) ],
  view: new ol.View({ center: ol.proj.fromLonLat([37.62, 55.75]), zoom: 10 })
});

const vectorSource = new ol.source.Vector();
const vectorLayer = new ol.layer.Vector({
  source: vectorSource,
  style: new ol.style.Style({
    image: new ol.style.Circle({
      radius: 5,
      fill: new ol.style.Fill({color:'#2d6cdf'}),
      stroke: new ol.style.Stroke({color:'#1e3a8a', width:1})
    })
  })
});
map.addLayer(vectorLayer);

// простая загрузка CSV
const toNum = v => (typeof v==='number') ? v : Number(String(v||'').replace(',', '.'));
function loadCSV(url){
  return new Promise((res,rej)=>{
    Papa.parse(url + (url.includes('?')?'&':'?')+'t='+Date.now(), {
      download:true, header:true, skipEmptyLines:true,
      complete:r=>res(r.data), error:rej
    });
  });
}

(async ()=>{
  const [opsRows, pointsRows] = await Promise.all([loadCSV(OPS_CSV_URL), loadCSV(POINTS_CSV_URL)]);
  const feats = [];
  for (const r of pointsRows){
    const lat = toNum(r.lat), lng = toNum(r.lng);
    if (!isFinite(lat) || !isFinite(lng)) continue;
    const f = new ol.Feature({
      geometry: new ol.geom.Point(ol.proj.fromLonLat([lng, lat])),
      name: (r.name||'').trim(),
      operator: (r.operator||'').trim(),
      class: (r.class||'').trim(),
      freq: (r.freq||'').trim(),
      sales: (r.sales||'').trim(),
    });
    feats.push(f);
  }
  vectorSource.addFeatures(feats);

  if (feats.length){
    const extent = vectorSource.getExtent();
    map.getView().fit(extent, {padding:[20,20,20,20]});
  }
})();

// простой попап
const container = document.createElement('div'); container.className = 'ol-popup';
const overlay = new ol.Overlay({ element: container, positioning:'bottom-left', offset:[12,-12] });
map.addOverlay(overlay);

map.on('singleclick', e=>{
  const feat = map.forEachFeatureAtPixel(e.pixel, f=>f);
  if (!feat) return overlay.setPosition(undefined);
  const p = feat.getProperties();
  container.innerHTML = `<b>${p.name||''}</b><br>${p.operator||''}`
    + (p.class?`<br>Класс: ${p.class}`:'')
    + (p.freq?`<br>Частота: ${p.freq}`:'')
    + (p.sales?`<br>Продажи: ${p.sales}`:'');
  overlay.setPosition(e.coordinate);
});
</script>
</body>
</html>
