<script>
  /* ====== ТВОИ CSV-ССЫЛКИ ====== */
  const OPS_CSV_URL =
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ60bXKqgYfT7N7M5Le0ZWLn4r1ybhUxuYwzAg4hjroeMZHUT_omLa4GwahRBfrEzlG8RKLWMhrKiOP/pub?gid=304610077&single=true&output=csv';
  const POINTS_CSV_URL =
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ60bXKqgYfT7N7M5Le0ZWLn4r1ybhUxuYwzAg4hjroeMZHUT_omLa4GwahRBfrEzlG8RKLWMhrKiOP/pub?gid=0&single=true&output=csv';
  /* ============================= */

  const map = L.map('map').setView([55.75, 37.62], 10);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'© OpenStreetMap' }).addTo(map);

  const badge = document.getElementById('status-badge');
  const setBadge = (t, bad=false)=>{ badge.textContent=t; badge.style.background = bad ? '#d33' : '#0b6'; };

  const groupsByOperator = new Map();
  const markers = [];
  let allOperators = [];

  const HDR = {
    id:['id','код'], name:['name','название'],
    lat:['lat','latitude','широта'], lng:['lng','lon','long','долгота'],
    operator:['operator','оператор'], class:['class','класс'], freq:['freq','частота'], sales:['sales','продажи']
  };
  const toNum = v => (typeof v==='number')?v : (typeof v==='string')? Number(v.replace(',', '.').trim()) : NaN;

  function loadCSV(url){
    return new Promise((resolve,reject)=>{
      const u = url + (url.includes('?')?'&':'?') + 't=' + Date.now(); // no-cache
      Papa.parse(u,{download:true,header:true,skipEmptyLines:true,
        complete:r=>resolve(r.data), error:e=>reject(e)});
    });
  }
  const pick = (row,keys)=>{
    for(const k of keys){
      if (row.hasOwnProperty(k)) return row[k];
      const low=k.toLowerCase();
      for(const rk of Object.keys(row)){ if(rk.toLowerCase()===low) return row[rk]; }
    }
    return '';
  };

  async function loadData(){
    const [opsRows, pointRows] = await Promise.all([loadCSV(OPS_CSV_URL), loadCSV(POINTS_CSV_URL)]);
    console.log('operators CSV sample:', opsRows[0]);
    console.log('points CSV sample:', pointRows[0]);

    if (!Array.isArray(opsRows) || !opsRows.length) throw new Error('operators.csv пуст');
    if (!Array.isArray(pointRows) || !pointRows.length) throw new Error('points.csv пуст');

    const opKey = Object.keys(opsRows[0]||{}).find(k=>/^(operator|оператор)$/i.test(k)) || 'operator';
    const operators = Array.from(new Set(
      opsRows.map(r => String(r?.[opKey] ?? '').trim()).filter(Boolean)
    )).sort((a,b)=>a.localeCompare(b,'ru'));

    const points = pointRows.map(r=>({
      id:String(pick(r,HDR.id)||'').trim(),
      name:String(pick(r,HDR.name)||'').trim(),
      lat:toNum(pick(r,HDR.lat)), lng:toNum(pick(r,HDR.lng)),
      operator:String(pick(r,HDR.operator)||'').trim(),
      class:String(pick(r,HDR.class)||'').trim(),
      freq:String(pick(r,HDR.freq)||'').trim(),
      sales:String(pick(r,HDR.sales)||'').trim()
    })).filter(p=>isFinite(p.lat)&&isFinite(p.lng));

    return {operators, points};
  }

  function updateCounts(){
    let visPts=0, totalPts=markers.length;
    for(const [,g] of groupsByOperator){ if(!g._visible) continue; let n=0; g.eachLayer(()=>n++); visPts+=n; }
    document.getElementById('counts').textContent =
      `• операторов: ${allOperators.length} • точек: ${visPts}/${totalPts}`;
  }

  function buildPanel(){
    const wrap = document.getElementById('ops');
    wrap.innerHTML='';
    const sorted = allOperators.slice().sort((a,b)=>a.localeCompare(b,'ru'));
    for(const op of sorted){
      const g = groupsByOperator.get(op);
      let n=0; g && g.eachLayer(()=>n++);
      const row=document.createElement('div'); row.className='op-row'; row.dataset.op=op;
      const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=!!(g&&g._visible);
      cb.onchange=()=>{ if(!g) return; g._visible=cb.checked; cb.checked?g.addTo(map):map.removeLayer(g); updateCounts(); };
      const lbl=document.createElement('label'); lbl.textContent=op||'(без оператора)';
      const num=document.createElement('span'); num.className='small num'; num.textContent = cb.checked?n:0;
      row.append(cb,lbl,num); wrap.appendChild(row);
    }
  }

  function buildLayers({operators,points}){
    allOperators = operators.slice();
    for(const name of allOperators){
      if(!groupsByOperator.has(name)){ const g=L.layerGroup().addTo(map); g._visible=true; groupsByOperator.set(name,g); }
    }
    const bounds=[];
    for(const p of points){
      const m=L.circleMarker([p.lat,p.lng],{radius:6,weight:1,color:'#2d6cdf',fillColor:'#2d6cdf',fillOpacity:.85})
              .bindPopup(`<b>${p.name||''}</b><br>${p.operator||''}`);
      const g = groupsByOperator.get(p.operator) || groupsByOperator.get('') || (()=>{const t=L.layerGroup().addTo(map); t._visible=true; groupsByOperator.set('',t); return t;})();
      m.addTo(g); markers.push({marker:m,operator:p.operator||''}); bounds.push([p.lat,p.lng]);
    }
    if(bounds.length) map.fitBounds(bounds,{padding:[20,20]});
    updateCounts(); buildPanel();
  }

  // UI
  document.getElementById('opener').onclick=()=>document.getElementById('panel').classList.toggle('show');
  document.getElementById('selectAll').onclick=()=>document.querySelectorAll('#ops .op-row input[type=checkbox]').forEach(cb=>{ if(!cb.checked) cb.click(); });
  document.getElementById('clearAll').onclick=()=>document.querySelectorAll('#ops .op-row input[type=checkbox]').forEach(cb=>{ if(cb.checked) cb.click(); });
  document.getElementById('fitBounds').onclick=()=>{ const b=[]; for(const [,g] of groupsByOperator){ if(!g._visible) continue; g.eachLayer(l=>{ if(l.getLatLng) b.push(l.getLatLng()); }); } if(b.length) map.fitBounds(L.latLngBounds(b),{padding:[20,20]}); };
  document.getElementById('search').oninput=e=>{ const q=e.target.value.trim().toLowerCase(); document.querySelectorAll('#ops .op-row').forEach(row=>{ row.style.display = row.querySelector('label').textContent.toLowerCase().includes(q)?'':''; }); };

  // Старт с диагностикой
  (async()=>{
    try{
      setBadge('Загружаю CSV…');
      const data = await loadData();
      setBadge(`Прочитано: операторов ${data.operators.length}, строк точек ${data.points.length}`);
      if(!data.points.length) setBadge('Точек 0 — проверь lat/lng и заголовки', true);
      buildLayers(data);
    }catch(err){
      console.error(err);
      setBadge('Ошибка загрузки CSV (детали в консоли)', true);
      alert('Не удалось загрузить данные. Проверь CSV-ссылки и заголовки колонок.');
    }
  })();
</script>
