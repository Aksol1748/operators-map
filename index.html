<html><head>
<meta content="text/html; charset=utf-8" http-equiv="content-type"/>
<script>
            L_NO_TOUCH = false;
            L_DISABLE_3D = false;
        </script>
<style>html, body {width: 100%;height: 100%;margin: 0;padding: 0;}</style>
<style>#map {position:absolute;top:0;bottom:0;right:0;left:0;}</style>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
<link href="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet"/>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css" rel="stylesheet"/>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css" rel="stylesheet"/>
<meta content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<style>
                #map_07240632b07852a755665ada692280cf {
                    position: relative;
                    width: 100.0%;
                    height: 100.0%;
                    left: 0.0%;
                    top: 0.0%;
                }
            </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="">
<div class="folium-map" id="map_07240632b07852a755665ada692280cf" style="outline: none;"></div>
<!-- === REBUILD v34: мобильная панель, полноэкранный список, выделение/переназначение, anti-vanish === -->
<style>
/* Floating toggle */
#toggleOp{position:fixed;top:12px;right:12px;z-index:1100;width:44px;height:44px;border:0;border-radius:50%;background:#2d6cdf;color:#fff;font-size:20px;line-height:44px;text-align:center;box-shadow:0 4px 10px rgba(0,0,0,.25)}
@media (min-width:1024px){#toggleOp{width:auto;height:36px;border-radius:18px;padding:6px 12px;font-size:14px;line-height:24px}#toggleOp::after{content:' Операторы'}}
/* Wrapper panel */
#opControlWrapper{position:fixed;top:56px;right:8px;bottom:8px;max-width:96vw;display:none;flex-direction:column;overflow:hidden;background:rgba(255,255,255,.98);color:#111;border:1px solid #ddd;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.25);padding:10px 12px;z-index:1000}
#opControlWrapper,#opControlWrapper *{opacity:1;color:#111}
/* Extras */
#extrasBar{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin:6px 0 2px}
#opSearch{flex:1 1 100%;min-width:0;padding:6px 8px;border:1px solid #bbb;border-radius:6px;font-size:14px}
#quickBtns{display:flex;gap:6px;flex:1 1 100%}
#quickBtns button,#bulkBtns button,#bulkBtnsSheet button,#editBar button,#moveBar button,#opRefreshBar button,#allExportBar button{font-size:12px;padding:6px 10px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer}
.mini{font-size:12px}
#sizeSlider{width:100%}
/* Scroll list */
#opScroll{flex:1 1 auto;overflow-y:auto;-webkit-overflow-scrolling:touch;touch-action:pan-y;padding-bottom:12px}
#opScroll .leaflet-control-layers-overlays label{display:block;padding:6px 0}
/* Fullscreen sheet */
#opSheet{position:fixed;inset:0;z-index:2000;display:none;background:#fff;color:#111;overflow:auto;-webkit-overflow-scrolling:touch}
#opSheet .bar{position:sticky;top:0;display:flex;gap:8px;align-items:center;justify-content:space-between;background:#fff;padding:10px 12px;border-bottom:1px solid #e6e6e6}
#opSheet .title{font-weight:600}
#opSheetContent{padding:8px 12px 16px}
/* Selection visuals */
.leaflet-interactive.marker-selected-outline{outline:2px solid #1976d2;outline-offset:2px}
.marker-flash{animation:flashAnim 1s ease-in-out 0s 2}
@keyframes flashAnim{0%{opacity:1}50%{opacity:.2}100%{opacity:1}}
</style>
<script>
(function(){
function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
ready(function(){
  // === Map & control detection
  var Lmap=null; for (var k in window){ try{ if(k.startsWith('map_') && window[k] && typeof window[k].eachLayer==='function'){ Lmap=window[k]; break; } }catch(e){} }
  if(!Lmap) return;
  var L = window.L;
  function N(s){ return String(s||'').replace(/\\u00A0/g,' ').replace(/\\s+/g,' ').toLowerCase().trim(); }

  // === Ensure toggle & wrapper exist
  if(!document.getElementById('toggleOp')){ var b=document.createElement('button'); b.id='toggleOp'; b.textContent='≡'; document.body.appendChild(b); }
  if(!document.getElementById('opControlWrapper')){ var w=document.createElement('div'); w.id='opControlWrapper'; document.body.appendChild(w); }
  var btn=document.getElementById('toggleOp'), wrap=document.getElementById('opControlWrapper');

  // Move Leaflet control inside wrapper
  var lc = document.querySelector('.leaflet-control-layers');
  if (lc && lc.parentNode !== wrap){ wrap.appendChild(lc); }

  // Build list container & extras
  var list = lc ? lc.querySelector('.leaflet-control-layers-list') : null;
  if(!list){ list=document.createElement('div'); list.className='leaflet-control-layers-list'; lc && lc.appendChild(list); }
  var overlays = lc ? (lc.querySelector('.leaflet-control-layers-overlays') || list) : list;

  // Extras bar
  var extras = document.createElement('div'); extras.id='extrasBar';
  extras.innerHTML = '<input id="opSearch" type="search" placeholder="Поиск по операторам...">'
    + '<div id="quickBtns"><button id="resetView">Сброс</button><button id="locateMe">Моё местоположение</button></div>'
    + '<div class="mini">Размер точек: <input id="sizeSlider" type="range" min="2" max="24" value="8" step="1"></div>'
    + '<label class="mini"><input id="soloMode" type="checkbox"> Соло-режим</label>'
    + '<label class="mini"><input id="viewportOnly" type="checkbox"> Только в кадре</label>'
    + '<button id="openFullList">Открыть список на весь экран</button>';
  list.parentNode.insertBefore(extras, list);

  // Bulk buttons
  var bulk = document.createElement('div'); bulk.id='bulkBtns';
  bulk.innerHTML = '<button id="bulkAll">Выделить всех</button><button id="bulkNone">Снять всех</button>';
  extras.parentNode.insertBefore(bulk, extras.nextSibling);

  // Dedicated scroll container
  var sc = document.createElement('div'); sc.id='opScroll'; list.insertBefore(sc, overlays); sc.appendChild(overlays);

  // Fullscreen sheet
  var openFS = document.getElementById('openFullList');
  var sheet = document.createElement('div'); sheet.id='opSheet'; sheet.innerHTML='<div class="bar"><div class="title">Операторы</div><div><button id="sheetClose">Закрыть</button></div></div><div id="opSheetContent"></div>';
  document.body.appendChild(sheet);
  var cont = sheet.querySelector('#opSheetContent'); var closeBtn = sheet.querySelector('#sheetClose');
  var homeParent = overlays.parentNode, homeNext = overlays.nextSibling;
  openFS.addEventListener('click', function(e){ e.preventDefault(); cont.appendChild(overlays); sheet.style.display='block'; document.body.style.overflow='hidden'; });
  closeBtn.addEventListener('click', function(e){ e.preventDefault(); if (homeNext) homeParent.insertBefore(overlays, homeNext); else homeParent.appendChild(overlays); sheet.style.display='none'; document.body.style.overflow=''; });

  // Toggle panel
  function show(){ wrap.style.setProperty('display','flex','important'); resize(); }
  function hide(){ wrap.style.setProperty('display','none','important'); }
  function vis(){ return window.getComputedStyle(wrap).display !== 'none'; }
  if ((window.innerWidth <= 820) || (window.innerHeight <= 600)) hide(); else show();
  var nb=btn.cloneNode(true); btn.parentNode.replaceChild(nb,btn);
  nb.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); vis()?hide():show(); });
  document.addEventListener('click', function(e){ if(!vis()) return; if (wrap.contains(e.target) || nb.contains(e.target)) return; hide(); });

  // Search filter
  var search = document.getElementById('opSearch');
  function filterList(){
    var q=(search.value||'').toLowerCase();
    sc.querySelectorAll('label').forEach(function(l){
      var t=(l.textContent||'').toLowerCase();
      if (/оператор/i.test(t) || /без оператора/i.test(t)){
        l.style.display = q ? (t.indexOf(q)!==-1 ? '' : 'none') : '';
      }
    });
  }
  search.addEventListener('input', filterList);

  // Select all / none
  function opBoxes(){ return sc.querySelectorAll('.leaflet-control-layers-overlays input[type="checkbox"]'); }
  document.getElementById('bulkAll').addEventListener('click', function(e){ e.preventDefault(); opBoxes().forEach(function(cb){ if(!cb.checked) cb.click(); }); });
  document.getElementById('bulkNone').addEventListener('click', function(e){ e.preventDefault(); opBoxes().forEach(function(cb){ if(cb.checked) cb.click(); }); });

  // Size slider
  function eachLayerDeep(ly, fn){ try{ if (ly && typeof ly.eachLayer==='function'){ ly.eachLayer(function(ch){ eachLayerDeep(ch, fn); }); } else { fn(ly); } }catch(e){} }
  var sld=document.getElementById('sizeSlider');
  function setRadiusAll(r){ Lmap.eachLayer(function(ly){ eachLayerDeep(ly, function(x){ try{ if (x && x.setRadius && x.getLatLng){ x.setRadius(r); } }catch(e){} }); }); }
  setRadiusAll(parseInt(sld.value,10)||8); sld.addEventListener('input', function(){ setRadiusAll(parseInt(sld.value,10)||8); });

  // Reset / locate
  var startCenter=Lmap.getCenter(), startZoom=Lmap.getZoom();
  document.getElementById('resetView').addEventListener('click', function(e){ e.preventDefault(); Lmap.setView(startCenter,startZoom); });
  document.getElementById('locateMe').addEventListener('click', function(e){ e.preventDefault(); if(!navigator.geolocation) return alert('Геолокация недоступна'); navigator.geolocation.getCurrentPosition(function(p){ var lat=p.coords.latitude, lon=p.coords.longitude; Lmap.flyTo([lat,lon], 13); L.circleMarker([lat,lon], {radius:8, color:'#1976d2', fillColor:'#1976d2', fillOpacity:0.8}).addTo(Lmap).bindPopup('Вы здесь'); }, function(){ alert('Не удалось получить геолокацию'); }); });

  // Viewport only
  var vOnly=document.getElementById('viewportOnly');
  function setVis(ly, v){ try{ if (ly.setStyle){ ly.setStyle({opacity:v?1:0, fillOpacity:v?0.8:0}); } if (ly.setOpacity){ ly.setOpacity(v?1:0); } }catch(e){} }
  function refreshView(){ if (!vOnly.checked){ Lmap.eachLayer(function(ly){ eachLayerDeep(ly, function(x){ setVis(x, true); }); }); return; } var b=Lmap.getBounds(); Lmap.eachLayer(function(ly){ eachLayerDeep(ly, function(x){ try{ if (x && x.getLatLng){ setVis(x, b.contains(x.getLatLng())); } }catch(e){} }); }); }
  vOnly.addEventListener('change', refreshView); Lmap.on('moveend zoomend layeradd layerremove', refreshView);

  // === Selection (tap to select)
  window.__sel__ = window.__sel__ || { set:new Set() };
  function isMarker(x){ return x && typeof x.getLatLng==='function' && (x._path || x._icon); }
  function markerKey(m){ return m && m._leaflet_id ? m._leaflet_id : (Math.random()+':'+Date.now()); }
  function mark(m,on){ try{ if (m.setRadius){ if (typeof m.__origRadius==='undefined') m.__origRadius=m.options.radius||8; m.setRadius(on?(m.__origRadius+3):m.__origRadius); } var el=m._path||m._icon; if(el){ if(on) el.classList.add('marker-selected-outline'); else el.classList.remove('marker-selected-outline'); el.style.pointerEvents='auto'; } }catch(e){} }
  function updateCounter(){ var c=document.getElementById('selCount'); if(c) c.textContent = window.__sel__.set.size; }
  function bindToMarker(m){ if (!isMarker(m) || m.__pickBound) return; m.options && (m.options.interactive=true); if (m._path) m._path.style.pointerEvents='auto'; function onPick(ev){ var edit=document.getElementById('editMode'); if (!edit || !edit.checked) return; var key=m._leaflet_id; if (window.__sel__.set.has(key)){ window.__sel__.set.delete(key); mark(m,false); } else { window.__sel__.set.add(key); mark(m,true); } updateCounter(); ev && ev.originalEvent && ev.originalEvent.stopPropagation && ev.originalEvent.stopPropagation(); } m.on('click', onPick); m.on('touchstart', onPick); m.__pickBound=true; }
  function scanAll(){ Lmap.eachLayer(function(ly){ try{ if (isMarker(ly)) bindToMarker(ly); else if (ly && typeof ly.eachLayer==='function'){ ly.eachLayer(function(ch){ if (isMarker(ch)) bindToMarker(ch); }); } }catch(e){} }); }
  scanAll(); Lmap.on('layeradd', function(e){ var ly=e.layer; try{ if (isMarker(ly)) bindToMarker(ly); else if (ly && typeof ly.eachLayer==='function'){ ly.eachLayer(function(ch){ if (isMarker(ch)) bindToMarker(ch); }); } }catch(err){} });

  // === Edit bar (reassign)
  var edit = document.createElement('div'); edit.id='editBar';
  edit.innerHTML = '<label class="mini"><input id="editMode" type="checkbox"> Режим редактирования</label>'
    + '<span class="mini">Выбрано: <span id="selCount" class="count">0</span></span>'
    + '<span class="mini">Новый оператор:</span>'
    + '<select id="targetOperator"></select>'
    + '<button id="assignOp">Назначить</button>'
    + '<button id="clearOp">Без оператора</button>'
    + '<button id="unselectAll">Снять выделение</button>'
    + '<button id="exportChanges">Экспорт изменений</button>';
  extras.parentNode.insertBefore(edit, extras.nextSibling);

  document.getElementById('unselectAll').addEventListener('click', function(e){ e.preventDefault(); window.__sel__.set = new Set(); scanAll(); Lmap.eachLayer(function(ly){ try{ if (isMarker(ly)) mark(ly,false); else if (ly && typeof ly.eachLayer==='function'){ ly.eachLayer(function(ch){ if (isMarker(ch)) mark(ch,false); }); } }catch(e){} }); updateCounter(); });

  // === Move mode
  var move = document.createElement('div'); move.id='moveBar';
  move.innerHTML = '<label class="mini"><input id="moveMode" type="checkbox"> Перемещение точек</label>'
    + '<span id="moveHint" class="mini" style="opacity:.85">Нажми на точку → затем ткни по карте куда перенести.</span>'
    + '<button id="undoMove">Отменить последнее</button>'
    + '<button id="exportMoves">Экспорт перемещений</button>';
  edit.parentNode.insertBefore(move, edit.nextSibling);
  var moveMode=document.getElementById('moveMode'), moveHint=document.getElementById('moveHint'), undoBtn=document.getElementById('undoMove'), expBtn=document.getElementById('exportMoves');
  var moving=null, lastMove=null, moves=[];
  function mLabel(m){ try{ var p=m.getPopup&&m.getPopup(); var c=p?p.getContent():''; if(typeof c==='string') return c.replace(/<[^>]+>/g,' ').trim(); if(c&&c.innerText) return c.innerText.trim(); }catch(e){} return ''; }
  function startMove(m){ moving=m; try{ if (m.setRadius){ if (typeof m.__origRadius==='undefined') m.__origRadius=m.options.radius||8; m.setRadius(m.__origRadius+3);} var el=m._path||m._icon; if(el) el.style.outline='2px dashed #1976d2'; }catch(e){} moveHint.textContent='Выбрана точка. Ткни по карте, куда перенести…'; }
  function endMoveVis(m){ try{ if (m.setRadius && typeof m.__origRadius!=='undefined') m.setRadius(m.__origRadius); var el=m._path||m._icon; if(el) el.style.outline=''; }catch(e){} moveHint.textContent='Нажми на точку → затем ткни по карте куда перенести.'; }
  function attachMove(){ Lmap.eachLayer(function(g){ try{ g.eachLayer && g.eachLayer(function(m){ if (!isMarker(m) || m.__moveBound) return; m.on('click', function(ev){ if (!moveMode.checked) return; ev.originalEvent && ev.originalEvent.stopPropagation && ev.originalEvent.stopPropagation(); startMove(m); }); m.__moveBound=true; }); }catch(e){} }); }
  attachMove(); Lmap.on('layeradd', attachMove);
  function onMapClick(e){ if (!moving) return; var from=moving.getLatLng(); moving.setLatLng(e.latlng); var to=e.latlng; moves.push({location:mLabel(moving), from_lat:from.lat, from_lon:from.lng, to_lat:to.lat, to_lon:to.lng, ts:new Date().toISOString()}); lastMove={marker:moving, from:from}; endMoveVis(moving); moving=null; }
  moveMode.addEventListener('change', function(){ if (moveMode.checked){ moveHint.style.opacity='1'; Lmap.on('click', onMapClick); } else { moveHint.style.opacity='.7'; Lmap.off('click', onMapClick); if (moving){ endMoveVis(moving); moving=null; } } });
  undoBtn.addEventListener('click', function(e){ e.preventDefault(); if(!lastMove) return alert('Нет перемещений для отмены.'); try{ lastMove.marker.setLatLng(lastMove.from); lastMove=null; }catch(err){} });
  expBtn.addEventListener('click', function(e){ e.preventDefault(); if(!moves.length) return alert('Перемещений пока нет.'); var header='location,from_lat,from_lon,to_lat,to_lon,timestamp'; var rows=moves.map(r=>['"'+String(r.location).replace(/"/g,'""')+'"',r.from_lat,r.from_lon,r.to_lat,r.to_lon,'"'+r.ts+'"'].join(',')); var csv=header+'\\n'+rows.join('\\n'); var url=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); var a=document.createElement('a'); a.href=url; a.download='point_moves.csv'; document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(url);a.remove();},500); });

  // === Operator indexing via overlay toggles
  window.__opIndex = window.__opIndex || {};
  function mapOverlays(){
    var labels=[].slice.call(document.querySelectorAll('.leaflet-control-layers-overlays label'));
    labels.forEach(function(l){
      var name=(l.textContent||'').trim(), key=N(name);
      var input=l.querySelector('input[type="checkbox"]');
      if(!name||!input||window.__opIndex[key]) return;
      var got=null;
      function h(e){ if(!got){ got=e.layer; Lmap.off('layeradd',h); Lmap.off('layerremove',h); window.__opIndex[key]=got; } }
      Lmap.on('layeradd',h); Lmap.on('layerremove',h);
      input.click(); input.click();
    });
  }
  setTimeout(mapOverlays,300);

  function ensureOverlayVisibleByName(name){
    var key=N(name);
    var labs=[].slice.call(document.querySelectorAll('.leaflet-control-layers-overlays label'));
    for (var i=0;i<labs.length;i++){ var lab=labs[i]; var txt=N(lab.textContent||''); if (txt===key){ var cb=lab.querySelector('input[type="checkbox"]'); if (cb && !cb.checked) cb.click(); break; } }
  }
  function ensureTargetLayer(displayName){
    var key=N(displayName);
    var layer=window.__opIndex[key];
    if (!layer && key===N('без оператора')){
      layer=L.featureGroup().addTo(Lmap);
      for (var k in window){ var v=window[k]; if (v && v._layers && v._map===Lmap && typeof v.addOverlay==='function'){ v.addOverlay(layer,'Без оператора'); break; } }
      window.__opIndex[key]=layer;
    }
    if (layer){
      try{
        ensureOverlayVisibleByName(displayName);
        if (!Lmap.hasLayer(layer) && layer.addTo) layer.addTo(Lmap);
      }catch(e){}
    }
    return layer;
  }
  function selectedIds(){ return (window.__sel__ && window.__sel__.set) ? Array.from(window.__sel__.set) : []; }
  function forEachSelected(fn){
    var ids=selectedIds(); if(!ids.length) return 0; var cnt=0;
    Lmap.eachLayer(function(ly){
      try{
        if (ly && ly._leaflet_id && ids.indexOf(ly._leaflet_id)!==-1){ cnt++; fn(ly); }
        else if (ly && typeof ly.eachLayer==='function'){ ly.eachLayer(function(ch){ if (ch && ch._leaflet_id && ids.indexOf(ch._leaflet_id)!==-1){ cnt++; fn(ch); } }); }
      }catch(e){}
    });
    return cnt;
  }
  function currentGroupOf(m){ var found=null; Lmap.eachLayer(function(ly){ try{ if (ly && typeof ly.hasLayer==='function' && ly.hasLayer(m)) found=ly; }catch(e){} }); return found; }
  function tryPutInto(layer, m){
    var ok=false;
    try{ layer.addLayer && layer.addLayer(m); ok = layer.hasLayer ? layer.hasLayer(m) : true; }catch(e){ ok=false; }
    if (!ok){ try{ m.addTo && m.addTo(layer); ok = layer.hasLayer ? layer.hasLayer(m) : true; }catch(e){} }
    return ok;
  }

  // Combined export (audit)
  window.__audit__ = window.__audit__ || { moves: [], reassigns: [] };
  // wrap setLatLng to log moves
  function wrapSetLatLng(proto){
    if (!proto || !proto.setLatLng || proto.__wrappedSetLatLng) return;
    var original=proto.setLatLng;
    proto.setLatLng=function(latlng){
      var prev=this.__lastLatLng;
      var next = latlng && (latlng.lat !== undefined ? latlng : L.latLng(latlng));
      var res = original.call(this, latlng);
      try{
        this.__lastLatLng = this.getLatLng();
        if (prev && next && (prev.lat!==next.lat || prev.lng!==next.lng)){
          window.__audit__.moves.push({ type:'move', location:mLabel(this), lat_from:prev.lat, lon_from:prev.lng, lat_to:next.lat, lon_to:next.lng, timestamp:new Date().toISOString() });
        }
      }catch(e){}
      return res;
    };
    proto.__wrappedSetLatLng=true;
  }
  wrapSetLatLng(L.CircleMarker && L.CircleMarker.prototype);
  wrapSetLatLng(L.Marker && L.Marker.prototype);
  setTimeout(function(){ Lmap.eachLayer(function(ly){ try{ if (isMarker(ly)) ly.__lastLatLng = ly.getLatLng(); else if (ly && typeof ly.eachLayer==='function'){ ly.eachLayer(function(m){ if (isMarker(m)) m.__lastLatLng = m.getLatLng(); }); } }catch(e){} }); }, 200);

  // Safe assign
  window.__lastReassign=null; window.__lastAssigned=[];
  function safeAssign(toDisplayName){
    var target=ensureTargetLayer(toDisplayName);
    if (!target){ alert('Не найден слой оператора: '+toDisplayName); return; }
    var moved=0, failed=0, bounds=null, changes=[]; window.__lastAssigned=[];
    forEachSelected(function(m){
      var from=currentGroupOf(m);
      if (!from || from===target) return;
      Lmap.eachLayer(function(ly){ try{ if (ly && typeof ly.removeLayer==='function' && ly.hasLayer && ly.hasLayer(m)) ly.removeLayer(m); }catch(e){} });
      var ok = tryPutInto(target, m);
      if (ok){
        moved++; window.__lastAssigned.push(m); changes.push({m:m,from:from,to:target});
        window.__audit__.reassigns.push({ type:'reassign', location:mLabel(m), from_operator:'', to_operator:toDisplayName, timestamp:new Date().toISOString() });
        mark(m,false);
        (bounds ||= L.latLngBounds()).extend(m.getLatLng());
        window.__sel__ && window.__sel__.set && window.__sel__.set.delete(m._leaflet_id);
      }else{
if(!window.__opIndex){window.__opIndex={}}; if(!window.__opIndex[key]) window.__opIndex[key]=group;

        try{ from && from.addLayer && from.addLayer(m); }catch(e){}
        failed++;
      }
    });
    document.getElementById('selCount') && (document.getElementById('selCount').textContent = (window.__sel__ && window.__sel__.set ? window.__sel__.set.size : 0));
    window.__lastReassign = changes;
    if (failed){ alert('Часть точек не удалось назначить — вернул назад. Проверьте, включён ли слой в списке ниже.'); }
    if (!moved && !failed){ alert('Нет выбранных точек для переназначения.'); return; }
    try{
      if (bounds && bounds.isValid()){
        bounds.getNorthEast().equals(bounds.getSouthWest()) ? Lmap.flyTo(bounds.getNorthEast(), Math.max(Lmap.getZoom(), 15)) : Lmap.fitBounds(bounds, {padding:[40,40]});
      }
    }catch(e){}
  }

  function rewire(id, fn){ var b=document.getElementById(id); if(!b) return; var c=b.cloneNode(true); b.parentNode.replaceChild(c,b); c.addEventListener('click', function(e){ e.preventDefault(); fn(); }); }
  rewire('assignOp', function(){ var sel=document.getElementById('targetOperator'); var name = sel && sel.options && sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].textContent : (sel && sel.value); if (!name) return alert('Не выбран оператор.'); safeAssign(name); });
  rewire('clearOp', function(){ safeAssign('Без оператора'); });
  // Undo assign + Show last
  (function(){
    var a=document.getElementById('assignOp'); if(!a) return;
    if(!document.getElementById('undoAssign')){ var u=document.createElement('button'); u.id='undoAssign'; u.textContent='Отменить назначение'; a.parentNode.insertBefore(u, a.nextSibling); u.addEventListener('click', function(e){ e.preventDefault(); var list=window.__lastReassign||[]; if (!list.length) return alert('Нет назначений для отмены.'); list.forEach(function(rec){ try{ rec.to && rec.to.removeLayer && rec.to.removeLayer(rec.m); rec.from && rec.from.addLayer && rec.from.addLayer(rec.m); }catch(e){} }); window.__lastReassign=null; }); }
    if(!document.getElementById('showLastAssigned')){ var s=document.createElement('button'); s.id='showLastAssigned'; s.textContent='Показать последние'; a.parentNode.insertBefore(s, a.nextSibling); s.addEventListener('click', function(e){ e.preventDefault(); var list=window.__lastAssigned||[]; if (!list.length) return alert('Нет недавних назначений.'); var b=L.latLngBounds(); list.forEach(function(m){ try{ b.extend(m.getLatLng()); (m._path||m._icon)&&((m._path||m._icon).classList.add('marker-flash')); setTimeout(function(){ (m._path||m._icon)&&((m._path||m._icon).classList.remove('marker-flash')); },1600); }catch(e){} }); if (b.isValid()){ b.getNorthEast().equals(b.getSouthWest()) ? Lmap.flyTo(b.getNorthEast(), Math.max(Lmap.getZoom(),15)) : Lmap.fitBounds(b,{padding:[40,40]}); } }); }
  })();

  // Refill operator select from overlays
  function refillSelect(){
    var sel=document.getElementById('targetOperator'); if(!sel) return;
    while (sel.firstChild) sel.removeChild(sel.firstChild);
    var labels=[].slice.call(document.querySelectorAll('.leaflet-control-layers-overlays label'));
    labels.forEach(function(l){ var name=(l.textContent||'').trim(); if(/оператор/i.test(name)||/без оператора/i.test(name)){ var o=document.createElement('option'); o.value=name; o.textContent=name; sel.appendChild(o); } });
    if (!sel.options.length){ var o=document.createElement('option'); o.value='Без оператора'; o.textContent='Без оператора'; sel.appendChild(o); }
  }
  refillSelect();
  // Refresh button for ops
  var opRef = document.createElement('div'); opRef.id='opRefreshBar'; opRef.innerHTML='<button id="refreshOps">Обновить список операторов</button>'; edit.parentNode.insertBefore(opRef, edit);
  var rb = opRef.querySelector('#refreshOps'); rb.addEventListener('click', function(e){ e.preventDefault(); window.__opIndex={}; setTimeout(mapOverlays, 50); setTimeout(refillSelect, 200); alert('Список операторов обновлён.'); });

  // Combined export
  var allBar = document.createElement('div'); allBar.id='allExportBar'; allBar.innerHTML='<button id="exportAll">Экспорт всех изменений (CSV)</button>'; move.parentNode.insertBefore(allBar, move.nextSibling);
  allBar.querySelector('#exportAll').addEventListener('click', function(e){
    e.preventDefault();
    var head=['type','location','from_operator','to_operator','lat_from','lon_from','lat_to','lon_to','timestamp'];
    var rows=[];
    (window.__audit__.reassigns||[]).forEach(function(r){ rows.push(['reassign','"'+String(r.location||'').replace(/"/g,'""')+'"','', '"'+String(r.to_operator||'').replace(/"/g,'""')+'"','','','','','"'+r.timestamp+'"'].join(',')); });
    (window.__audit__.moves||[]).forEach(function(r){ rows.push(['move','"'+String(r.location||'').replace(/"/g,'""')+'"','','',r.lat_from,r.lon_from,r.lat_to,r.lon_to,'"'+r.timestamp+'"'].join(',')); });
    if (!rows.length) return alert('Изменений пока нет.');
    var csv=head.join(',')+'\\n'+rows.join('\\n');
    var url=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); var a=document.createElement('a'); a.href=url; a.download='all_changes.csv'; document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(url); a.remove();},500);
  });

  // Resize list height
  function resize(){ var top = sc.getBoundingClientRect().top; var avail = window.innerHeight - top - 8; sc.style.height = Math.max(180, avail)+'px'; sc.style.maxHeight = Math.max(180, avail)+'px'; }
  window.addEventListener('resize', resize); window.addEventListener('orientationchange', resize); setTimeout(resize,50); setTimeout(resize,250); setTimeout(resize,800);
});
})();
</script>
<!-- === v35: сверхнадёжное назначение — отключаем фильтры, включаем слой, подсвечиваем точку, добавляем фолбэк === -->
<script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  ready(function(){
    var Lmap=null; for (var k in window){ try{ if(k.startsWith('map_') && window[k] && typeof window[k].eachLayer==='function'){ Lmap=window[k]; break; } }catch(e){} }
    if(!Lmap) return;
    var L=window.L;
    function N(s){ return String(s||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').toLowerCase().trim(); }

    // helper: disable filters temporarily
    function disableFiltersTemporarily(){
      try{
        var solo = document.getElementById('soloMode');
        var vOnly = document.getElementById('viewportOnly');
        var prev = { solo: solo && solo.checked, vOnly: vOnly && vOnly.checked };
        if (solo && solo.checked){ solo.checked = false; solo.dispatchEvent(new Event('change')); }
        if (vOnly && vOnly.checked){ vOnly.checked = false; vOnly.dispatchEvent(new Event('change')); }
        return prev;
      }catch(e){ return {solo:false, vOnly:false}; }
    }
    function restoreFilters(prev){
      try{
        var solo = document.getElementById('soloMode');
        var vOnly = document.getElementById('viewportOnly');
        if (prev && solo && prev.solo){ solo.checked = true; solo.dispatchEvent(new Event('change')); }
        if (prev && vOnly && prev.vOnly){ vOnly.checked = true; vOnly.dispatchEvent(new Event('change')); }
      }catch(e){}
    }

    function ensureOverlayVisibleByName(name){
      var key=N(name);
      var labs=[].slice.call(document.querySelectorAll('.leaflet-control-layers-overlays label'));
      for (var i=0;i<labs.length;i++){
        var lab=labs[i];
        var txt=N(lab.textContent||'');
        if (txt===key){
          var cb=lab.querySelector('input[type="checkbox"]');
          if (cb && !cb.checked){ cb.click(); }
          break;
        }
      }
    }
    window.__opIndex = window.__opIndex || {};

    // override assignOp handler with ultra-safe version
    (function(){
      var b=document.getElementById('assignOp'); if(!b) return;
      var c=b.cloneNode(true); b.parentNode.replaceChild(c,b);
      c.addEventListener('click', function(e){
        e.preventDefault();
        var sel=document.getElementById('targetOperator');
        var displayName = sel && sel.options && sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].textContent : (sel && sel.value);
        if (!displayName) return alert('Не выбран оператор.');

        // 1) disable filters so nothing скрывается
        var prevFilters = disableFiltersTemporarily();

        // 2) ensure layer object
        var key = N(displayName);
        var target = window.__opIndex[key];
        if (!target && key===N('без оператора')){
          target = L.featureGroup().addTo(Lmap);
          for (var k in window){ var v=window[k]; if (v && v._layers && v._map===Lmap && typeof v.addOverlay==='function'){ v.addOverlay(target, 'Без оператора'); break; } }
          window.__opIndex[key]=target;
        }
        // if still no layer — try to map via overlay toggle trick (click checkbox off/on to capture layer)
        if (!target){
          var labels=[].slice.call(document.querySelectorAll('.leaflet-control-layers-overlays label'));
          for (var i=0;i<labels.length;i++){
            var lab=labels[i]; var name=(lab.textContent||'').trim();
            if (N(name)===key){
              var input=lab.querySelector('input[type="checkbox"]');
              if (input){
                var got=null;
                function h(evv){ if(!got){ got=evv.layer; Lmap.off('layeradd',h); Lmap.off('layerremove',h); window.__opIndex[key]=got; } }
                Lmap.on('layeradd',h); Lmap.on('layerremove',h);
                input.click(); input.click();
                target = window.__opIndex[key];
              }
              break;
            }
          }
        }
        if (!target) { restoreFilters(prevFilters); return alert('Не найден слой оператора: '+displayName); }

        // 3) ensure visibility
        ensureOverlayVisibleByName(displayName);
        if (!Lmap.hasLayer(target) && target.addTo) target.addTo(Lmap);

        // 4) move selected
        var ids = (window.__sel__ && window.__sel__.set) ? Array.from(window.__sel__.set) : [];
        if (!ids.length){ restoreFilters(prevFilters); return alert('Нет выбранных точек.'); }

        var moved=0, failed=0, bounds=L.latLngBounds(), flashes=[];
        function isMarker(x){ return x && typeof x.getLatLng==='function' && (x._path || x._icon); }
        function addMarkerSafe(group, m){
          try{
            group.addLayer && group.addLayer(m);
            if (group.hasLayer && group.hasLayer(m)) return true;
          }catch(e){}
          try{
            m.addTo && m.addTo(group);
            if (group.hasLayer && group.hasLayer(m)) return true;
          }catch(e){}
          // fallback: clone a visual marker at same position (не портим данные, только отображение)
          try{
            var ll=m.getLatLng();
            var cm = L.circleMarker(ll, Object.assign({}, m.options || {}, {radius: (m.options && m.options.radius)||8}));
            cm.bindPopup && m.getPopup && cm.bindPopup(m.getPopup().getContent());
            group.addLayer(cm);
            if (group.hasLayer && group.hasLayer(cm)) { return cm; }
          }catch(e){}
          return false;
        }

        Lmap.eachLayer(function(ly){
          try{
            if (isMarker(ly) && ids.indexOf(ly._leaflet_id)!==-1){
              // remove from any group
              Lmap.eachLayer(function(g){ try{ if (g && g.hasLayer && g.hasLayer(ly) && g.removeLayer) g.removeLayer(ly); }catch(e){} });
              var res = addMarkerSafe(target, ly);
              if (res){
                moved++;
                var showMarker = res === true ? ly : res; // clone or original
                flashes.push(showMarker);
                bounds.extend(showMarker.getLatLng());
                var el = (showMarker._path || showMarker._icon); if (el){ el.classList.add('marker-flash'); setTimeout(function(){ el.classList.remove('marker-flash'); }, 1400); }
              } else {
                failed++;
              }
            } else if (ly && typeof ly.eachLayer==='function'){
              ly.eachLayer(function(ch){
                try{
                  if (isMarker(ch) && ids.indexOf(ch._leaflet_id)!==-1){
                    // аналогично для вложенных
                    Lmap.eachLayer(function(g){ try{ if (g && g.hasLayer && g.hasLayer(ch) && g.removeLayer) g.removeLayer(ch); }catch(e){} });
                    var res2 = addMarkerSafe(target, ch);
                    if (res2){
                      moved++;
                      var showMarker2 = res2 === true ? ch : res2;
                      flashes.push(showMarker2);
                      bounds.extend(showMarker2.getLatLng());
                      var el2 = (showMarker2._path || showMarker2._icon); if (el2){ el2.classList.add('marker-flash'); setTimeout(function(){ el2.classList.remove('marker-flash'); }, 1400); }
                    } else {
                      failed++;
                    }
                  }
                }catch(e){}
              });
            }
          }catch(e){}
        });

        // clear selection visuals
        try{
          if (window.__sel__ && window.__sel__.set){ window.__sel__.set = new Set(); }
          document.getElementById('selCount') && (document.getElementById('selCount').textContent='0');
        }catch(e){}

        // 5) viewport: show assigned
        try{
          if (moved && bounds.isValid()){
            if (bounds.getNorthEast().equals(bounds.getSouthWest())) Lmap.flyTo(bounds.getNorthEast(), Math.max(Lmap.getZoom(), 15));
            else Lmap.fitBounds(bounds, {padding:[40,40]});
          }
        }catch(e){}

        // 6) feedback
        if (failed && !moved){ alert('Не удалось показать точки в слое (перенос визуально не отрисовался). Слой включён: '+displayName); }
        // restore filters
        restoreFilters(prevFilters);
      });
    })();
  });
})();
</script>
<!-- === v36: «Слой изменений» — назначение без перемещения в исходные группы, никаких исчезновений -->
<style>
  .changed-dup { stroke: #222; stroke-width: 2px; }
  #onlyChangedWrap { margin: 6px 0 }
</style>
<script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  ready(function(){
    var Lmap=null; for (var k in window){ try{ if(k.startsWith('map_') && window[k] && typeof window[k].eachLayer==='function'){ Lmap=window[k]; break; } }catch(e){} }
    if(!Lmap || !window.L) return;
    var L = window.L;

    // 1) Слой изменений (всегда поверх)
    var changesLayer = L.featureGroup().addTo(Lmap);
    // Постараемся добавить в контрол слоёв
    for (var k in window){
      var v=window[k];
      try{ if (v && v._layers && v._map===Lmap && typeof v.addOverlay==='function'){ v.addOverlay(changesLayer, 'Переназначенные (видимые)'); break; } }catch(e){}
    }

    // 2) Учёт изменений
    window.__assignLog = window.__assignLog || [];   // [{id, lat, lon, to_operator, ts, popup}]
    window.__assignIndex = window.__assignIndex || {}; // leaflet_id -> dup marker
    window.__lastAssignedDups = [];

    // 3) Кнопка «Показать только изменённые»
    (function(){
      if (document.getElementById('onlyChanged')) return;
      var host = document.getElementById('editBar') || document.body;
      var wrap = document.createElement('div'); wrap.id='onlyChangedWrap';
      wrap.innerHTML = '<label class="mini"><input id="onlyChanged" type="checkbox"> Показать только изменённые</label>';
      host.parentNode.insertBefore(wrap, host.nextSibling);
      var chk = wrap.querySelector('#onlyChanged');
      function setOnlyChanged(){
        var on = chk.checked;
        Lmap.eachLayer(function(ly){
          try{
            if (ly===changesLayer) return; // не трогаем слой изменений
            // Спрячем/покажем остальное
            if (typeof ly.eachLayer==='function'){
              ly.eachLayer(function(ch){
                try{
                  if (ch.setStyle){ ch.setStyle({opacity: on?0:1, fillOpacity: on?0:0.8}); }
                  if (ch.setOpacity){ ch.setOpacity(on?0:1); }
                }catch(e){}
              });
            } else {
              if (ly.setStyle){ ly.setStyle({opacity: on?0:1, fillOpacity: on?0:0.8}); }
              if (ly.setOpacity){ ly.setOpacity(on?0:1); }
            }
          }catch(e){}
        });
      }
      chk.addEventListener('change', setOnlyChanged);
    })();

    // 4) Перехватываем назначение
    function rewire(id, fn){ var b=document.getElementById(id); if(!b) return; var c=b.cloneNode(true); b.parentNode.replaceChild(c,b); c.addEventListener('click', function(e){ e.preventDefault(); fn(); }); }
    function getSelectionIds(){ return (window.__sel__ && window.__sel__.set) ? Array.from(window.__sel__.set) : []; }
    function isMarker(x){ return x && typeof x.getLatLng==='function' && (x._path || x._icon); }

    function duplicateMarker(m, color){
      try{
        var opt = Object.assign({}, m.options||{});
        if (color){ opt.color = color; opt.fillColor = color; }
        opt.radius = Math.max( (opt.radius||8) + 2, 8 );
        var dup = L.circleMarker(m.getLatLng(), opt);
        dup.addTo(changesLayer);
        dup.bringToFront && dup.bringToFront();
        try{ var el = dup._path || dup._icon; if (el){ el.classList.add('changed-dup'); } }catch(e){}
        return dup;
      }catch(e){ return null; }
    }

    function assignSafe(displayName){
      var ids = getSelectionIds(); if (!ids.length) return alert('Нет выбранных точек.');
      var moved=0, bounds=L.latLngBounds(); window.__lastAssignedDups = [];
      // Подберём цвет по первому выбранному маркеру (чтобы не лепить ядреный)
      var sampleColor = null;
      Lmap.eachLayer(function(ly){
        try{
          if (isMarker(ly) && ids.indexOf(ly._leaflet_id)!==-1){ sampleColor = (ly.options&& (ly.options.fillColor||ly.options.color)) || sampleColor; }
          else if (ly && typeof ly.eachLayer==='function'){
            ly.eachLayer(function(ch){ if (isMarker(ch) && ids.indexOf(ch._leaflet_id)!==-1){ sampleColor = (ch.options&& (ch.options.fillColor||ch.options.color)) || sampleColor; } });
          }
        }catch(e){}
      });
      // Дублируем
      Lmap.eachLayer(function(ly){
        try{
          if (isMarker(ly) && ids.indexOf(ly._leaflet_id)!==-1){
            var dup = window.__assignIndex[ly._leaflet_id];
            if (!dup){ dup = duplicateMarker(ly, sampleColor); if (dup) window.__assignIndex[ly._leaflet_id]=dup; }
            if (dup){
              // подпись
              try{
                var p = ly.getPopup && ly.getPopup();
                var base = p ? p.getContent() : '';
                dup.bindPopup && dup.bindPopup((base||'') + '<div style="margin-top:6px;font-weight:600">Назначено: '+displayName+'</div>');
              }catch(e){}
              bounds.extend(dup.getLatLng());
              window.__lastAssignedDups.push(dup);
              // лог
              window.__assignLog.push({ id: ly._leaflet_id, lat: dup.getLatLng().lat, lon: dup.getLatLng().lng, to_operator: displayName, ts: new Date().toISOString() });
              moved++;
            }
          } else if (ly && typeof ly.eachLayer==='function'){
            ly.eachLayer(function(ch){
              try{
                if (isMarker(ch) && ids.indexOf(ch._leaflet_id)!==-1){
                  var dup2 = window.__assignIndex[ch._leaflet_id];
                  if (!dup2){ dup2 = duplicateMarker(ch, sampleColor); if (dup2) window.__assignIndex[ch._leaflet_id]=dup2; }
                  if (dup2){
                    try{
                      var p2 = ch.getPopup && ch.getPopup();
                      var base2 = p2 ? p2.getContent() : '';
                      dup2.bindPopup && dup2.bindPopup((base2||'') + '<div style="margin-top:6px;font-weight:600">Назначено: '+displayName+'</div>');
                    }catch(e){}
                    bounds.extend(dup2.getLatLng());
                    window.__lastAssignedDups.push(dup2);
                    window.__assignLog.push({ id: ch._leaflet_id, lat: dup2.getLatLng().lat, lon: dup2.getLatLng().lng, to_operator: displayName, ts: new Date().toISOString() });
                    moved++;
                  }
                }
              }catch(e){}
            });
          }
        }catch(e){}
      });
      // очистим выделение
      try{
        if (window.__sel__ && window.__sel__.set){
          ids.forEach(x=>window.__sel__.set.delete(x));
        }
        var sc=document.getElementById('selCount'); if(sc) sc.textContent='0';
      }catch(e){}
      // показ
      if (moved && bounds.isValid()){
        try{
          if (bounds.getNorthEast().equals(bounds.getSouthWest())) Lmap.flyTo(bounds.getNorthEast(), Math.max(Lmap.getZoom(), 15));
          else Lmap.fitBounds(bounds, {padding:[40,40]});
        }catch(e){}
      }
      if (!moved) alert('Не удалось визуально показать назначение — дублирование не сработало.');
    }

    // Перепривяжем кнопки
    rewire('assignOp', function(){
      var sel=document.getElementById('targetOperator');
      var displayName = sel && sel.options && sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].textContent : (sel && sel.value);
      if (!displayName) return alert('Не выбран оператор.');
      assignSafe(displayName);
    });
    rewire('clearOp', function(){ assignSafe('Без оператора'); });

    // Undo: удаляем последние дубли
    (function(){
      if (document.getElementById('undoAssign')) return;
      var a=document.getElementById('assignOp'); if(!a) return;
      var u=document.createElement('button'); u.id='undoAssign'; u.textContent='Отменить назначение';
      a.parentNode.insertBefore(u, a.nextSibling);
      u.addEventListener('click', function(e){
        e.preventDefault();
        var list = window.__lastAssignedDups || [];
        if (!list.length) return alert('Нет назначений для отмены.');
        list.forEach(function(m){ try{ changesLayer.removeLayer(m); }catch(e){} });
        window.__lastAssignedDups = [];
        // также чистим последние записи из лога (по количеству удалённых)
        try{ window.__assignLog.splice(-list.length, list.length); }catch(e){}
      });
    })();

    // Экспорт «всех изменений (CSV)» подменим на наш лог
    (function(){
      var all = document.getElementById('exportAll');
      if (!all){
        // если в файле нет такой кнопки — создадим
        var host = document.getElementById('moveBar') || document.getElementById('editBar') || document.body;
        var wrap = document.createElement('div'); wrap.style.marginTop='6px';
        wrap.innerHTML = '<button id="exportAll">Экспорт всех изменений (CSV)</button>';
        host.parentNode.insertBefore(wrap, host.nextSibling);
        all = wrap.querySelector('#exportAll');
      }
      var c=all.cloneNode(true); all.parentNode.replaceChild(c, all);
      c.addEventListener('click', function(e){
        e.preventDefault();
        var data = window.__assignLog || [];
        if (!data.length) return alert('Изменений пока нет.');
        var head = ['id','lat','lon','to_operator','timestamp'];
        var rows = data.map(d => [d.id,d.lat,d.lon,'"'+String(d.to_operator||'').replace(/"/g,'""')+'"','"'+d.ts+'"'].join(','));
        var csv = head.join(',') + '\\n' + rows.join('\\n');
        var url=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
        var a=document.createElement('a'); a.href=url; a.download='all_changes.csv'; document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(url); a.remove();},500);
      });
    })();

  });
})();
</script>
<!-- === v37:Fix — снимаем выделение после назначения + корректный контент попапа без [object HTMLDivElement] === -->
<script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  ready(function(){
    var Lmap=null; for (var k in window){ try{ if(k.startsWith('map_') && window[k] && typeof window[k].eachLayer==='function'){ Lmap=window[k]; break; } }catch(e){} }
    if(!Lmap || !window.L) return;
    var L = window.L;

    // Найдём/создадим слой изменений, если вдруг не найден
    var changesLayer = null;
    Lmap.eachLayer(function(ly){ try{ if (ly && ly._layers && ly.getAttribution && (ly.getAttribution()+'')){} }catch(e){} });
    // попытка найти по названию в контроле слоёв
    var labs = [].slice.call(document.querySelectorAll('.leaflet-control-layers-overlays label'));
    for (var i=0;i<labs.length;i++){
      var t=(labs[i].textContent||'').trim().toLowerCase();
      if (t.indexOf('переназначенные')!==-1){
        try{
          var input=labs[i].querySelector('input[type="checkbox"]');
          input && input.click() && input.click();
        }catch(e){}
      }
    }
    // если в window хранится — используем
    if (window.__assignIndex) {
      // прокатит: слой есть, маркеры туда добавлялись ранее
    }

    function getSelectionIds(){ return (window.__sel__ && window.__sel__.set) ? Array.from(window.__sel__.set) : []; }
    function isMarker(x){ return x && typeof x.getLatLng==='function' && (x._path || x._icon); }
    function unmarkByIds(ids){
      if (!ids || !ids.length) return;
      Lmap.eachLayer(function(ly){
        try{
          if (isMarker(ly) && ids.indexOf(ly._leaflet_id)!==-1){
            if (typeof ly.__origRadius!=='undefined' && ly.setRadius){ ly.setRadius(ly.__origRadius); }
            var el=ly._path||ly._icon; if (el) el.classList.remove('marker-selected-outline');
          } else if (ly && typeof ly.eachLayer==='function'){
            ly.eachLayer(function(ch){
              try{
                if (isMarker(ch) && ids.indexOf(ch._leaflet_id)!==-1){
                  if (typeof ch.__origRadius!=='undefined' && ch.setRadius){ ch.setRadius(ch.__origRadius); }
                  var el2=ch._path||ch._icon; if (el2) el2.classList.remove('marker-selected-outline');
                }
              }catch(e){}
            });
          }
        }catch(e){}
      });
    }
    function contentToHTML(c){
      try{
        if (typeof c === 'string') return c;
        if (c && c.outerHTML) return c.outerHTML;
        if (c && c.textContent) return '<div>'+c.textContent+'</div>';
      }catch(e){}
      return '';
    }

    // Переопределяем обработчик Назначить, чтобы после назначения снять выделение и не накапливать "жир"
    var btn = document.getElementById('assignOp');
    if (btn){
      var clone = btn.cloneNode(true);
      btn.parentNode.replaceChild(clone, btn);
      clone.addEventListener('click', function(e){
        e.preventDefault();
        var ids = getSelectionIds();
        // Дадим отработать существующему обработчику (из v36), симулировав клик на скрытую кнопку,
        // но чтобы не потерять логику, просто вызовем нативное событие для исходной кнопки если оно осталось.
        // На некоторых платформах replaceChild стирает все старые обработчики – именно этого мы и хотели.
        // Поэтому реализуем дубль-назначение тут же, но только для слоя-дубликата (на случай если v36 удалён).
        try{
          var sel=document.getElementById('targetOperator');
          var displayName = sel && sel.options && sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].textContent : (sel && sel.value);
          if (!displayName) return alert('Не выбран оператор.');
          // Попробуем воспользоваться логом v36 — если функции нет, используем лёгкий дубликатор
          // Подхватим существующий слой-дубликатов или создадим
          var chLayer = null;
          // найдём по названию в оверлеях
          var lset=[].slice.call(document.querySelectorAll('.leaflet-control-layers-overlays label'));
          for (var i=0;i<lset.length;i++){
            var t=(lset[i].textContent||'').trim().toLowerCase();
            if (t.indexOf('переназначенные')!==-1){
              // включим
              try{ var cb=lset[i].querySelector('input[type="checkbox"]'); if (cb && !cb.checked) cb.click(); }catch(e){}
            }
          }
          // заберём из window.__assignIndex (создавался ранее)
          if (!window.__assignIndex) window.__assignIndex = {};
          if (!window.__assignLog) window.__assignLog = [];
          // Создадим слой сверху, если его не было
          if (!window.__changesLayerFix){
            window.__changesLayerFix = L.featureGroup().addTo(Lmap);
            // Добавим в контрол слоёв
            for (var k in window){
              var v=window[k]; try{ if (v && v._layers && v._map===Lmap && typeof v.addOverlay==='function'){ v.addOverlay(window.__changesLayerFix, 'Переназначенные (видимые)'); break; } }catch(err){}
            }
          }
          chLayer = window.__changesLayerFix;

          // цвет от первого
          var sampleColor=null;
          Lmap.eachLayer(function(ly){
            try{
              if (isMarker(ly) && ids.indexOf(ly._leaflet_id)!==-1){ sampleColor = (ly.options&&(ly.options.fillColor||ly.options.color)) || sampleColor; }
            }catch(e){}
          });

          var Lbounds = L.latLngBounds();
          ids.forEach(function(id){
            Lmap.eachLayer(function(ly){
              try{
                if (isMarker(ly) && ly._leaflet_id===id){
                  var opt = Object.assign({}, ly.options||{});
                  if (sampleColor){ opt.color=sampleColor; opt.fillColor=sampleColor; }
                  opt.radius = Math.max((opt.radius||8)+2,8);
                  var dup = window.__assignIndex[id];
                  if (!dup){
                    dup = L.circleMarker(ly.getLatLng(), opt).addTo(chLayer);
                    window.__assignIndex[id]=dup;
                    var pop = ly.getPopup && ly.getPopup();
                    var base = pop ? pop.getContent() : '';
                    dup.bindPopup && dup.bindPopup(contentToHTML(base) + '<div style="margin-top:6px;font-weight:600">Назначено: '+displayName+'</div>');
                  }
                  Lbounds.extend(dup.getLatLng());
                  window.__assignLog.push({id:id, lat:dup.getLatLng().lat, lon:dup.getLatLng().lng, to_operator:displayName, ts:new Date().toISOString()});
                }
              }catch(e){}
            });
          });
          // подлёт
          if (Lbounds.isValid()){
            if (Lbounds.getNorthEast().equals(Lbounds.getSouthWest())) Lmap.flyTo(Lbounds.getNorthEast(), Math.max(Lmap.getZoom(), 15));
            else Lmap.fitBounds(Lbounds, {padding:[40,40]});
          }
        }catch(err){ console.warn(err); }
        // Снимаем выделение и возвращаем радиусы
        try{
          unmarkByIds(ids);
          if (window.__sel__ && window.__sel__.set) window.__sel__.set = new Set();
          var sc=document.getElementById('selCount'); if (sc) sc.textContent='0';
        }catch(e){}
      });
    }

    // Также исправим контент попапов у уже созданных дубликатов
    setTimeout(function(){
      try{
        if (window.__assignIndex){
          Object.values(window.__assignIndex).forEach(function(m){
            try{
              var p=m.getPopup&&m.getPopup();
              if (p && typeof p.getContent==='function'){
                var c=p.getContent();
                if (typeof c!=='string' || c.indexOf('[object')!==-1){
                  p.setContent(contentToHTML(c));
                }
              }
            }catch(e){}
          });
        }
      }catch(e){}
    }, 300);
  });
})();
</script>
<!-- === v38: дубликаты не кликаются; не толстеют; попап не накапливает строки; повторное назначение обновляет одну строку -->
<style>
  .dup-nohit { pointer-events: none !important; }
</style>
<script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  ready(function(){
    var Lmap=null; for (var k in window){ try{ if(k.startsWith('map_') && window[k] && typeof window[k].eachLayer==='function'){ Lmap=window[k]; break; } }catch(e){} }
    if(!Lmap || !window.L) return;
    var L = window.L;
    // ensure registries
    if (!window.__assignIndex) window.__assignIndex = {};
    if (!window.__assignLog) window.__assignLog = [];

    // ensure changes layer exists
    if (!window.__changesLayerFix){
      window.__changesLayerFix = L.featureGroup().addTo(Lmap);
      for (var k in window){
        var v=window[k]; try{ if (v && v._layers && v._map===Lmap && typeof v.addOverlay==='function'){ v.addOverlay(window.__changesLayerFix, 'Переназначенные (видимые)'); break; } }catch(err){}
      }
    }
    var changesLayer = window.__changesLayerFix;

    function toHTML(c){
      try{
        if (typeof c === 'string') return c;
        if (c && c.outerHTML) return c.outerHTML;
        if (c && c.textContent) return '<div>'+c.textContent+'</div>';
      }catch(e){}
      return '';
    }
    function prepareDup(dup){
      try{
        dup.options.interactive = false;
        if (dup._path) dup._path.classList.add('dup-nohit');
        if (dup._icon) dup._icon.classList.add('dup-nohit');
      }catch(e){}
      return dup;
    }
    function setDupLabel(dup, baseHTML, operatorName){
      try{
        if (!dup.__baseHTML) dup.__baseHTML = baseHTML || '';
        var html = (dup.__baseHTML||'') + '<div style="margin-top:6px;font-weight:600">Назначено: '+operatorName+'</div>';
        dup.bindPopup && dup.bindPopup(html);
      }catch(e){}
    }

    // override assign logic (ещё раз), теперь всегда: 1 дубль на исходный id, без изменения радиуса
    var btn = document.getElementById('assignOp');
    if (btn){
      var clone = btn.cloneNode(true);
      btn.parentNode.replaceChild(clone, btn);
      clone.addEventListener('click', function(e){
        e.preventDefault();
        var ids = (window.__sel__ && window.__sel__.set) ? Array.from(window.__sel__.set) : [];
        if (!ids.length) return alert('Нет выбранных точек.');
        var sel=document.getElementById('targetOperator');
        var displayName = sel && sel.options && sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].textContent : (sel && sel.value);
        if (!displayName) return alert('Не выбран оператор.');

        var bounds = L.latLngBounds();
        // color sample (не меняем радиус)
        var sampleColor=null;
        function isMarker(x){ return x && typeof x.getLatLng==='function' && (x._path || x._icon); }
        Lmap.eachLayer(function(ly){
          try{
            if (isMarker(ly) && ids.indexOf(ly._leaflet_id)!==-1){ sampleColor = (ly.options&&(ly.options.fillColor||ly.options.color)) || sampleColor; }
            else if (ly && typeof ly.eachLayer==='function'){
              ly.eachLayer(function(ch){ if (isMarker(ch) && ids.indexOf(ch._leaflet_id)!==-1){ sampleColor = (ch.options&&(ch.options.fillColor||ch.options.color)) || sampleColor; } });
            }
          }catch(e){}
        });

        ids.forEach(function(id){
          Lmap.eachLayer(function(ly){
            try{
              if (!isMarker(ly)) return;
              if (ly._leaflet_id !== id) return;
              // base content из ОРИГИНАЛА
              var pop = ly.getPopup && ly.getPopup();
              var base = pop ? toHTML(pop.getContent()) : '';
              var dup = window.__assignIndex[id];
              if (!dup){
                var opt = Object.assign({}, ly.options||{});
                if (sampleColor){ opt.color=sampleColor; opt.fillColor=sampleColor; }
                // не увеличиваем радиус
                if (typeof opt.radius === 'undefined') opt.radius = 8;
                dup = L.circleMarker(ly.getLatLng(), opt).addTo(changesLayer);
                prepareDup(dup);
                window.__assignIndex[id] = dup;
                dup.__baseHTML = base; // запоминаем чистую основу
              } else {
                // просто обновим координату (на случай если переносили) и основу если вдруг пустая
                try{ dup.setLatLng(ly.getLatLng()); }catch(e){}
                if (!dup.__baseHTML) dup.__baseHTML = base;
              }
              setDupLabel(dup, dup.__baseHTML, displayName);
              bounds.extend(dup.getLatLng());
              window.__assignLog.push({id:id, lat:dup.getLatLng().lat, lon:dup.getLatLng().lng, to_operator:displayName, ts:new Date().toISOString()});
            }catch(e){}
          });
        });

        // fly
        if (bounds.isValid()){
          try{
            if (bounds.getNorthEast().equals(bounds.getSouthWest())) Lmap.flyTo(bounds.getNorthEast(), Math.max(Lmap.getZoom(), 15));
            else Lmap.fitBounds(bounds, {padding:[40,40]});
          }catch(e){}
        }
        // clear selection and outline on originals
        try{
          if (window.__sel__ && window.__sel__.set){
            var toClear = Array.from(window.__sel__.set);
            window.__sel__.set = new Set();
            // снимем визуалку
            Lmap.eachLayer(function(ly){
              try{
                if (isMarker(ly) && toClear.indexOf(ly._leaflet_id)!==-1){
                  if (typeof ly.__origRadius!=='undefined' && ly.setRadius){ ly.setRadius(ly.__origRadius); }
                  var el=ly._path||ly._icon; if (el) el.classList.remove('marker-selected-outline');
                } else if (ly && typeof ly.eachLayer==='function'){
                  ly.eachLayer(function(ch){
                    if (isMarker(ch) && toClear.indexOf(ch._leaflet_id)!==-1){
                      if (typeof ch.__origRadius!=='undefined' && ch.setRadius){ ch.setRadius(ch.__origRadius); }
                      var el2=ch._path||ch._icon; if (el2) el2.classList.remove('marker-selected-outline');
                    }
                  });
                }
              }catch(e){}
            });
          }
          var sc=document.getElementById('selCount'); if (sc) sc.textContent='0';
        }catch(e){}
      });
    }

    // На всякий случай сделаем уже существующие дубликаты некликабельными и нормализуем их попап
    setTimeout(function(){
      try{
        Object.values(window.__assignIndex).forEach(function(dup){
          try{
            prepareDup(dup);
            var p=dup.getPopup&&dup.getPopup();
            if (p){
              var c=p.getContent();
              if (typeof c!=='string' || c.indexOf('[object')!==-1){
                p.setContent(toHTML(c));
              }
            }
          }catch(e){}
        });
      }catch(e){}
    }, 300);
  });
})();
</script>
<!-- === v39: перезапись назначений + сохранение в новый HTML === -->
<style>
  #persistBar { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 }
  #persistBar > * { padding:8px 10px; border-radius:8px; border:1px solid #ccc; background:#fff; }
</style>
<script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  ready(function(){
    var Lmap=null; for (var k in window){ try{ if(k.startsWith('map_') && window[k] && typeof window[k].eachLayer==='function'){ Lmap=window[k]; break; } }catch(e){} }
    if(!Lmap || !window.L) return;
    var L = window.L;

    // Панель «применить/сохранить»
    (function(){
      if (document.getElementById('persistBar')) return;
      var host = document.getElementById('moveBar') || document.getElementById('editBar') || document.body;
      var bar = document.createElement('div'); bar.id='persistBar';
      bar.innerHTML = ''
        + '<button id="btnApplyNow">Применить в этой сессии</button>'
        + '<button id="btnSaveHTML">Скачать обновлённый HTML</button>'
        + '<span style="align-self:center;font-size:12px;opacity:.7">Назначения сохраняются по названию локации (1-я строка попапа)</span>';
      host.parentNode.insertBefore(bar, host.nextSibling);
    })();

    // Реестр назначений по ключу локации (перезаписываемый)
    window.__assignmentMap = window.__assignmentMap || {}; // key -> operator name

    function textFromPopup(m){
      try{
        var p = m.getPopup && m.getPopup();
        var node = p ? p.getContent() : '';
        var tmp = document.createElement('div'); tmp.innerHTML = (typeof node==='string') ? node : (node && node.outerHTML ? node.outerHTML : '');
        var text = tmp.textContent || '';
        return text.split('\\n').map(s=>s.trim()).filter(Boolean)[0] || '';
      }catch(e){ return ''; }
    }
    function extractOperatorFromDup(dup){
      try{
        var p = dup.getPopup && dup.getPopup();
        var txt = p ? (typeof p.getContent()==='string' ? p.getContent() : (p.getContent().textContent||'')) : '';
        var m = txt.match(/Назначено:\s*([^<\\n]+)/i);
        return m ? m[1].trim() : '';
      }catch(e){ return ''; }
    }
    // При создании дубля запоминаем ключ
    function hookDupKeys(){
      try{
        if (!window.__assignIndex) return;
        Object.keys(window.__assignIndex).forEach(function(id){
          var dup = window.__assignIndex[id];
          if (dup && !dup.__key){
            // найдём оригинал по id
            var orig=null;
            Lmap.eachLayer(function(ly){
              try{ if (ly && ly._leaflet_id==id) orig = ly; }catch(e){}
              if (!orig && ly && typeof ly.eachLayer==='function'){
                ly.eachLayer(function(ch){ try{ if (ch && ch._leaflet_id==id) orig = ch; }catch(e){} });
              }
            });
            if (orig){
              dup.__key = textFromPopup(orig);
              // и сразу запишем в карту назначений
              var op = extractOperatorFromDup(dup);
              if (dup.__key && op){
                window.__assignmentMap[dup.__key] = op;
              }
            }
          }
        });
      }catch(e){}
    }
    hookDupKeys();
    setInterval(hookDupKeys, 1000); // на случай последующих назначений

    // Применение «вживую» — переносим оригиналы по назначенным операторам
    function getOverlaysMap(){
      var map = {};
      var labs = [].slice.call(document.querySelectorAll('.leaflet-control-layers-overlays label'));
      labs.forEach(function(l){
        var name = (l.textContent||'').trim();
        var cb = l.querySelector('input[type="checkbox"]');
        map[name] = {label:l, input:cb};
      });
      return map;
    }
    function ensureOverlayVisible(name){
      var overlays = getOverlaysMap();
      var rec = overlays[name];
      if (rec && rec.input && !rec.input.checked){ rec.input.click(); }
    }
    function findGroupByName(name){
      var target = null;
      // попытаемся активировать слой и поймать его через события
      var overlays = getOverlaysMap();
      var rec = overlays[name];
      if (rec && rec.input){
        var got = null;
        function h(e){ try{ if (!got) got = e.layer; }catch(err){} }
        Lmap.on('layeradd',h);
        if (!rec.input.checked) rec.input.click(); // включим
        Lmap.off('layeradd',h);
        target = got;
      }
      // если не поймали — перебор featureGroup'ов
      if (!target){
        var cand = [];
        Lmap.eachLayer(function(ly){ try{ if (ly && typeof ly.eachLayer==='function' && ly !== window.__changesLayerFix) cand.push(ly); }catch(e){} });
        // берём первый, который упоминается в label (эвристика)
        Object.keys(overlays).some(function(n){
          if (n === name && rec && rec.input){ target = cand[0]; return true; }
          return false;
        });
      }
      return target;
    }
    function moveOriginalToGroup(orig, group){
      try{
        // удалить из всех групп
        Lmap.eachLayer(function(g){ try{ if (g && g.hasLayer && g.hasLayer(orig) && g.removeLayer) g.removeLayer(orig); }catch(e){} });
        // добавить
        if (group && group.addLayer) group.addLayer(orig);
      }catch(e){}
    }

    function applyAssignments(){
      var overlays = getOverlaysMap();
      var keys = Object.keys(window.__assignmentMap||{});
      if (!keys.length) return alert('Назначений нет.');
      // для каждого оригинала сопоставим ключ и перенесём в нужный слой
      var moved=0;
      Lmap.eachLayer(function(ly){
        try{
          if (ly && typeof ly.eachLayer==='function'){
            ly.eachLayer(function(ch){
              try{
                if (typeof ch.getPopup!=='function') return;
                var key = textFromPopup(ch);
                var op = window.__assignmentMap[key];
                if (op){
                  ensureOverlayVisible(op);
                  var group = findGroupByName(op);
                  if (group){ moveOriginalToGroup(ch, group); moved++; }
                }
              }catch(e){}
            });
          }
        }catch(e){}
      });
      alert('Применено переносов: '+moved);
    }

    document.getElementById('btnApplyNow').addEventListener('click', function(e){ e.preventDefault(); applyAssignments(); });

    // Сохранение нового HTML с автоприменением назначений
    document.getElementById('btnSaveHTML').addEventListener('click', function(e){
      e.preventDefault();
      // соберём актуальную карту назначений (включая свежие дубликаты)
      hookDupKeys();
      var data = JSON.stringify(window.__assignmentMap || {});
      // Сформируем и вставим на лету загрузочный скрипт, который применит назначения при открытии файла
      var bootstrap = [
        '<script>',
        '(function(){',
        '  var assignments = ' + data + ';',
        '  function ready(fn){ if(document.readyState!==\"loading\"){fn();} else { document.addEventListener(\"DOMContentLoaded\", fn);} }',
        '  ready(function(){',
        '    var Lmap=null; for (var k in window){ try{ if(k.startsWith(\"map_\") && window[k] && typeof window[k].eachLayer===\"function\"){ Lmap=window[k]; break; } }catch(e){} }',
        '    if(!Lmap || !window.L) return;',
        '    var L=window.L;',
        '    function textFromPopup(m){ try{ var p=m.getPopup&&m.getPopup(); var node=p? p.getContent():\"\"; var tmp=document.createElement(\"div\"); tmp.innerHTML=(typeof node===\"string\")?node:(node&&node.outerHTML?node.outerHTML:\"\"); var t=tmp.textContent||\"\"; return t.split(\"\\n\").map(function(s){return s.trim()}).filter(Boolean)[0]||\"\"; }catch(e){ return \"\"; } }',
        '    function getOverlaysMap(){ var map={}; var labs=[].slice.call(document.querySelectorAll(\".leaflet-control-layers-overlays label\")); labs.forEach(function(l){ var name=(l.textContent||\"\").trim(); var cb=l.querySelector(\"input[type=checkbox]\"); map[name]={label:l,input:cb}; }); return map; }',
        '    function ensureOverlayVisible(name){ var o=getOverlaysMap()[name]; if(o && o.input && !o.input.checked){ o.input.click(); } }',
        '    function findGroupByName(name){ var target=null; var o=getOverlaysMap()[name]; if (o && o.input){ var got=null; function h(e){ try{ if(!got) got=e.layer; }catch(err){} } Lmap.on(\"layeradd\",h); if(!o.input.checked) o.input.click(); Lmap.off(\"layeradd\",h); target=got; } return target; }',
        '    function moveOriginalToGroup(orig, group){ try{ Lmap.eachLayer(function(g){ try{ if(g && g.hasLayer && g.hasLayer(orig) && g.removeLayer) g.removeLayer(orig); }catch(e){} }); if (group && group.addLayer) group.addLayer(orig); }catch(e){} }',
        '    Lmap.eachLayer(function(ly){ try{ if (ly && typeof ly.eachLayer===\"function\"){ ly.eachLayer(function(ch){ try{ if (typeof ch.getPopup!==\"function\") return; var key=textFromPopup(ch); var op=assignments[key]; if(op){ ensureOverlayVisible(op); var grp=findGroupByName(op); if(grp){ moveOriginalToGroup(ch, grp); } } }catch(e){} }); } }catch(e){} });',
        '  });',
        '})();',
        '<\/script>'
      ].join('');
      // Вставим перед <script>(function(){  var assignments = {"банкОператор: Алиев РусланМаршрут: -Класс: A | Частота: 3×/недСреднесуточные продажи (сумма): 1469.0Автоматов на локации: 1":"Оператор: Скворцов Артем","КурскаяОператор: Аминов РусланМаршрут: -Класс: A | Частота: 3×/недСреднесуточные продажи (сумма): 2096.15Автоматов на локации: 1":"Оператор: Скворцов Артем","ЛицейОператор: Богданов ДанилМаршрут: -Класс: A | Частота: 3×/недСреднесуточные продажи (сумма): 384.0Автоматов на локации: 1":"Оператор: Скворцов Артем","ПерерваОператор: Богданов ДанилМаршрут: -Класс: A | Частота: 3×/недСреднесуточные продажи (сумма): 9075.65Автоматов на локации: 7":"Оператор: Скворцов Артем","ЭлектроХабОператор: Богданов ДанилМаршрут: -Класс: A | Частота: 3×/недСреднесуточные продажи (сумма): 2105.0Автоматов на локации: 2":"Оператор: Скворцов Артем","ФитнесОператор: Богданов ДанилаМаршрут: -Класс: A | Частота: 3×/недСреднесуточные продажи (сумма): 691.43Автоматов на локации: 1":"Оператор: Скворцов Артем","БалашихаОператор: Кумачев Сергей.Маршрут: -Класс: A | Частота: 3×/недСреднесуточные продажи (сумма): 2167.86Автоматов на локации: 2":"Оператор: Скворцов Артем","МытищиОператор: Скворцов АртемМаршрут: Маршрут №1 СеверКласс: A | Частота: 3×/недСреднесуточные продажи (сумма): 3376.1Автоматов на локации: 3":"Оператор: Скворцов Артем","РостокиноОператор: Скворцов АртемМаршрут: Маршрут №1 СеверКласс: A | Частота: 3×/недСреднесуточные продажи (сумма): 4252.14Автоматов на локации: 1":"Оператор: Скворцов Артем","ЦентросоюзныйОператор: Скворцов АртемМаршрут: Маршрут №1 СеверКласс: A | Частота: 3×/недСреднесуточные продажи (сумма): 3719.29Автоматов на локации: 3":"Оператор: Скворцов Артем","ОпераОператор: Устюгов НиколайМаршрут: -Класс: A | Частота: 3×/недСреднесуточные продажи (сумма): 1235.83Автоматов на локации: 1":"Оператор: Скворцов Артем"};  function ready(fn){ if(document.readyState!=="loading"){fn();} else { document.addEventListener("DOMContentLoaded", fn);} }  ready(function(){    var Lmap=null; for (var k in window){ try{ if(k.startsWith("map_") && window[k] && typeof window[k].eachLayer==="function"){ Lmap=window[k]; break; } }catch(e){} }    if(!Lmap || !window.L) return;    var L=window.L;    function textFromPopup(m){ try{ var p=m.getPopup&&m.getPopup(); var node=p? p.getContent():""; var tmp=document.createElement("div"); tmp.innerHTML=(typeof node==="string")?node:(node&&node.outerHTML?node.outerHTML:""); var t=tmp.textContent||""; return t.split("\n").map(function(s){return s.trim()}).filter(Boolean)[0]||""; }catch(e){ return ""; } }    function getOverlaysMap(){ var map={}; var labs=[].slice.call(document.querySelectorAll(".leaflet-control-layers-overlays label")); labs.forEach(function(l){ var name=(l.textContent||"").trim(); var cb=l.querySelector("input[type=checkbox]"); map[name]={label:l,input:cb}; }); return map; }    function ensureOverlayVisible(name){ var o=getOverlaysMap()[name]; if(o && o.input && !o.input.checked){ o.input.click(); } }    function findGroupByName(name){ var target=null; var o=getOverlaysMap()[name]; if (o && o.input){ var got=null; function h(e){ try{ if(!got) got=e.layer; }catch(err){} } Lmap.on("layeradd",h); if(!o.input.checked) o.input.click(); Lmap.off("layeradd",h); target=got; } return target; }    function moveOriginalToGroup(orig, group){ try{ Lmap.eachLayer(function(g){ try{ if(g && g.hasLayer && g.hasLayer(orig) && g.removeLayer) g.removeLayer(orig); }catch(e){} }); if (group && group.addLayer) group.addLayer(orig); }catch(e){} }    Lmap.eachLayer(function(ly){ try{ if (ly && typeof ly.eachLayer==="function"){ ly.eachLayer(function(ch){ try{ if (typeof ch.getPopup!=="function") return; var key=textFromPopup(ch); var op=assignments[key]; if(op){ ensureOverlayVisible(op); var grp=findGroupByName(op); if(grp){ moveOriginalToGroup(ch, grp); } } }catch(e){} }); } }catch(e){} });  });})();</script>\n
<!-- === v40: FIX save — export a CLEAN HTML (no frozen background map) === -->
<script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  ready(function(){
    var btn = document.getElementById('btnSaveHTML');
    if (!btn) return;
    var clone = btn.cloneNode(true);
    btn.parentNode.replaceChild(clone, btn);
    clone.addEventListener('click', function(e){
      e.preventDefault();
      try{
        // 1) collect current reassignment map (per location title)
        var data = JSON.stringify(window.__assignmentMap || {});

        // 2) build bootstrap that will auto-apply assignments on file open
        var bootstrap = [
          '<script>',
          '(function(){',
          '  var assignments = ' + data + ';',
          '  function ready(fn){ if(document.readyState!=="loading"){fn();} else { document.addEventListener("DOMContentLoaded", fn);} }',
          '  ready(function(){',
          '    var Lmap=null; for (var k in window){ try{ if(k.startsWith("map_") && window[k] && typeof window[k].eachLayer==="function"){ Lmap=window[k]; break; } }catch(e){} }',
          '    if(!Lmap || !window.L) return;',
          '    var L=window.L;',
          '    function textFromPopup(m){ try{ var p=m.getPopup&&m.getPopup(); var node=p? p.getContent():""; var tmp=document.createElement("div"); tmp.innerHTML=(typeof node==="string")?node:(node&&node.outerHTML?node.outerHTML:""); var t=tmp.textContent||""; return t.split("\\n").map(function(s){return s.trim()}).filter(Boolean)[0]||""; }catch(e){ return ""; } }',
          '    function getOverlaysMap(){ var map={}; var labs=[].slice.call(document.querySelectorAll(".leaflet-control-layers-overlays label")); labs.forEach(function(l){ var name=(l.textContent||"").trim(); var cb=l.querySelector("input[type=checkbox]"); map[name]={label:l,input:cb}; }); return map; }',
          '    function ensureOverlayVisible(name){ var o=getOverlaysMap()[name]; if(o && o.input && !o.input.checked){ o.input.click(); } }',
          '    function findGroupByName(name){ var target=null; var o=getOverlaysMap()[name]; if (o && o.input){ var got=null; function h(e){ try{ if(!got) got=e.layer; }catch(err){} } Lmap.on("layeradd",h); if(!o.input.checked) o.input.click(); Lmap.off("layeradd",h); target=got; } return target; }',
          '    function moveOriginalToGroup(orig, group){ try{ Lmap.eachLayer(function(g){ try{ if(g && g.hasLayer && g.hasLayer(orig) && g.removeLayer) g.removeLayer(orig); }catch(e){} }); if (group && group.addLayer) group.addLayer(orig); }catch(e){} }',
          '    Lmap.eachLayer(function(ly){ try{ if (ly && typeof ly.eachLayer==="function"){ ly.eachLayer(function(ch){ try{ if (typeof ch.getPopup!=="function") return; var key=textFromPopup(ch); var op=assignments[key]; if(op){ ensureOverlayVisible(op); var grp=findGroupByName(op); if(grp){ moveOriginalToGroup(ch, grp); } } }catch(e){} }); } }catch(e){} });',
          '  });',
          '})();',
          '<\/script>'
        ].join("");

        // 3) clone the whole document and CLEAN Leaflet runtime DOM inside map containers
        var doc = document.documentElement.cloneNode(true);
        var mapDivs = doc.querySelectorAll('div[id^="map_"]');
        for (var i=0;i<mapDivs.length;i++){
          var d = mapDivs[i];
          d.setAttribute('class','folium-map');
          d.setAttribute('style','outline: none;');
          // remove all children so Leaflet can create fresh panes on load
          while (d.firstChild) d.removeChild(d.firstChild);
        }

        // 4) serialize and inject bootstrap before 
<!-- v9: Самотест + безопасный "Новый оператор" + мульти‑базовые карты (без ломки существующего) -->
<style>
  /* Минималистичные стили без влияния на твой UI */
  #createOpBar{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0;align-items:center}
  #createOpBar input{padding:6px 8px;border:1px solid #bbb;border-radius:6px;font-size:14px}
  #createOpBar button{padding:6px 10px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  #newOpsBox{margin:6px 0;padding:6px;border:1px dashed #ccc;border-radius:8px}
  #newOpsBox .row{margin:2px 0}
  .toast-mini{position:fixed;right:10px;bottom:10px;background:#222;color:#fff;padding:8px 10px;border-radius:8px;opacity:.92;z-index:10000}
  .basemap-switch{position:absolute;right:10px;top:10px;z-index:1000}
  .basemap-switch button{padding:6px 10px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  .diag-panel{position:fixed;left:10px;bottom:10px;background:#fff;border:1px solid #ccc;border-radius:10px;padding:8px 10px;font:12px/1.2 system-ui, Arial, sans-serif;box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:9999}
  .diag-panel .row{margin:2px 0}
  .diag-panel .ok{color:#2e7d32;font-weight:600}
  .diag-panel .warn{color:#b26a00;font-weight:600}
  .diag-panel .bad{color:#c62828;font-weight:600}
  .diag-panel button{margin-left:8px;padding:3px 8px}
</style>
<script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  function findMap(){
    for (var k in window){
      try{
        var m=window[k];
        if(m && m._leaflet_id && typeof m.addLayer==='function' && typeof m.on==='function'){
          return m;
        }
      }catch(e){}
    }
    return null;
  }
  function getLayersControl(map){
    for (var k in window){
      try{
        var v=window[k];
        if(v && v._map===map && v._layers && typeof v.addOverlay==='function') return v;
      }catch(e){}
    }
    return null;
  }
  function toast(msg){ var t=document.createElement('div'); t.className='toast-mini'; t.textContent=msg; document.body.appendChild(t); setTimeout(function(){ t.remove(); }, 1800); }

  // --- Самотест
  function buildDiag(map){
    if(document.getElementById('diagPanel')) return;
    var p=document.createElement('div'); p.id='diagPanel'; p.className='diag-panel';
    p.innerHTML='<div style="font-weight:700;margin-bottom:4px">Проверка</div>'+
      '<div class="row">Leaflet: <span id="d-leaflet" class="bad">нет</span></div>'+
      '<div class="row">Карта: <span id="d-map" class="bad">нет</span></div>'+
      '<div class="row">Tile слои: <span id="d-tiles" class="warn">0</span></div>'+
      '<div class="row">Маркер/линии: <span id="d-objs" class="warn">0</span></div>'+
      '<div class="row">Контрол слоёв: <span id="d-ctrl" class="warn">нет</span></div>'+
      '<div class="row"><button id="d-retry">Перепроверить</button></div>';
    document.body.appendChild(p);
    function scan(){
      var L=window.L;
      p.querySelector('#d-leaflet').textContent = L ? 'ok' : 'нет';
      p.querySelector('#d-leaflet').className = L ? 'ok' : 'bad';
      var okMap = !!map;
      p.querySelector('#d-map').textContent = okMap ? 'ok' : 'нет';
      p.querySelector('#d-map').className = okMap ? 'ok' : 'bad';
      var tiles=0, objs=0;
      if(map){
        map.eachLayer(function(ly){
          if(ly && (ly._url || typeof ly.getTileUrl==='function')) tiles++;
          else objs++;
        });
      }
      var tilesEl=p.querySelector('#d-tiles');
      tilesEl.textContent = tiles;
      tilesEl.className = tiles>0 ? 'ok' : 'warn';
      var objsEl=p.querySelector('#d-objs');
      objsEl.textContent = objs;
      objsEl.className = objs>0 ? 'ok' : 'warn';
      var ctrl = getLayersControl(map);
      var ctrlEl=p.querySelector('#d-ctrl');
      ctrlEl.textContent = ctrl ? 'да' : 'нет';
      ctrlEl.className = ctrl ? 'ok' : 'warn';
    }
    scan();
    p.querySelector('#d-retry').onclick = scan;
  }

  // --- безопасное добавление UI
  ready(function(){
    var wrap=document.getElementById('opControlWrapper');
    var map=findMap();
    if(map) buildDiag(map);

    if(wrap && !document.getElementById('createOpBar')){
      var bar=document.createElement('div'); bar.id='createOpBar';
      bar.innerHTML='<input id="newOpName" type="text" placeholder="Новый оператор… (например, Иван Петров)">'+
                    '<button id="newOpAdd">Добавить оператора</button>';
      wrap.insertBefore(bar, wrap.firstChild);
      // блок для чекбоксов, если нет L.control.layers
      var box=document.createElement('div'); box.id='newOpsBox';
      box.innerHTML='<div style="font-weight:600;margin-bottom:4px">Новые операторы</div>';
      wrap.insertBefore(box, bar.nextSibling);
    }
    var inp=document.getElementById('newOpName');
    var btn=document.getElementById('newOpAdd');
    var box=document.getElementById('newOpsBox');
    function normalizeName(raw){
      var name=(raw||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim();
      if(!name) return '';
      if(/^без\s+оператора$/i.test(name)) return 'Без оператора';
      if(/^оператор\s*:/i.test(name)) return 'Оператор: '+name.split(':').slice(1).join(':').trim();
      return 'Оператор: '+name;
    }
    function findOperatorSelect(){
      var selects=[].slice.call(document.querySelectorAll('select'));
      for(var i=0;i<selects.length;i++){
        var text=[].map.call(selects[i].options, o=>(o.textContent||o.value||'').toLowerCase()).join('|');
        if(/оператор:|без оператора/.test(text)) return selects[i];
      }
      return null;
    }
    function addOptionToSelect(displayName){
      var sel=findOperatorSelect(); if(!sel) return;
      for(var i=0;i<sel.options.length;i++){
        var t=(sel.options[i].textContent||sel.options[i].value||'').trim();
        if(t===displayName){ sel.selectedIndex=i; return; }
      }
      var o=document.createElement('option'); o.value=displayName; o.textContent=displayName;
      sel.appendChild(o); sel.selectedIndex=sel.options.length-1;
    }
    function addRowToggle(displayName, group){
      var row=document.createElement('div'); row.className='row';
      var id='chk_'+Math.random().toString(36).slice(2);
      row.innerHTML='<label><input type="checkbox" id="'+id+'" checked> '+displayName+'</label>';
      box.appendChild(row);
      var cb=row.querySelector('input');
      cb.addEventListener('change', function(){ if(cb.checked){ group.addTo(map); } else { map.removeLayer(group); } });
    }

    if(btn){
      var ctrl=getLayersControl(map); // ok, может быть null
      window.__opIndex = window.__opIndex || {};
      function createOperator(){
        var displayName=normalizeName(inp.value);
        if(!displayName){ toast('Введите имя оператора'); inp.focus(); return; }
        var key=String(displayName||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').toLowerCase().trim();
        var group=window.__opIndex[key];
        if(!group){
          group=L.featureGroup(); group.addTo(map);
          window.__opIndex[key]=group;
          if (ctrl && typeof ctrl.addOverlay==='function'){
            try{ ctrl.addOverlay(group, displayName); }catch(e){ addRowToggle(displayName, group); }
          } else {
            addRowToggle(displayName, group);
          }
        } else {
          if(!map.hasLayer(group)) group.addTo(map);
        }
        addOptionToSelect(displayName);
        inp.value='';
        toast('Создан оператор: '+displayName.replace(/^Оператор:\s*/,''));
      }
      btn.onclick=function(e){ e.preventDefault(); createOperator(); };
      inp.addEventListener('keydown', function(ev){ if(ev.key==='Enter'){ ev.preventDefault(); createOperator(); }});
    }

    // ---- мульти‑базовые карты (если базового слоя нет)
    if(map && !document.getElementById('basemapSwitchBtn')){
      var hasTiles=false;
      map.eachLayer(function(ly){ if(ly && (ly._url || typeof ly.getTileUrl==='function')) hasTiles=true; });
      var providers=[
        {name:'OSM', url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', opt:{attribution:'© OpenStreetMap', subdomains:'abc', maxZoom:20}},
        {name:'OSM.de', url:'https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', opt:{attribution:'© OpenStreetMap.de', subdomains:'abc', maxZoom:19}},
        {name:'OSM FR', url:'https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', opt:{attribution:'© OpenStreetMap FR', subdomains:'abc', maxZoom:20}},
        {name:'Carto Light', url:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', opt:{attribution:'© Carto', subdomains:'abcd', maxZoom:20}},
        {name:'Carto Dark', url:'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', opt:{attribution:'© Carto', subdomains:'abcd', maxZoom:20}}
      ];
      var idx=0, current=null;
      function switchTo(i){
        if(current){ map.removeLayer(current); }
        idx=i%providers.length; var p=providers[idx];
        current=L.tileLayer(p.url, p.opt).addTo(map);
        btnBM.textContent='Карта: '+p.name;
      }
      var panel=document.createElement('div'); panel.className='basemap-switch';
      var btnBM=document.createElement('button'); btnBM.id='basemapSwitchBtn'; btnBM.textContent='Карта: авто';
      btnBM.onclick=function(e){ e.preventDefault(); switchTo(idx+1); };
      panel.appendChild(btnBM);
      try{ map.getContainer().appendChild(panel); }catch(e){}
      if(!hasTiles){ switchTo(0); }
    }
  });
})();
</script>


<!-- v11: Панель управления операторами: фильтр, переименование, удаление -->
<style>
  #manageOpsBar{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0;align-items:center}
  #manageOpsBar input,#manageOpsBar select{padding:6px 8px;border:1px solid #bbb;border-radius:6px;font-size:14px}
  #manageOpsBar button{padding:6px 10px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  #manageOpsBar .hint{font-size:12px;color:#666;margin-left:4px}
</style>
<script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  function N(s){ return String(s||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').toLowerCase().trim(); }

  ready(function(){
    var wrap = document.getElementById('opControlWrapper');
    if(!wrap || document.getElementById('manageOpsBar')) return;

    // UI
    var bar = document.createElement('div'); bar.id='manageOpsBar';
    bar.innerHTML = ''
      + '<input id="opsSearch" type="text" placeholder="Фильтр операторов…">'
      + '<select id="opsSelect" style="min-width:260px"></select>'
      + '<input id="opsRenameTo" type="text" placeholder="Новое имя">'
      + '<button id="btnOpsRename" title="Перенесёт все точки в оператора с новым именем">Переименовать</button>'
      + '<button id="btnOpsDelete" title="Перенесёт все точки в «Без оператора» и удалит слой">Удалить → Без оператора</button>'
      + '<span class="hint">Действия применяются к выбранному оператору</span>';
    // вставим после блока "Новые операторы"
    var newOpsBox = document.getElementById('newOpsBox');
    if(newOpsBox && newOpsBox.nextSibling){
      wrap.insertBefore(bar, newOpsBox.nextSibling);
    }else{
if(!window.__opIndex){window.__opIndex={}}; if(!window.__opIndex[key]) window.__opIndex[key]=group;

      wrap.insertBefore(bar, wrap.firstChild);
    }

    var opsSearch = document.getElementById('opsSearch');
    var opsSelect = document.getElementById('opsSelect');
    var renameTo  = document.getElementById('opsRenameTo');
    var btnRename = document.getElementById('btnOpsRename');
    var btnDelete = document.getElementById('btnOpsDelete');

    // helpers
    function findMap(){ for(var k in window){ try{ var m=window[k]; if(m && m._leaflet_id && m.addLayer && m.on){ return m; } }catch(e){} } return null; }
    function getLayerByName(name){
      window.__opIndex = window.__opIndex || {};
      var key = N(name);
      return window.__opIndex[key] || null;
    }
    function ensureTargetLayer(name){
      // переиспользуем имеющуюся util если она есть
      if (typeof window.ensureTargetLayer === 'function'){ return window.ensureTargetLayer(name); }
      // fallback: создадим слой и зарегистрируем
      var map = findMap(); if(!map) return null;
      var grp = getLayerByName(name);
      if(!grp){
        grp = L.featureGroup().addTo(map);
        window.__opIndex[N(name)] = grp;
      }
      return grp;
    }
    function listOperators(){
      window.__opIndex = window.__opIndex || {};
      var names = [];
      for (var k in window.__opIndex){
        if(!window.__opIndex[k]) continue;
        // восстановим «красивое» имя из контроллера, если он есть
        var guess = k; // lowercased
        // к ключу не приклеено «оператор:», добавим
        if (!/^оператор:/.test(guess)) guess = 'оператор: ' + guess;
        // нормализуем регистр слова «Оператор»
        guess = 'Оператор: ' + guess.split(':').slice(1).join(':').trim();
        names.push(guess);
      }
      // уникально и по алфавиту
      names = names.filter((v,i,a)=>a.indexOf(v)===i).sort(function(a,b){return a.localeCompare(b);});
      return names;
    }
    function refreshSelect(){
      var q = N(opsSearch.value);
      var names = listOperators();
      opsSelect.innerHTML = '';
      names.forEach(function(n){
        if(q && N(n).indexOf(q)===-1) return;
        var o=document.createElement('option'); o.value=n; o.textContent=n;
        opsSelect.appendChild(o);
      });
    }
    opsSearch.addEventListener('input', refreshSelect);

    function forEachMarkerIn(layer, fn){
      if(!layer) return;
      layer.eachLayer(function(l){ try{ if(l && typeof l.getLatLng==='function'){ fn(l); } }catch(e){} });
    }
    function selectMarkers(arr){ // использовать существующий механизм выделения, если есть
      if (typeof window.bindToMarker === 'function'){
        // здесь нет API для выбора, обойдёмся прямым assign
        return;
      }
    }
    function safeAssignCall(marker, target){
      if (typeof window.safeAssign === 'function'){ window.safeAssign(marker, target); return true; }
      // fallback: прямой перенос без очереди
      var trg = ensureTargetLayer(target); var src=null;
      try{ src = marker.__layer || marker._layer || null; }catch(e){}
      if(src && src.removeLayer) try{ src.removeLayer(marker); }catch(e){}
      if(trg && trg.addLayer) try{ trg.addLayer(marker); }catch(e){}
      // возможное поле для UI
      try{
        marker.feature = marker.feature || {properties:{}};
        marker.feature.properties.operator = target;
      }catch(e){}
      return false;
    }
    function applyNow(){
      // вызовем штатную кнопку, если она есть
      var b = document.getElementById('btnApplyNow'); if(b){ b.click(); return; }
      // либо штатную функцию, если проброшена
      if (typeof window.applyNow === 'function'){ try{ window.applyNow(); }catch(e){} }
    }
    function removeLayerCompletely(name){
      var key=N(name), grp=getLayerByName(name);
      if(!grp) return;
      try{
        var map = findMap(); if(map && map.hasLayer(grp)) map.removeLayer(grp);
      }catch(e){}
      try{ delete window.__opIndex[key]; }catch(e){}
      // убрать из контроллера слоёв (если есть)
      try{
        var labels = document.querySelectorAll('.leaflet-control-layers-overlays label');
        labels.forEach(function(l){
          if (N(l.textContent||'')===N(name)){
            var row = l.closest('div'); if(row && row.parentNode) row.parentNode.removeChild(row);
          }
        });
      }catch(e){}
    }

    function bulkMoveAll(srcName, destName, removeSrc){
      var src = getLayerByName(srcName);
      if(!src){ alert('Слой не найден: '+srcName); return; }
      ensureTargetLayer(destName);
      // переносим каждый маркер через safeAssign (чтобы попал в очередь и применился)
      var count=0;
      forEachMarkerIn(src, function(m){ try{ safeAssignCall(m, destName); count++; }catch(e){} });
      if(count>0) applyNow();
      if(removeSrc) removeLayerCompletely(srcName);
      refreshSelect();
    }

    btnRename.addEventListener('click', function(){
      var from = opsSelect.value;
      var to = (renameTo.value||'').trim();
      if(!from){ alert('Выберите оператора'); return; }
      if(!to){ alert('Укажите новое имя'); return; }
      if(/^без\s+оператора$/i.test(to)){ alert('Нельзя переименовать в «Без оператора». Используйте удаление.'); return; }
      if(!/^оператор\s*:|^Оператор\s*:/.test(to)) to = 'Оператор: ' + to;
      if (N(to)===N(from)){ alert('Имя не изменилось'); return; }
      bulkMoveAll(from, to, true);
      renameTo.value='';
    });

    btnDelete.addEventListener('click', function(){
      var from = opsSelect.value;
      if(!from){ alert('Выберите оператора'); return; }
      if(/без оператора/i.test(from)){ alert('Этот слой удалять нельзя'); return; }
      if(!confirm('Удалить оператора «'+from+'»?\nВсе точки будут перенесены в «Без оператора».')) return;
      bulkMoveAll(from, 'Без оператора', true);
    });

    // первичное наполнение
    refreshSelect();
  });
})();
</script>


<script>
(function(){ 
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  ready(function(){
    function N(s){ return String(s||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').toLowerCase().trim(); }
    // try to ensure the overlay "Переназначенные (видимые)" is visible if it exists
    try{
      var labels=document.querySelectorAll('.leaflet-control-layers-overlays label');
      labels.forEach(function(l){
        var t=(l.textContent||'').trim();
        if(N(t)===N('Переназначенные (видимые)')){
          var cb=l.querySelector('input[type="checkbox"]');
          if(cb && !cb.checked){ cb.click(); }
        }
      });
    }catch(e){}
  });
})();
</script>


<!-- Telegram WebApp integration (v1) -->
<script>
(function(){
  try{
    var tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if(!tg){ console.log('[TG] WebApp not available'); return; }
    tg.expand(); tg.ready();
    // Main button
    tg.MainButton.setText('Экспорт изменений в чат');
    tg.MainButton.show();
    function findMap(){
      for (var k in window){
        try{ var m=window[k]; if(m && m._leaflet_id && typeof m.getCenter==='function' && typeof m.getZoom==='function'){ return m; } }catch(e){}
      }
      return null;
    }
    function buildPayload(){
      var map=findMap(), center=null, zoom=null;
      if(map){ try{ var c=map.getCenter(); center=[c.lat, c.lng]; zoom=map.getZoom(); }catch(e){} }
      var diff = window.__assignLog || window.__movesLog || [];
      return { type:'map-diff', center:center, zoom:zoom, diff:diff, ts:Date.now() };
    }
    tg.onEvent('mainButtonClicked', function(){
      try{
        var payload = buildPayload();
        tg.sendData(JSON.stringify(payload));
        tg.HapticFeedback && tg.HapticFeedback.notificationOccurred && tg.HapticFeedback.notificationOccurred('success');
      }catch(err){
        alert('Не удалось отправить в чат: '+err);
      }
    });
  }catch(e){ console.warn('[TG] init error', e); }
})();
</script>

</body>
        var html = new XMLSerializer().serializeToString(doc);
        html = html.replace('
<!-- v9: Самотест + безопасный "Новый оператор" + мульти‑базовые карты (без ломки существующего) -->
<style>
  /* Минималистичные стили без влияния на твой UI */
  #createOpBar{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0;align-items:center}
  #createOpBar input{padding:6px 8px;border:1px solid #bbb;border-radius:6px;font-size:14px}
  #createOpBar button{padding:6px 10px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  #newOpsBox{margin:6px 0;padding:6px;border:1px dashed #ccc;border-radius:8px}
  #newOpsBox .row{margin:2px 0}
  .toast-mini{position:fixed;right:10px;bottom:10px;background:#222;color:#fff;padding:8px 10px;border-radius:8px;opacity:.92;z-index:10000}
  .basemap-switch{position:absolute;right:10px;top:10px;z-index:1000}
  .basemap-switch button{padding:6px 10px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  .diag-panel{position:fixed;left:10px;bottom:10px;background:#fff;border:1px solid #ccc;border-radius:10px;padding:8px 10px;font:12px/1.2 system-ui, Arial, sans-serif;box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:9999}
  .diag-panel .row{margin:2px 0}
  .diag-panel .ok{color:#2e7d32;font-weight:600}
  .diag-panel .warn{color:#b26a00;font-weight:600}
  .diag-panel .bad{color:#c62828;font-weight:600}
  .diag-panel button{margin-left:8px;padding:3px 8px}
</style>
<script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  function findMap(){
    for (var k in window){
      try{
        var m=window[k];
        if(m && m._leaflet_id && typeof m.addLayer==='function' && typeof m.on==='function'){
          return m;
        }
      }catch(e){}
    }
    return null;
  }
  function getLayersControl(map){
    for (var k in window){
      try{
        var v=window[k];
        if(v && v._map===map && v._layers && typeof v.addOverlay==='function') return v;
      }catch(e){}
    }
    return null;
  }
  function toast(msg){ var t=document.createElement('div'); t.className='toast-mini'; t.textContent=msg; document.body.appendChild(t); setTimeout(function(){ t.remove(); }, 1800); }

  // --- Самотест
  function buildDiag(map){
    if(document.getElementById('diagPanel')) return;
    var p=document.createElement('div'); p.id='diagPanel'; p.className='diag-panel';
    p.innerHTML='<div style="font-weight:700;margin-bottom:4px">Проверка</div>'+
      '<div class="row">Leaflet: <span id="d-leaflet" class="bad">нет</span></div>'+
      '<div class="row">Карта: <span id="d-map" class="bad">нет</span></div>'+
      '<div class="row">Tile слои: <span id="d-tiles" class="warn">0</span></div>'+
      '<div class="row">Маркер/линии: <span id="d-objs" class="warn">0</span></div>'+
      '<div class="row">Контрол слоёв: <span id="d-ctrl" class="warn">нет</span></div>'+
      '<div class="row"><button id="d-retry">Перепроверить</button></div>';
    document.body.appendChild(p);
    function scan(){
      var L=window.L;
      p.querySelector('#d-leaflet').textContent = L ? 'ok' : 'нет';
      p.querySelector('#d-leaflet').className = L ? 'ok' : 'bad';
      var okMap = !!map;
      p.querySelector('#d-map').textContent = okMap ? 'ok' : 'нет';
      p.querySelector('#d-map').className = okMap ? 'ok' : 'bad';
      var tiles=0, objs=0;
      if(map){
        map.eachLayer(function(ly){
          if(ly && (ly._url || typeof ly.getTileUrl==='function')) tiles++;
          else objs++;
        });
      }
      var tilesEl=p.querySelector('#d-tiles');
      tilesEl.textContent = tiles;
      tilesEl.className = tiles>0 ? 'ok' : 'warn';
      var objsEl=p.querySelector('#d-objs');
      objsEl.textContent = objs;
      objsEl.className = objs>0 ? 'ok' : 'warn';
      var ctrl = getLayersControl(map);
      var ctrlEl=p.querySelector('#d-ctrl');
      ctrlEl.textContent = ctrl ? 'да' : 'нет';
      ctrlEl.className = ctrl ? 'ok' : 'warn';
    }
    scan();
    p.querySelector('#d-retry').onclick = scan;
  }

  // --- безопасное добавление UI
  ready(function(){
    var wrap=document.getElementById('opControlWrapper');
    var map=findMap();
    if(map) buildDiag(map);

    if(wrap && !document.getElementById('createOpBar')){
      var bar=document.createElement('div'); bar.id='createOpBar';
      bar.innerHTML='<input id="newOpName" type="text" placeholder="Новый оператор… (например, Иван Петров)">'+
                    '<button id="newOpAdd">Добавить оператора</button>';
      wrap.insertBefore(bar, wrap.firstChild);
      // блок для чекбоксов, если нет L.control.layers
      var box=document.createElement('div'); box.id='newOpsBox';
      box.innerHTML='<div style="font-weight:600;margin-bottom:4px">Новые операторы</div>';
      wrap.insertBefore(box, bar.nextSibling);
    }
    var inp=document.getElementById('newOpName');
    var btn=document.getElementById('newOpAdd');
    var box=document.getElementById('newOpsBox');
    function normalizeName(raw){
      var name=(raw||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim();
      if(!name) return '';
      if(/^без\s+оператора$/i.test(name)) return 'Без оператора';
      if(/^оператор\s*:/i.test(name)) return 'Оператор: '+name.split(':').slice(1).join(':').trim();
      return 'Оператор: '+name;
    }
    function findOperatorSelect(){
      var selects=[].slice.call(document.querySelectorAll('select'));
      for(var i=0;i<selects.length;i++){
        var text=[].map.call(selects[i].options, o=>(o.textContent||o.value||'').toLowerCase()).join('|');
        if(/оператор:|без оператора/.test(text)) return selects[i];
      }
      return null;
    }
    function addOptionToSelect(displayName){
      var sel=findOperatorSelect(); if(!sel) return;
      for(var i=0;i<sel.options.length;i++){
        var t=(sel.options[i].textContent||sel.options[i].value||'').trim();
        if(t===displayName){ sel.selectedIndex=i; return; }
      }
      var o=document.createElement('option'); o.value=displayName; o.textContent=displayName;
      sel.appendChild(o); sel.selectedIndex=sel.options.length-1;
    }
    function addRowToggle(displayName, group){
      var row=document.createElement('div'); row.className='row';
      var id='chk_'+Math.random().toString(36).slice(2);
      row.innerHTML='<label><input type="checkbox" id="'+id+'" checked> '+displayName+'</label>';
      box.appendChild(row);
      var cb=row.querySelector('input');
      cb.addEventListener('change', function(){ if(cb.checked){ group.addTo(map); } else { map.removeLayer(group); } });
    }

    if(btn){
      var ctrl=getLayersControl(map); // ok, может быть null
      window.__opIndex = window.__opIndex || {};
      function createOperator(){
        var displayName=normalizeName(inp.value);
        if(!displayName){ toast('Введите имя оператора'); inp.focus(); return; }
        var key=String(displayName||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').toLowerCase().trim();
        var group=window.__opIndex[key];
        if(!group){
          group=L.featureGroup(); group.addTo(map);
          window.__opIndex[key]=group;
          if (ctrl && typeof ctrl.addOverlay==='function'){
            try{ ctrl.addOverlay(group, displayName); }catch(e){ addRowToggle(displayName, group); }
          } else {
            addRowToggle(displayName, group);
          }
        } else {
          if(!map.hasLayer(group)) group.addTo(map);
        }
        addOptionToSelect(displayName);
        inp.value='';
        toast('Создан оператор: '+displayName.replace(/^Оператор:\s*/,''));
      }
      btn.onclick=function(e){ e.preventDefault(); createOperator(); };
      inp.addEventListener('keydown', function(ev){ if(ev.key==='Enter'){ ev.preventDefault(); createOperator(); }});
    }

    // ---- мульти‑базовые карты (если базового слоя нет)
    if(map && !document.getElementById('basemapSwitchBtn')){
      var hasTiles=false;
      map.eachLayer(function(ly){ if(ly && (ly._url || typeof ly.getTileUrl==='function')) hasTiles=true; });
      var providers=[
        {name:'OSM', url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', opt:{attribution:'© OpenStreetMap', subdomains:'abc', maxZoom:20}},
        {name:'OSM.de', url:'https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', opt:{attribution:'© OpenStreetMap.de', subdomains:'abc', maxZoom:19}},
        {name:'OSM FR', url:'https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', opt:{attribution:'© OpenStreetMap FR', subdomains:'abc', maxZoom:20}},
        {name:'Carto Light', url:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', opt:{attribution:'© Carto', subdomains:'abcd', maxZoom:20}},
        {name:'Carto Dark', url:'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', opt:{attribution:'© Carto', subdomains:'abcd', maxZoom:20}}
      ];
      var idx=0, current=null;
      function switchTo(i){
        if(current){ map.removeLayer(current); }
        idx=i%providers.length; var p=providers[idx];
        current=L.tileLayer(p.url, p.opt).addTo(map);
        btnBM.textContent='Карта: '+p.name;
      }
      var panel=document.createElement('div'); panel.className='basemap-switch';
      var btnBM=document.createElement('button'); btnBM.id='basemapSwitchBtn'; btnBM.textContent='Карта: авто';
      btnBM.onclick=function(e){ e.preventDefault(); switchTo(idx+1); };
      panel.appendChild(btnBM);
      try{ map.getContainer().appendChild(panel); }catch(e){}
      if(!hasTiles){ switchTo(0); }
    }
  });
})();
</script>


<!-- v11: Панель управления операторами: фильтр, переименование, удаление -->
<style>
  #manageOpsBar{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0;align-items:center}
  #manageOpsBar input,#manageOpsBar select{padding:6px 8px;border:1px solid #bbb;border-radius:6px;font-size:14px}
  #manageOpsBar button{padding:6px 10px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  #manageOpsBar .hint{font-size:12px;color:#666;margin-left:4px}
</style>
<script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  function N(s){ return String(s||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').toLowerCase().trim(); }

  ready(function(){
    var wrap = document.getElementById('opControlWrapper');
    if(!wrap || document.getElementById('manageOpsBar')) return;

    // UI
    var bar = document.createElement('div'); bar.id='manageOpsBar';
    bar.innerHTML = ''
      + '<input id="opsSearch" type="text" placeholder="Фильтр операторов…">'
      + '<select id="opsSelect" style="min-width:260px"></select>'
      + '<input id="opsRenameTo" type="text" placeholder="Новое имя">'
      + '<button id="btnOpsRename" title="Перенесёт все точки в оператора с новым именем">Переименовать</button>'
      + '<button id="btnOpsDelete" title="Перенесёт все точки в «Без оператора» и удалит слой">Удалить → Без оператора</button>'
      + '<span class="hint">Действия применяются к выбранному оператору</span>';
    // вставим после блока "Новые операторы"
    var newOpsBox = document.getElementById('newOpsBox');
    if(newOpsBox && newOpsBox.nextSibling){
      wrap.insertBefore(bar, newOpsBox.nextSibling);
    }else{
if(!window.__opIndex){window.__opIndex={}}; if(!window.__opIndex[key]) window.__opIndex[key]=group;

      wrap.insertBefore(bar, wrap.firstChild);
    }

    var opsSearch = document.getElementById('opsSearch');
    var opsSelect = document.getElementById('opsSelect');
    var renameTo  = document.getElementById('opsRenameTo');
    var btnRename = document.getElementById('btnOpsRename');
    var btnDelete = document.getElementById('btnOpsDelete');

    // helpers
    function findMap(){ for(var k in window){ try{ var m=window[k]; if(m && m._leaflet_id && m.addLayer && m.on){ return m; } }catch(e){} } return null; }
    function getLayerByName(name){
      window.__opIndex = window.__opIndex || {};
      var key = N(name);
      return window.__opIndex[key] || null;
    }
    function ensureTargetLayer(name){
      // переиспользуем имеющуюся util если она есть
      if (typeof window.ensureTargetLayer === 'function'){ return window.ensureTargetLayer(name); }
      // fallback: создадим слой и зарегистрируем
      var map = findMap(); if(!map) return null;
      var grp = getLayerByName(name);
      if(!grp){
        grp = L.featureGroup().addTo(map);
        window.__opIndex[N(name)] = grp;
      }
      return grp;
    }
    function listOperators(){
      window.__opIndex = window.__opIndex || {};
      var names = [];
      for (var k in window.__opIndex){
        if(!window.__opIndex[k]) continue;
        // восстановим «красивое» имя из контроллера, если он есть
        var guess = k; // lowercased
        // к ключу не приклеено «оператор:», добавим
        if (!/^оператор:/.test(guess)) guess = 'оператор: ' + guess;
        // нормализуем регистр слова «Оператор»
        guess = 'Оператор: ' + guess.split(':').slice(1).join(':').trim();
        names.push(guess);
      }
      // уникально и по алфавиту
      names = names.filter((v,i,a)=>a.indexOf(v)===i).sort(function(a,b){return a.localeCompare(b);});
      return names;
    }
    function refreshSelect(){
      var q = N(opsSearch.value);
      var names = listOperators();
      opsSelect.innerHTML = '';
      names.forEach(function(n){
        if(q && N(n).indexOf(q)===-1) return;
        var o=document.createElement('option'); o.value=n; o.textContent=n;
        opsSelect.appendChild(o);
      });
    }
    opsSearch.addEventListener('input', refreshSelect);

    function forEachMarkerIn(layer, fn){
      if(!layer) return;
      layer.eachLayer(function(l){ try{ if(l && typeof l.getLatLng==='function'){ fn(l); } }catch(e){} });
    }
    function selectMarkers(arr){ // использовать существующий механизм выделения, если есть
      if (typeof window.bindToMarker === 'function'){
        // здесь нет API для выбора, обойдёмся прямым assign
        return;
      }
    }
    function safeAssignCall(marker, target){
      if (typeof window.safeAssign === 'function'){ window.safeAssign(marker, target); return true; }
      // fallback: прямой перенос без очереди
      var trg = ensureTargetLayer(target); var src=null;
      try{ src = marker.__layer || marker._layer || null; }catch(e){}
      if(src && src.removeLayer) try{ src.removeLayer(marker); }catch(e){}
      if(trg && trg.addLayer) try{ trg.addLayer(marker); }catch(e){}
      // возможное поле для UI
      try{
        marker.feature = marker.feature || {properties:{}};
        marker.feature.properties.operator = target;
      }catch(e){}
      return false;
    }
    function applyNow(){
      // вызовем штатную кнопку, если она есть
      var b = document.getElementById('btnApplyNow'); if(b){ b.click(); return; }
      // либо штатную функцию, если проброшена
      if (typeof window.applyNow === 'function'){ try{ window.applyNow(); }catch(e){} }
    }
    function removeLayerCompletely(name){
      var key=N(name), grp=getLayerByName(name);
      if(!grp) return;
      try{
        var map = findMap(); if(map && map.hasLayer(grp)) map.removeLayer(grp);
      }catch(e){}
      try{ delete window.__opIndex[key]; }catch(e){}
      // убрать из контроллера слоёв (если есть)
      try{
        var labels = document.querySelectorAll('.leaflet-control-layers-overlays label');
        labels.forEach(function(l){
          if (N(l.textContent||'')===N(name)){
            var row = l.closest('div'); if(row && row.parentNode) row.parentNode.removeChild(row);
          }
        });
      }catch(e){}
    }

    function bulkMoveAll(srcName, destName, removeSrc){
      var src = getLayerByName(srcName);
      if(!src){ alert('Слой не найден: '+srcName); return; }
      ensureTargetLayer(destName);
      // переносим каждый маркер через safeAssign (чтобы попал в очередь и применился)
      var count=0;
      forEachMarkerIn(src, function(m){ try{ safeAssignCall(m, destName); count++; }catch(e){} });
      if(count>0) applyNow();
      if(removeSrc) removeLayerCompletely(srcName);
      refreshSelect();
    }

    btnRename.addEventListener('click', function(){
      var from = opsSelect.value;
      var to = (renameTo.value||'').trim();
      if(!from){ alert('Выберите оператора'); return; }
      if(!to){ alert('Укажите новое имя'); return; }
      if(/^без\s+оператора$/i.test(to)){ alert('Нельзя переименовать в «Без оператора». Используйте удаление.'); return; }
      if(!/^оператор\s*:|^Оператор\s*:/.test(to)) to = 'Оператор: ' + to;
      if (N(to)===N(from)){ alert('Имя не изменилось'); return; }
      bulkMoveAll(from, to, true);
      renameTo.value='';
    });

    btnDelete.addEventListener('click', function(){
      var from = opsSelect.value;
      if(!from){ alert('Выберите оператора'); return; }
      if(/без оператора/i.test(from)){ alert('Этот слой удалять нельзя'); return; }
      if(!confirm('Удалить оператора «'+from+'»?\nВсе точки будут перенесены в «Без оператора».')) return;
      bulkMoveAll(from, 'Без оператора', true);
    });

    // первичное наполнение
    refreshSelect();
  });
})();
</script>


<script>
(function(){ 
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  ready(function(){
    function N(s){ return String(s||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').toLowerCase().trim(); }
    // try to ensure the overlay "Переназначенные (видимые)" is visible if it exists
    try{
      var labels=document.querySelectorAll('.leaflet-control-layers-overlays label');
      labels.forEach(function(l){
        var t=(l.textContent||'').trim();
        if(N(t)===N('Переназначенные (видимые)')){
          var cb=l.querySelector('input[type="checkbox"]');
          if(cb && !cb.checked){ cb.click(); }
        }
      });
    }catch(e){}
  });
})();
</script>


<!-- Telegram WebApp integration (v1) -->
<script>
(function(){
  try{
    var tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if(!tg){ console.log('[TG] WebApp not available'); return; }
    tg.expand(); tg.ready();
    // Main button
    tg.MainButton.setText('Экспорт изменений в чат');
    tg.MainButton.show();
    function findMap(){
      for (var k in window){
        try{ var m=window[k]; if(m && m._leaflet_id && typeof m.getCenter==='function' && typeof m.getZoom==='function'){ return m; } }catch(e){}
      }
      return null;
    }
    function buildPayload(){
      var map=findMap(), center=null, zoom=null;
      if(map){ try{ var c=map.getCenter(); center=[c.lat, c.lng]; zoom=map.getZoom(); }catch(e){} }
      var diff = window.__assignLog || window.__movesLog || [];
      return { type:'map-diff', center:center, zoom:zoom, diff:diff, ts:Date.now() };
    }
    tg.onEvent('mainButtonClicked', function(){
      try{
        var payload = buildPayload();
        tg.sendData(JSON.stringify(payload));
        tg.HapticFeedback && tg.HapticFeedback.notificationOccurred && tg.HapticFeedback.notificationOccurred('success');
      }catch(err){
        alert('Не удалось отправить в чат: '+err);
      }
    });
  }catch(e){ console.warn('[TG] init error', e); }
})();
</script>

</body>', bootstrap + '\\n
<!-- v9: Самотест + безопасный "Новый оператор" + мульти‑базовые карты (без ломки существующего) -->
<style>
  /* Минималистичные стили без влияния на твой UI */
  #createOpBar{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0;align-items:center}
  #createOpBar input{padding:6px 8px;border:1px solid #bbb;border-radius:6px;font-size:14px}
  #createOpBar button{padding:6px 10px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  #newOpsBox{margin:6px 0;padding:6px;border:1px dashed #ccc;border-radius:8px}
  #newOpsBox .row{margin:2px 0}
  .toast-mini{position:fixed;right:10px;bottom:10px;background:#222;color:#fff;padding:8px 10px;border-radius:8px;opacity:.92;z-index:10000}
  .basemap-switch{position:absolute;right:10px;top:10px;z-index:1000}
  .basemap-switch button{padding:6px 10px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  .diag-panel{position:fixed;left:10px;bottom:10px;background:#fff;border:1px solid #ccc;border-radius:10px;padding:8px 10px;font:12px/1.2 system-ui, Arial, sans-serif;box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:9999}
  .diag-panel .row{margin:2px 0}
  .diag-panel .ok{color:#2e7d32;font-weight:600}
  .diag-panel .warn{color:#b26a00;font-weight:600}
  .diag-panel .bad{color:#c62828;font-weight:600}
  .diag-panel button{margin-left:8px;padding:3px 8px}
</style>
<script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  function findMap(){
    for (var k in window){
      try{
        var m=window[k];
        if(m && m._leaflet_id && typeof m.addLayer==='function' && typeof m.on==='function'){
          return m;
        }
      }catch(e){}
    }
    return null;
  }
  function getLayersControl(map){
    for (var k in window){
      try{
        var v=window[k];
        if(v && v._map===map && v._layers && typeof v.addOverlay==='function') return v;
      }catch(e){}
    }
    return null;
  }
  function toast(msg){ var t=document.createElement('div'); t.className='toast-mini'; t.textContent=msg; document.body.appendChild(t); setTimeout(function(){ t.remove(); }, 1800); }

  // --- Самотест
  function buildDiag(map){
    if(document.getElementById('diagPanel')) return;
    var p=document.createElement('div'); p.id='diagPanel'; p.className='diag-panel';
    p.innerHTML='<div style="font-weight:700;margin-bottom:4px">Проверка</div>'+
      '<div class="row">Leaflet: <span id="d-leaflet" class="bad">нет</span></div>'+
      '<div class="row">Карта: <span id="d-map" class="bad">нет</span></div>'+
      '<div class="row">Tile слои: <span id="d-tiles" class="warn">0</span></div>'+
      '<div class="row">Маркер/линии: <span id="d-objs" class="warn">0</span></div>'+
      '<div class="row">Контрол слоёв: <span id="d-ctrl" class="warn">нет</span></div>'+
      '<div class="row"><button id="d-retry">Перепроверить</button></div>';
    document.body.appendChild(p);
    function scan(){
      var L=window.L;
      p.querySelector('#d-leaflet').textContent = L ? 'ok' : 'нет';
      p.querySelector('#d-leaflet').className = L ? 'ok' : 'bad';
      var okMap = !!map;
      p.querySelector('#d-map').textContent = okMap ? 'ok' : 'нет';
      p.querySelector('#d-map').className = okMap ? 'ok' : 'bad';
      var tiles=0, objs=0;
      if(map){
        map.eachLayer(function(ly){
          if(ly && (ly._url || typeof ly.getTileUrl==='function')) tiles++;
          else objs++;
        });
      }
      var tilesEl=p.querySelector('#d-tiles');
      tilesEl.textContent = tiles;
      tilesEl.className = tiles>0 ? 'ok' : 'warn';
      var objsEl=p.querySelector('#d-objs');
      objsEl.textContent = objs;
      objsEl.className = objs>0 ? 'ok' : 'warn';
      var ctrl = getLayersControl(map);
      var ctrlEl=p.querySelector('#d-ctrl');
      ctrlEl.textContent = ctrl ? 'да' : 'нет';
      ctrlEl.className = ctrl ? 'ok' : 'warn';
    }
    scan();
    p.querySelector('#d-retry').onclick = scan;
  }

  // --- безопасное добавление UI
  ready(function(){
    var wrap=document.getElementById('opControlWrapper');
    var map=findMap();
    if(map) buildDiag(map);

    if(wrap && !document.getElementById('createOpBar')){
      var bar=document.createElement('div'); bar.id='createOpBar';
      bar.innerHTML='<input id="newOpName" type="text" placeholder="Новый оператор… (например, Иван Петров)">'+
                    '<button id="newOpAdd">Добавить оператора</button>';
      wrap.insertBefore(bar, wrap.firstChild);
      // блок для чекбоксов, если нет L.control.layers
      var box=document.createElement('div'); box.id='newOpsBox';
      box.innerHTML='<div style="font-weight:600;margin-bottom:4px">Новые операторы</div>';
      wrap.insertBefore(box, bar.nextSibling);
    }
    var inp=document.getElementById('newOpName');
    var btn=document.getElementById('newOpAdd');
    var box=document.getElementById('newOpsBox');
    function normalizeName(raw){
      var name=(raw||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim();
      if(!name) return '';
      if(/^без\s+оператора$/i.test(name)) return 'Без оператора';
      if(/^оператор\s*:/i.test(name)) return 'Оператор: '+name.split(':').slice(1).join(':').trim();
      return 'Оператор: '+name;
    }
    function findOperatorSelect(){
      var selects=[].slice.call(document.querySelectorAll('select'));
      for(var i=0;i<selects.length;i++){
        var text=[].map.call(selects[i].options, o=>(o.textContent||o.value||'').toLowerCase()).join('|');
        if(/оператор:|без оператора/.test(text)) return selects[i];
      }
      return null;
    }
    function addOptionToSelect(displayName){
      var sel=findOperatorSelect(); if(!sel) return;
      for(var i=0;i<sel.options.length;i++){
        var t=(sel.options[i].textContent||sel.options[i].value||'').trim();
        if(t===displayName){ sel.selectedIndex=i; return; }
      }
      var o=document.createElement('option'); o.value=displayName; o.textContent=displayName;
      sel.appendChild(o); sel.selectedIndex=sel.options.length-1;
    }
    function addRowToggle(displayName, group){
      var row=document.createElement('div'); row.className='row';
      var id='chk_'+Math.random().toString(36).slice(2);
      row.innerHTML='<label><input type="checkbox" id="'+id+'" checked> '+displayName+'</label>';
      box.appendChild(row);
      var cb=row.querySelector('input');
      cb.addEventListener('change', function(){ if(cb.checked){ group.addTo(map); } else { map.removeLayer(group); } });
    }

    if(btn){
      var ctrl=getLayersControl(map); // ok, может быть null
      window.__opIndex = window.__opIndex || {};
      function createOperator(){
        var displayName=normalizeName(inp.value);
        if(!displayName){ toast('Введите имя оператора'); inp.focus(); return; }
        var key=String(displayName||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').toLowerCase().trim();
        var group=window.__opIndex[key];
        if(!group){
          group=L.featureGroup(); group.addTo(map);
          window.__opIndex[key]=group;
          if (ctrl && typeof ctrl.addOverlay==='function'){
            try{ ctrl.addOverlay(group, displayName); }catch(e){ addRowToggle(displayName, group); }
          } else {
            addRowToggle(displayName, group);
          }
        } else {
          if(!map.hasLayer(group)) group.addTo(map);
        }
        addOptionToSelect(displayName);
        inp.value='';
        toast('Создан оператор: '+displayName.replace(/^Оператор:\s*/,''));
      }
      btn.onclick=function(e){ e.preventDefault(); createOperator(); };
      inp.addEventListener('keydown', function(ev){ if(ev.key==='Enter'){ ev.preventDefault(); createOperator(); }});
    }

    // ---- мульти‑базовые карты (если базового слоя нет)
    if(map && !document.getElementById('basemapSwitchBtn')){
      var hasTiles=false;
      map.eachLayer(function(ly){ if(ly && (ly._url || typeof ly.getTileUrl==='function')) hasTiles=true; });
      var providers=[
        {name:'OSM', url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', opt:{attribution:'© OpenStreetMap', subdomains:'abc', maxZoom:20}},
        {name:'OSM.de', url:'https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', opt:{attribution:'© OpenStreetMap.de', subdomains:'abc', maxZoom:19}},
        {name:'OSM FR', url:'https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', opt:{attribution:'© OpenStreetMap FR', subdomains:'abc', maxZoom:20}},
        {name:'Carto Light', url:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', opt:{attribution:'© Carto', subdomains:'abcd', maxZoom:20}},
        {name:'Carto Dark', url:'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', opt:{attribution:'© Carto', subdomains:'abcd', maxZoom:20}}
      ];
      var idx=0, current=null;
      function switchTo(i){
        if(current){ map.removeLayer(current); }
        idx=i%providers.length; var p=providers[idx];
        current=L.tileLayer(p.url, p.opt).addTo(map);
        btnBM.textContent='Карта: '+p.name;
      }
      var panel=document.createElement('div'); panel.className='basemap-switch';
      var btnBM=document.createElement('button'); btnBM.id='basemapSwitchBtn'; btnBM.textContent='Карта: авто';
      btnBM.onclick=function(e){ e.preventDefault(); switchTo(idx+1); };
      panel.appendChild(btnBM);
      try{ map.getContainer().appendChild(panel); }catch(e){}
      if(!hasTiles){ switchTo(0); }
    }
  });
})();
</script>


<!-- v11: Панель управления операторами: фильтр, переименование, удаление -->
<style>
  #manageOpsBar{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0;align-items:center}
  #manageOpsBar input,#manageOpsBar select{padding:6px 8px;border:1px solid #bbb;border-radius:6px;font-size:14px}
  #manageOpsBar button{padding:6px 10px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  #manageOpsBar .hint{font-size:12px;color:#666;margin-left:4px}
</style>
<script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  function N(s){ return String(s||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').toLowerCase().trim(); }

  ready(function(){
    var wrap = document.getElementById('opControlWrapper');
    if(!wrap || document.getElementById('manageOpsBar')) return;

    // UI
    var bar = document.createElement('div'); bar.id='manageOpsBar';
    bar.innerHTML = ''
      + '<input id="opsSearch" type="text" placeholder="Фильтр операторов…">'
      + '<select id="opsSelect" style="min-width:260px"></select>'
      + '<input id="opsRenameTo" type="text" placeholder="Новое имя">'
      + '<button id="btnOpsRename" title="Перенесёт все точки в оператора с новым именем">Переименовать</button>'
      + '<button id="btnOpsDelete" title="Перенесёт все точки в «Без оператора» и удалит слой">Удалить → Без оператора</button>'
      + '<span class="hint">Действия применяются к выбранному оператору</span>';
    // вставим после блока "Новые операторы"
    var newOpsBox = document.getElementById('newOpsBox');
    if(newOpsBox && newOpsBox.nextSibling){
      wrap.insertBefore(bar, newOpsBox.nextSibling);
    }else{
if(!window.__opIndex){window.__opIndex={}}; if(!window.__opIndex[key]) window.__opIndex[key]=group;

      wrap.insertBefore(bar, wrap.firstChild);
    }

    var opsSearch = document.getElementById('opsSearch');
    var opsSelect = document.getElementById('opsSelect');
    var renameTo  = document.getElementById('opsRenameTo');
    var btnRename = document.getElementById('btnOpsRename');
    var btnDelete = document.getElementById('btnOpsDelete');

    // helpers
    function findMap(){ for(var k in window){ try{ var m=window[k]; if(m && m._leaflet_id && m.addLayer && m.on){ return m; } }catch(e){} } return null; }
    function getLayerByName(name){
      window.__opIndex = window.__opIndex || {};
      var key = N(name);
      return window.__opIndex[key] || null;
    }
    function ensureTargetLayer(name){
      // переиспользуем имеющуюся util если она есть
      if (typeof window.ensureTargetLayer === 'function'){ return window.ensureTargetLayer(name); }
      // fallback: создадим слой и зарегистрируем
      var map = findMap(); if(!map) return null;
      var grp = getLayerByName(name);
      if(!grp){
        grp = L.featureGroup().addTo(map);
        window.__opIndex[N(name)] = grp;
      }
      return grp;
    }
    function listOperators(){
      window.__opIndex = window.__opIndex || {};
      var names = [];
      for (var k in window.__opIndex){
        if(!window.__opIndex[k]) continue;
        // восстановим «красивое» имя из контроллера, если он есть
        var guess = k; // lowercased
        // к ключу не приклеено «оператор:», добавим
        if (!/^оператор:/.test(guess)) guess = 'оператор: ' + guess;
        // нормализуем регистр слова «Оператор»
        guess = 'Оператор: ' + guess.split(':').slice(1).join(':').trim();
        names.push(guess);
      }
      // уникально и по алфавиту
      names = names.filter((v,i,a)=>a.indexOf(v)===i).sort(function(a,b){return a.localeCompare(b);});
      return names;
    }
    function refreshSelect(){
      var q = N(opsSearch.value);
      var names = listOperators();
      opsSelect.innerHTML = '';
      names.forEach(function(n){
        if(q && N(n).indexOf(q)===-1) return;
        var o=document.createElement('option'); o.value=n; o.textContent=n;
        opsSelect.appendChild(o);
      });
    }
    opsSearch.addEventListener('input', refreshSelect);

    function forEachMarkerIn(layer, fn){
      if(!layer) return;
      layer.eachLayer(function(l){ try{ if(l && typeof l.getLatLng==='function'){ fn(l); } }catch(e){} });
    }
    function selectMarkers(arr){ // использовать существующий механизм выделения, если есть
      if (typeof window.bindToMarker === 'function'){
        // здесь нет API для выбора, обойдёмся прямым assign
        return;
      }
    }
    function safeAssignCall(marker, target){
      if (typeof window.safeAssign === 'function'){ window.safeAssign(marker, target); return true; }
      // fallback: прямой перенос без очереди
      var trg = ensureTargetLayer(target); var src=null;
      try{ src = marker.__layer || marker._layer || null; }catch(e){}
      if(src && src.removeLayer) try{ src.removeLayer(marker); }catch(e){}
      if(trg && trg.addLayer) try{ trg.addLayer(marker); }catch(e){}
      // возможное поле для UI
      try{
        marker.feature = marker.feature || {properties:{}};
        marker.feature.properties.operator = target;
      }catch(e){}
      return false;
    }
    function applyNow(){
      // вызовем штатную кнопку, если она есть
      var b = document.getElementById('btnApplyNow'); if(b){ b.click(); return; }
      // либо штатную функцию, если проброшена
      if (typeof window.applyNow === 'function'){ try{ window.applyNow(); }catch(e){} }
    }
    function removeLayerCompletely(name){
      var key=N(name), grp=getLayerByName(name);
      if(!grp) return;
      try{
        var map = findMap(); if(map && map.hasLayer(grp)) map.removeLayer(grp);
      }catch(e){}
      try{ delete window.__opIndex[key]; }catch(e){}
      // убрать из контроллера слоёв (если есть)
      try{
        var labels = document.querySelectorAll('.leaflet-control-layers-overlays label');
        labels.forEach(function(l){
          if (N(l.textContent||'')===N(name)){
            var row = l.closest('div'); if(row && row.parentNode) row.parentNode.removeChild(row);
          }
        });
      }catch(e){}
    }

    function bulkMoveAll(srcName, destName, removeSrc){
      var src = getLayerByName(srcName);
      if(!src){ alert('Слой не найден: '+srcName); return; }
      ensureTargetLayer(destName);
      // переносим каждый маркер через safeAssign (чтобы попал в очередь и применился)
      var count=0;
      forEachMarkerIn(src, function(m){ try{ safeAssignCall(m, destName); count++; }catch(e){} });
      if(count>0) applyNow();
      if(removeSrc) removeLayerCompletely(srcName);
      refreshSelect();
    }

    btnRename.addEventListener('click', function(){
      var from = opsSelect.value;
      var to = (renameTo.value||'').trim();
      if(!from){ alert('Выберите оператора'); return; }
      if(!to){ alert('Укажите новое имя'); return; }
      if(/^без\s+оператора$/i.test(to)){ alert('Нельзя переименовать в «Без оператора». Используйте удаление.'); return; }
      if(!/^оператор\s*:|^Оператор\s*:/.test(to)) to = 'Оператор: ' + to;
      if (N(to)===N(from)){ alert('Имя не изменилось'); return; }
      bulkMoveAll(from, to, true);
      renameTo.value='';
    });

    btnDelete.addEventListener('click', function(){
      var from = opsSelect.value;
      if(!from){ alert('Выберите оператора'); return; }
      if(/без оператора/i.test(from)){ alert('Этот слой удалять нельзя'); return; }
      if(!confirm('Удалить оператора «'+from+'»?\nВсе точки будут перенесены в «Без оператора».')) return;
      bulkMoveAll(from, 'Без оператора', true);
    });

    // первичное наполнение
    refreshSelect();
  });
})();
</script>


<script>
(function(){ 
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  ready(function(){
    function N(s){ return String(s||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').toLowerCase().trim(); }
    // try to ensure the overlay "Переназначенные (видимые)" is visible if it exists
    try{
      var labels=document.querySelectorAll('.leaflet-control-layers-overlays label');
      labels.forEach(function(l){
        var t=(l.textContent||'').trim();
        if(N(t)===N('Переназначенные (видимые)')){
          var cb=l.querySelector('input[type="checkbox"]');
          if(cb && !cb.checked){ cb.click(); }
        }
      });
    }catch(e){}
  });
})();
</script>


<!-- Telegram WebApp integration (v1) -->
<script>
(function(){
  try{
    var tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if(!tg){ console.log('[TG] WebApp not available'); return; }
    tg.expand(); tg.ready();
    // Main button
    tg.MainButton.setText('Экспорт изменений в чат');
    tg.MainButton.show();
    function findMap(){
      for (var k in window){
        try{ var m=window[k]; if(m && m._leaflet_id && typeof m.getCenter==='function' && typeof m.getZoom==='function'){ return m; } }catch(e){}
      }
      return null;
    }
    function buildPayload(){
      var map=findMap(), center=null, zoom=null;
      if(map){ try{ var c=map.getCenter(); center=[c.lat, c.lng]; zoom=map.getZoom(); }catch(e){} }
      var diff = window.__assignLog || window.__movesLog || [];
      return { type:'map-diff', center:center, zoom:zoom, diff:diff, ts:Date.now() };
    }
    tg.onEvent('mainButtonClicked', function(){
      try{
        var payload = buildPayload();
        tg.sendData(JSON.stringify(payload));
        tg.HapticFeedback && tg.HapticFeedback.notificationOccurred && tg.HapticFeedback.notificationOccurred('success');
      }catch(err){
        alert('Не удалось отправить в чат: '+err);
      }
    });
  }catch(e){ console.warn('[TG] init error', e); }
})();
</script>

</body>');

        // 5) download
        var url = URL.createObjectURL(new Blob([html], {type:'text/html;charset=utf-8;'}));
        var a = document.createElement('a');
        a.href = url;
        a.download = 'operators_map_with_changes.html';
        document.body.appendChild(a);
        a.click();
        setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); }, 500);
      }catch(err){
        alert('Не удалось сохранить: ' + err);
      }
    });
  });
})();
</script>

<!-- v40b: ensure base tile layer exists -->
<script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  ready(function(){
    var Lmap=null; 
    for (var k in window){ try{ if(k.startsWith('map_') && window[k] && typeof window[k].eachLayer==='function'){ Lmap=window[k]; break; } }catch(e){} }
    if(!Lmap || !window.L) return;
    var hasTiles=false;
    Lmap.eachLayer(function(ly){ try{ if (ly instanceof L.TileLayer) hasTiles=true; }catch(e){} });
    if(!hasTiles){
      var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(Lmap);
      // try add to layer control if exists
      for (var k in window){
        var v=window[k];
        try{ if (v && v._layers && v._map===Lmap && typeof v.addBaseLayer==='function'){ v.addBaseLayer(osm, 'OSM'); break; } }catch(e){}
      }
    }
    setTimeout(function(){ try{ Lmap.invalidateSize(); }catch(e){} }, 200);
  });
})();
</script>

<!-- v9: Самотест + безопасный "Новый оператор" + мульти‑базовые карты (без ломки существующего) -->
<style>
  /* Минималистичные стили без влияния на твой UI */
  #createOpBar{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0;align-items:center}
  #createOpBar input{padding:6px 8px;border:1px solid #bbb;border-radius:6px;font-size:14px}
  #createOpBar button{padding:6px 10px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  #newOpsBox{margin:6px 0;padding:6px;border:1px dashed #ccc;border-radius:8px}
  #newOpsBox .row{margin:2px 0}
  .toast-mini{position:fixed;right:10px;bottom:10px;background:#222;color:#fff;padding:8px 10px;border-radius:8px;opacity:.92;z-index:10000}
  .basemap-switch{position:absolute;right:10px;top:10px;z-index:1000}
  .basemap-switch button{padding:6px 10px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  .diag-panel{position:fixed;left:10px;bottom:10px;background:#fff;border:1px solid #ccc;border-radius:10px;padding:8px 10px;font:12px/1.2 system-ui, Arial, sans-serif;box-shadow:0 4px 12px rgba(0,0,0,.1);z-index:9999}
  .diag-panel .row{margin:2px 0}
  .diag-panel .ok{color:#2e7d32;font-weight:600}
  .diag-panel .warn{color:#b26a00;font-weight:600}
  .diag-panel .bad{color:#c62828;font-weight:600}
  .diag-panel button{margin-left:8px;padding:3px 8px}
</style>
<script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  function findMap(){
    for (var k in window){
      try{
        var m=window[k];
        if(m && m._leaflet_id && typeof m.addLayer==='function' && typeof m.on==='function'){
          return m;
        }
      }catch(e){}
    }
    return null;
  }
  function getLayersControl(map){
    for (var k in window){
      try{
        var v=window[k];
        if(v && v._map===map && v._layers && typeof v.addOverlay==='function') return v;
      }catch(e){}
    }
    return null;
  }
  function toast(msg){ var t=document.createElement('div'); t.className='toast-mini'; t.textContent=msg; document.body.appendChild(t); setTimeout(function(){ t.remove(); }, 1800); }

  // --- Самотест
  function buildDiag(map){
    if(document.getElementById('diagPanel')) return;
    var p=document.createElement('div'); p.id='diagPanel'; p.className='diag-panel';
    p.innerHTML='<div style="font-weight:700;margin-bottom:4px">Проверка</div>'+
      '<div class="row">Leaflet: <span id="d-leaflet" class="bad">нет</span></div>'+
      '<div class="row">Карта: <span id="d-map" class="bad">нет</span></div>'+
      '<div class="row">Tile слои: <span id="d-tiles" class="warn">0</span></div>'+
      '<div class="row">Маркер/линии: <span id="d-objs" class="warn">0</span></div>'+
      '<div class="row">Контрол слоёв: <span id="d-ctrl" class="warn">нет</span></div>'+
      '<div class="row"><button id="d-retry">Перепроверить</button></div>';
    document.body.appendChild(p);
    function scan(){
      var L=window.L;
      p.querySelector('#d-leaflet').textContent = L ? 'ok' : 'нет';
      p.querySelector('#d-leaflet').className = L ? 'ok' : 'bad';
      var okMap = !!map;
      p.querySelector('#d-map').textContent = okMap ? 'ok' : 'нет';
      p.querySelector('#d-map').className = okMap ? 'ok' : 'bad';
      var tiles=0, objs=0;
      if(map){
        map.eachLayer(function(ly){
          if(ly && (ly._url || typeof ly.getTileUrl==='function')) tiles++;
          else objs++;
        });
      }
      var tilesEl=p.querySelector('#d-tiles');
      tilesEl.textContent = tiles;
      tilesEl.className = tiles>0 ? 'ok' : 'warn';
      var objsEl=p.querySelector('#d-objs');
      objsEl.textContent = objs;
      objsEl.className = objs>0 ? 'ok' : 'warn';
      var ctrl = getLayersControl(map);
      var ctrlEl=p.querySelector('#d-ctrl');
      ctrlEl.textContent = ctrl ? 'да' : 'нет';
      ctrlEl.className = ctrl ? 'ok' : 'warn';
    }
    scan();
    p.querySelector('#d-retry').onclick = scan;
  }

  // --- безопасное добавление UI
  ready(function(){
    var wrap=document.getElementById('opControlWrapper');
    var map=findMap();
    if(map) buildDiag(map);

    if(wrap && !document.getElementById('createOpBar')){
      var bar=document.createElement('div'); bar.id='createOpBar';
      bar.innerHTML='<input id="newOpName" type="text" placeholder="Новый оператор… (например, Иван Петров)">'+
                    '<button id="newOpAdd">Добавить оператора</button>';
      wrap.insertBefore(bar, wrap.firstChild);
      // блок для чекбоксов, если нет L.control.layers
      var box=document.createElement('div'); box.id='newOpsBox';
      box.innerHTML='<div style="font-weight:600;margin-bottom:4px">Новые операторы</div>';
      wrap.insertBefore(box, bar.nextSibling);
    }
    var inp=document.getElementById('newOpName');
    var btn=document.getElementById('newOpAdd');
    var box=document.getElementById('newOpsBox');
    function normalizeName(raw){
      var name=(raw||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').trim();
      if(!name) return '';
      if(/^без\s+оператора$/i.test(name)) return 'Без оператора';
      if(/^оператор\s*:/i.test(name)) return 'Оператор: '+name.split(':').slice(1).join(':').trim();
      return 'Оператор: '+name;
    }
    function findOperatorSelect(){
      var selects=[].slice.call(document.querySelectorAll('select'));
      for(var i=0;i<selects.length;i++){
        var text=[].map.call(selects[i].options, o=>(o.textContent||o.value||'').toLowerCase()).join('|');
        if(/оператор:|без оператора/.test(text)) return selects[i];
      }
      return null;
    }
    function addOptionToSelect(displayName){
      var sel=findOperatorSelect(); if(!sel) return;
      for(var i=0;i<sel.options.length;i++){
        var t=(sel.options[i].textContent||sel.options[i].value||'').trim();
        if(t===displayName){ sel.selectedIndex=i; return; }
      }
      var o=document.createElement('option'); o.value=displayName; o.textContent=displayName;
      sel.appendChild(o); sel.selectedIndex=sel.options.length-1;
    }
    function addRowToggle(displayName, group){
      var row=document.createElement('div'); row.className='row';
      var id='chk_'+Math.random().toString(36).slice(2);
      row.innerHTML='<label><input type="checkbox" id="'+id+'" checked> '+displayName+'</label>';
      box.appendChild(row);
      var cb=row.querySelector('input');
      cb.addEventListener('change', function(){ if(cb.checked){ group.addTo(map); } else { map.removeLayer(group); } });
    }

    if(btn){
      var ctrl=getLayersControl(map); // ok, может быть null
      window.__opIndex = window.__opIndex || {};
      function createOperator(){
        var displayName=normalizeName(inp.value);
        if(!displayName){ toast('Введите имя оператора'); inp.focus(); return; }
        var key=String(displayName||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').toLowerCase().trim();
        var group=window.__opIndex[key];
        if(!group){
          group=L.featureGroup(); group.addTo(map);
          window.__opIndex[key]=group;
          if (ctrl && typeof ctrl.addOverlay==='function'){
            try{ ctrl.addOverlay(group, displayName); }catch(e){ addRowToggle(displayName, group); }
          } else {
            addRowToggle(displayName, group);
          }
        } else {
          if(!map.hasLayer(group)) group.addTo(map);
        }
        addOptionToSelect(displayName);
        inp.value='';
        toast('Создан оператор: '+displayName.replace(/^Оператор:\s*/,''));
      }
      btn.onclick=function(e){ e.preventDefault(); createOperator(); };
      inp.addEventListener('keydown', function(ev){ if(ev.key==='Enter'){ ev.preventDefault(); createOperator(); }});
    }

    // ---- мульти‑базовые карты (если базового слоя нет)
    if(map && !document.getElementById('basemapSwitchBtn')){
      var hasTiles=false;
      map.eachLayer(function(ly){ if(ly && (ly._url || typeof ly.getTileUrl==='function')) hasTiles=true; });
      var providers=[
        {name:'OSM', url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', opt:{attribution:'© OpenStreetMap', subdomains:'abc', maxZoom:20}},
        {name:'OSM.de', url:'https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', opt:{attribution:'© OpenStreetMap.de', subdomains:'abc', maxZoom:19}},
        {name:'OSM FR', url:'https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', opt:{attribution:'© OpenStreetMap FR', subdomains:'abc', maxZoom:20}},
        {name:'Carto Light', url:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', opt:{attribution:'© Carto', subdomains:'abcd', maxZoom:20}},
        {name:'Carto Dark', url:'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', opt:{attribution:'© Carto', subdomains:'abcd', maxZoom:20}}
      ];
      var idx=0, current=null;
      function switchTo(i){
        if(current){ map.removeLayer(current); }
        idx=i%providers.length; var p=providers[idx];
        current=L.tileLayer(p.url, p.opt).addTo(map);
        btnBM.textContent='Карта: '+p.name;
      }
      var panel=document.createElement('div'); panel.className='basemap-switch';
      var btnBM=document.createElement('button'); btnBM.id='basemapSwitchBtn'; btnBM.textContent='Карта: авто';
      btnBM.onclick=function(e){ e.preventDefault(); switchTo(idx+1); };
      panel.appendChild(btnBM);
      try{ map.getContainer().appendChild(panel); }catch(e){}
      if(!hasTiles){ switchTo(0); }
    }
  });
})();
</script>


<!-- v11: Панель управления операторами: фильтр, переименование, удаление -->
<style>
  #manageOpsBar{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0;align-items:center}
  #manageOpsBar input,#manageOpsBar select{padding:6px 8px;border:1px solid #bbb;border-radius:6px;font-size:14px}
  #manageOpsBar button{padding:6px 10px;border:1px solid #bbb;border-radius:8px;background:#fff;cursor:pointer;font-size:12px}
  #manageOpsBar .hint{font-size:12px;color:#666;margin-left:4px}
</style>
<script>
(function(){
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  function N(s){ return String(s||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').toLowerCase().trim(); }

  ready(function(){
    var wrap = document.getElementById('opControlWrapper');
    if(!wrap || document.getElementById('manageOpsBar')) return;

    // UI
    var bar = document.createElement('div'); bar.id='manageOpsBar';
    bar.innerHTML = ''
      + '<input id="opsSearch" type="text" placeholder="Фильтр операторов…">'
      + '<select id="opsSelect" style="min-width:260px"></select>'
      + '<input id="opsRenameTo" type="text" placeholder="Новое имя">'
      + '<button id="btnOpsRename" title="Перенесёт все точки в оператора с новым именем">Переименовать</button>'
      + '<button id="btnOpsDelete" title="Перенесёт все точки в «Без оператора» и удалит слой">Удалить → Без оператора</button>'
      + '<span class="hint">Действия применяются к выбранному оператору</span>';
    // вставим после блока "Новые операторы"
    var newOpsBox = document.getElementById('newOpsBox');
    if(newOpsBox && newOpsBox.nextSibling){
      wrap.insertBefore(bar, newOpsBox.nextSibling);
    }else{
if(!window.__opIndex){window.__opIndex={}}; if(!window.__opIndex[key]) window.__opIndex[key]=group;

      wrap.insertBefore(bar, wrap.firstChild);
    }

    var opsSearch = document.getElementById('opsSearch');
    var opsSelect = document.getElementById('opsSelect');
    var renameTo  = document.getElementById('opsRenameTo');
    var btnRename = document.getElementById('btnOpsRename');
    var btnDelete = document.getElementById('btnOpsDelete');

    // helpers
    function findMap(){ for(var k in window){ try{ var m=window[k]; if(m && m._leaflet_id && m.addLayer && m.on){ return m; } }catch(e){} } return null; }
    function getLayerByName(name){
      window.__opIndex = window.__opIndex || {};
      var key = N(name);
      return window.__opIndex[key] || null;
    }
    function ensureTargetLayer(name){
      // переиспользуем имеющуюся util если она есть
      if (typeof window.ensureTargetLayer === 'function'){ return window.ensureTargetLayer(name); }
      // fallback: создадим слой и зарегистрируем
      var map = findMap(); if(!map) return null;
      var grp = getLayerByName(name);
      if(!grp){
        grp = L.featureGroup().addTo(map);
        window.__opIndex[N(name)] = grp;
      }
      return grp;
    }
    function listOperators(){
      window.__opIndex = window.__opIndex || {};
      var names = [];
      for (var k in window.__opIndex){
        if(!window.__opIndex[k]) continue;
        // восстановим «красивое» имя из контроллера, если он есть
        var guess = k; // lowercased
        // к ключу не приклеено «оператор:», добавим
        if (!/^оператор:/.test(guess)) guess = 'оператор: ' + guess;
        // нормализуем регистр слова «Оператор»
        guess = 'Оператор: ' + guess.split(':').slice(1).join(':').trim();
        names.push(guess);
      }
      // уникально и по алфавиту
      names = names.filter((v,i,a)=>a.indexOf(v)===i).sort(function(a,b){return a.localeCompare(b);});
      return names;
    }
    function refreshSelect(){
      var q = N(opsSearch.value);
      var names = listOperators();
      opsSelect.innerHTML = '';
      names.forEach(function(n){
        if(q && N(n).indexOf(q)===-1) return;
        var o=document.createElement('option'); o.value=n; o.textContent=n;
        opsSelect.appendChild(o);
      });
    }
    opsSearch.addEventListener('input', refreshSelect);

    function forEachMarkerIn(layer, fn){
      if(!layer) return;
      layer.eachLayer(function(l){ try{ if(l && typeof l.getLatLng==='function'){ fn(l); } }catch(e){} });
    }
    function selectMarkers(arr){ // использовать существующий механизм выделения, если есть
      if (typeof window.bindToMarker === 'function'){
        // здесь нет API для выбора, обойдёмся прямым assign
        return;
      }
    }
    function safeAssignCall(marker, target){
      if (typeof window.safeAssign === 'function'){ window.safeAssign(marker, target); return true; }
      // fallback: прямой перенос без очереди
      var trg = ensureTargetLayer(target); var src=null;
      try{ src = marker.__layer || marker._layer || null; }catch(e){}
      if(src && src.removeLayer) try{ src.removeLayer(marker); }catch(e){}
      if(trg && trg.addLayer) try{ trg.addLayer(marker); }catch(e){}
      // возможное поле для UI
      try{
        marker.feature = marker.feature || {properties:{}};
        marker.feature.properties.operator = target;
      }catch(e){}
      return false;
    }
    function applyNow(){
      // вызовем штатную кнопку, если она есть
      var b = document.getElementById('btnApplyNow'); if(b){ b.click(); return; }
      // либо штатную функцию, если проброшена
      if (typeof window.applyNow === 'function'){ try{ window.applyNow(); }catch(e){} }
    }
    function removeLayerCompletely(name){
      var key=N(name), grp=getLayerByName(name);
      if(!grp) return;
      try{
        var map = findMap(); if(map && map.hasLayer(grp)) map.removeLayer(grp);
      }catch(e){}
      try{ delete window.__opIndex[key]; }catch(e){}
      // убрать из контроллера слоёв (если есть)
      try{
        var labels = document.querySelectorAll('.leaflet-control-layers-overlays label');
        labels.forEach(function(l){
          if (N(l.textContent||'')===N(name)){
            var row = l.closest('div'); if(row && row.parentNode) row.parentNode.removeChild(row);
          }
        });
      }catch(e){}
    }

    function bulkMoveAll(srcName, destName, removeSrc){
      var src = getLayerByName(srcName);
      if(!src){ alert('Слой не найден: '+srcName); return; }
      ensureTargetLayer(destName);
      // переносим каждый маркер через safeAssign (чтобы попал в очередь и применился)
      var count=0;
      forEachMarkerIn(src, function(m){ try{ safeAssignCall(m, destName); count++; }catch(e){} });
      if(count>0) applyNow();
      if(removeSrc) removeLayerCompletely(srcName);
      refreshSelect();
    }

    btnRename.addEventListener('click', function(){
      var from = opsSelect.value;
      var to = (renameTo.value||'').trim();
      if(!from){ alert('Выберите оператора'); return; }
      if(!to){ alert('Укажите новое имя'); return; }
      if(/^без\s+оператора$/i.test(to)){ alert('Нельзя переименовать в «Без оператора». Используйте удаление.'); return; }
      if(!/^оператор\s*:|^Оператор\s*:/.test(to)) to = 'Оператор: ' + to;
      if (N(to)===N(from)){ alert('Имя не изменилось'); return; }
      bulkMoveAll(from, to, true);
      renameTo.value='';
    });

    btnDelete.addEventListener('click', function(){
      var from = opsSelect.value;
      if(!from){ alert('Выберите оператора'); return; }
      if(/без оператора/i.test(from)){ alert('Этот слой удалять нельзя'); return; }
      if(!confirm('Удалить оператора «'+from+'»?\nВсе точки будут перенесены в «Без оператора».')) return;
      bulkMoveAll(from, 'Без оператора', true);
    });

    // первичное наполнение
    refreshSelect();
  });
})();
</script>


<script>
(function(){ 
  function ready(fn){ if(document.readyState!='loading'){ fn(); } else { document.addEventListener('DOMContentLoaded', fn); } }
  ready(function(){
    function N(s){ return String(s||'').replace(/\u00A0/g,' ').replace(/\s+/g,' ').toLowerCase().trim(); }
    // try to ensure the overlay "Переназначенные (видимые)" is visible if it exists
    try{
      var labels=document.querySelectorAll('.leaflet-control-layers-overlays label');
      labels.forEach(function(l){
        var t=(l.textContent||'').trim();
        if(N(t)===N('Переназначенные (видимые)')){
          var cb=l.querySelector('input[type="checkbox"]');
          if(cb && !cb.checked){ cb.click(); }
        }
      });
    }catch(e){}
  });
})();
</script>


<!-- Telegram WebApp integration (v1) -->
<script>
(function(){
  try{
    var tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
    if(!tg){ console.log('[TG] WebApp not available'); return; }
    tg.expand(); tg.ready();
    // Main button
    tg.MainButton.setText('Экспорт изменений в чат');
    tg.MainButton.show();
    function findMap(){
      for (var k in window){
        try{ var m=window[k]; if(m && m._leaflet_id && typeof m.getCenter==='function' && typeof m.getZoom==='function'){ return m; } }catch(e){}
      }
      return null;
    }
    function buildPayload(){
      var map=findMap(), center=null, zoom=null;
      if(map){ try{ var c=map.getCenter(); center=[c.lat, c.lng]; zoom=map.getZoom(); }catch(e){} }
      var diff = window.__assignLog || window.__movesLog || [];
      return { type:'map-diff', center:center, zoom:zoom, diff:diff, ts:Date.now() };
    }
    tg.onEvent('mainButtonClicked', function(){
      try{
        var payload = buildPayload();
        tg.sendData(JSON.stringify(payload));
        tg.HapticFeedback && tg.HapticFeedback.notificationOccurred && tg.HapticFeedback.notificationOccurred('success');
      }catch(err){
        alert('Не удалось отправить в чат: '+err);
      }
    });
  }catch(e){ console.warn('[TG] init error', e); }
})();
</script>

</body> и сохраним
      var html = document.documentElement.outerHTML.replace('', bootstrap + '\\n');
      var url = URL.createObjectURL(new Blob([html], {type:'text/html;charset=utf-8;'}));
      var a = document.createElement('a'); a.href = url; a.download = 'operators_map_with_changes.html'; document.body.appendChild(a); a.click(); setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); }, 500);
    });
  });
})();

<script>
    
    
            var map_07240632b07852a755665ada692280cf = L.map(
                "map_07240632b07852a755665ada692280cf",
                {
                    center: [55.741140671428575, 37.514380428571435],
                    crs: L.CRS.EPSG3857,
                    zoom: 9,
                    zoomControl: true,
                    preferCanvas: false,
                }
            );

            

        
    
            var tile_layer_6e898b4075cd2e7676d2c2eca9a39422 = L.tileLayer(
                "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                {"attribution": "Data by \u0026copy; \u003ca href=\"http://openstreetmap.org\"\u003eOpenStreetMap\u003c/a\u003e, under \u003ca href=\"http://www.openstreetmap.org/copyright\"\u003eODbL\u003c/a\u003e.", "detectRetina": false, "maxNativeZoom": 18, "maxZoom": 18, "minZoom": 0, "noWrap": false, "opacity": 1, "subdomains": "abc", "tms": false}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var feature_group_6511f606fd47dcbae96b7341165e6072 = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_6635f93f4a457b265f4a30a42ad8edca = L.circleMarker(
                [55.776132, 37.655356],
                {"bubblingMouseEvents": true, "color": "#a375a0", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#a375a0", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_6511f606fd47dcbae96b7341165e6072);
        
    
        var popup_8f1e35a08d8f63f8a8d57774e531d706 = L.popup({"maxWidth": 360});

        
            var html_ae2bf6112d0595c91bf18a3a38af7ca4 = $(`<div id="html_ae2bf6112d0595c91bf18a3a38af7ca4" style="width: 100.0%; height: 100.0%;"><b>Казанский</b><br>Оператор: Алиев Айрат<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 19380.0<br>Автоматов на локации: 9</div>`)[0];
            popup_8f1e35a08d8f63f8a8d57774e531d706.setContent(html_ae2bf6112d0595c91bf18a3a38af7ca4);
        

        circle_marker_6635f93f4a457b265f4a30a42ad8edca.bindPopup(popup_8f1e35a08d8f63f8a8d57774e531d706)
        ;

        
    
    
            circle_marker_6635f93f4a457b265f4a30a42ad8edca.bindTooltip(
                `<div>
                     Казанский
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_0f38a76460ed4654f7f0566b018cc394 = L.circleMarker(
                [55.785296, 37.673699],
                {"bubblingMouseEvents": true, "color": "#a375a0", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#a375a0", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_6511f606fd47dcbae96b7341165e6072);
        
    
        var popup_4a937fca4d6acbe7c849ade51549ca40 = L.popup({"maxWidth": 360});

        
            var html_948c9ed57042f9b03175b101ecb02c4d = $(`<div id="html_948c9ed57042f9b03175b101ecb02c4d" style="width: 100.0%; height: 100.0%;"><b>Митьково</b><br>Оператор: Алиев Айрат<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 7366.19<br>Автоматов на локации: 2</div>`)[0];
            popup_4a937fca4d6acbe7c849ade51549ca40.setContent(html_948c9ed57042f9b03175b101ecb02c4d);
        

        circle_marker_0f38a76460ed4654f7f0566b018cc394.bindPopup(popup_4a937fca4d6acbe7c849ade51549ca40)
        ;

        
    
    
            circle_marker_0f38a76460ed4654f7f0566b018cc394.bindTooltip(
                `<div>
                     Митьково
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_6d456887ed388438edae8b7dbef889c9 = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_3f9cf6f722b4ad4f6d54da51efb85527 = L.circleMarker(
                [55.758666, 37.664545],
                {"bubblingMouseEvents": true, "color": "#66936c", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#66936c", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_6d456887ed388438edae8b7dbef889c9);
        
    
        var popup_13a822c1c10061f78124cb7100a10ae7 = L.popup({"maxWidth": 360});

        
            var html_006f32b45ab916d60daebb2398e4496d = $(`<div id="html_006f32b45ab916d60daebb2398e4496d" style="width: 100.0%; height: 100.0%;"><b>банк</b><br>Оператор: Алиев Руслан<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 1469.0<br>Автоматов на локации: 1</div>`)[0];
            popup_13a822c1c10061f78124cb7100a10ae7.setContent(html_006f32b45ab916d60daebb2398e4496d);
        

        circle_marker_3f9cf6f722b4ad4f6d54da51efb85527.bindPopup(popup_13a822c1c10061f78124cb7100a10ae7)
        ;

        
    
    
            circle_marker_3f9cf6f722b4ad4f6d54da51efb85527.bindTooltip(
                `<div>
                     банк
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_557b5e70d013d8e76e6b53b90f4e580f = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_f1616f02954bf30a765b1e913d2ad075 = L.circleMarker(
                [55.776186, 37.581188],
                {"bubblingMouseEvents": true, "color": "#6a8989", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#6a8989", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_557b5e70d013d8e76e6b53b90f4e580f);
        
    
        var popup_be93a368e182df6a700151afc427a204 = L.popup({"maxWidth": 360});

        
            var html_66686c103866976f1f737ce883a2a550 = $(`<div id="html_66686c103866976f1f737ce883a2a550" style="width: 100.0%; height: 100.0%;"><b>Белорусский</b><br>Оператор: Аминов Руслан<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 37668.84<br>Автоматов на локации: 17</div>`)[0];
            popup_be93a368e182df6a700151afc427a204.setContent(html_66686c103866976f1f737ce883a2a550);
        

        circle_marker_f1616f02954bf30a765b1e913d2ad075.bindPopup(popup_be93a368e182df6a700151afc427a204)
        ;

        
    
    
            circle_marker_f1616f02954bf30a765b1e913d2ad075.bindTooltip(
                `<div>
                     Белорусский
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_cdfbf9257d94b81fae07c8c22c4e3085 = L.circleMarker(
                [55.743117, 37.566064],
                {"bubblingMouseEvents": true, "color": "#6a8989", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#6a8989", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_557b5e70d013d8e76e6b53b90f4e580f);
        
    
        var popup_3f4cf31e2309328a22ab37bef2703a8e = L.popup({"maxWidth": 360});

        
            var html_f0033520b85bf49262317cad1f21464e = $(`<div id="html_f0033520b85bf49262317cad1f21464e" style="width: 100.0%; height: 100.0%;"><b>Киевский</b><br>Оператор: Аминов Руслан<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 65958.0<br>Автоматов на локации: 13</div>`)[0];
            popup_3f4cf31e2309328a22ab37bef2703a8e.setContent(html_f0033520b85bf49262317cad1f21464e);
        

        circle_marker_cdfbf9257d94b81fae07c8c22c4e3085.bindPopup(popup_3f4cf31e2309328a22ab37bef2703a8e)
        ;

        
    
    
            circle_marker_cdfbf9257d94b81fae07c8c22c4e3085.bindTooltip(
                `<div>
                     Киевский
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_938f45d288e802706bc979a1b1ff0a71 = L.circleMarker(
                [55.760742, 37.66194],
                {"bubblingMouseEvents": true, "color": "#6a8989", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#6a8989", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_557b5e70d013d8e76e6b53b90f4e580f);
        
    
        var popup_3fe97fba116b54d94f652b2cf59362c0 = L.popup({"maxWidth": 360});

        
            var html_d77ad773d23c79f6f804236cd7777de2 = $(`<div id="html_d77ad773d23c79f6f804236cd7777de2" style="width: 100.0%; height: 100.0%;"><b>Курская</b><br>Оператор: Аминов Руслан<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 2096.15<br>Автоматов на локации: 1</div>`)[0];
            popup_3fe97fba116b54d94f652b2cf59362c0.setContent(html_d77ad773d23c79f6f804236cd7777de2);
        

        circle_marker_938f45d288e802706bc979a1b1ff0a71.bindPopup(popup_3fe97fba116b54d94f652b2cf59362c0)
        ;

        
    
    
            circle_marker_938f45d288e802706bc979a1b1ff0a71.bindTooltip(
                `<div>
                     Курская
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_e9f3aebe8cb353f0fd4abce6ddb3fd4d = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_41dd9f3f691f885e776229808b1a857e = L.circleMarker(
                [55.649761, 37.701619],
                {"bubblingMouseEvents": true, "color": "#1e2a78", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#1e2a78", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_e9f3aebe8cb353f0fd4abce6ddb3fd4d);
        
    
        var popup_2188a9113290e538ea5611b27d48a121 = L.popup({"maxWidth": 360});

        
            var html_a71f8fe6024d736c81e9294434f5dc2c = $(`<div id="html_a71f8fe6024d736c81e9294434f5dc2c" style="width: 100.0%; height: 100.0%;"><b>Курьяново</b><br>Оператор: Богданов Данил<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 10346.16<br>Автоматов на локации: 7</div>`)[0];
            popup_2188a9113290e538ea5611b27d48a121.setContent(html_a71f8fe6024d736c81e9294434f5dc2c);
        

        circle_marker_41dd9f3f691f885e776229808b1a857e.bindPopup(popup_2188a9113290e538ea5611b27d48a121)
        ;

        
    
    
            circle_marker_41dd9f3f691f885e776229808b1a857e.bindTooltip(
                `<div>
                     Курьяново
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_79aee373aea4b8e46e110d3ebebfc051 = L.circleMarker(
                [55.648151, 37.65226],
                {"bubblingMouseEvents": true, "color": "#1e2a78", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#1e2a78", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_e9f3aebe8cb353f0fd4abce6ddb3fd4d);
        
    
        var popup_242cb826c13e7ab916bf00b40da4dcfa = L.popup({"maxWidth": 360});

        
            var html_e2e37e2526c416b7c470cf77f217dad6 = $(`<div id="html_e2e37e2526c416b7c470cf77f217dad6" style="width: 100.0%; height: 100.0%;"><b>Лицей</b><br>Оператор: Богданов Данил<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 384.0<br>Автоматов на локации: 1</div>`)[0];
            popup_242cb826c13e7ab916bf00b40da4dcfa.setContent(html_e2e37e2526c416b7c470cf77f217dad6);
        

        circle_marker_79aee373aea4b8e46e110d3ebebfc051.bindPopup(popup_242cb826c13e7ab916bf00b40da4dcfa)
        ;

        
    
    
            circle_marker_79aee373aea4b8e46e110d3ebebfc051.bindTooltip(
                `<div>
                     Лицей
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_3211a01c4e2f4ac3f19c15b360ca8e06 = L.circleMarker(
                [55.486264, 37.55523],
                {"bubblingMouseEvents": true, "color": "#1e2a78", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#1e2a78", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_e9f3aebe8cb353f0fd4abce6ddb3fd4d);
        
    
        var popup_58c2a505e491c01c6453834262fb2ea1 = L.popup({"maxWidth": 360});

        
            var html_f79d3b52e3af16ea6913093722f90c8c = $(`<div id="html_f79d3b52e3af16ea6913093722f90c8c" style="width: 100.0%; height: 100.0%;"><b>Остафьево</b><br>Оператор: Богданов Данил<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 18326.65<br>Автоматов на локации: 7</div>`)[0];
            popup_58c2a505e491c01c6453834262fb2ea1.setContent(html_f79d3b52e3af16ea6913093722f90c8c);
        

        circle_marker_3211a01c4e2f4ac3f19c15b360ca8e06.bindPopup(popup_58c2a505e491c01c6453834262fb2ea1)
        ;

        
    
    
            circle_marker_3211a01c4e2f4ac3f19c15b360ca8e06.bindTooltip(
                `<div>
                     Остафьево
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_4c978f42b5982498b985948fa0862289 = L.circleMarker(
                [55.674, 37.7289],
                {"bubblingMouseEvents": true, "color": "#1e2a78", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#1e2a78", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_e9f3aebe8cb353f0fd4abce6ddb3fd4d);
        
    
        var popup_bbfe39a48bc2fc16b1cc0e342f101034 = L.popup({"maxWidth": 360});

        
            var html_b5fa7b6d828c947b682ff384c01ce8e4 = $(`<div id="html_b5fa7b6d828c947b682ff384c01ce8e4" style="width: 100.0%; height: 100.0%;"><b>Перерва</b><br>Оператор: Богданов Данил<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 9075.65<br>Автоматов на локации: 7</div>`)[0];
            popup_bbfe39a48bc2fc16b1cc0e342f101034.setContent(html_b5fa7b6d828c947b682ff384c01ce8e4);
        

        circle_marker_4c978f42b5982498b985948fa0862289.bindPopup(popup_bbfe39a48bc2fc16b1cc0e342f101034)
        ;

        
    
    
            circle_marker_4c978f42b5982498b985948fa0862289.bindTooltip(
                `<div>
                     Перерва
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_3c401dd0b13cafd48af0eb144bb57a77 = L.circleMarker(
                [55.693287, 37.732094],
                {"bubblingMouseEvents": true, "color": "#1e2a78", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#1e2a78", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_e9f3aebe8cb353f0fd4abce6ddb3fd4d);
        
    
        var popup_33c748e508aa826910a54947bf443705 = L.popup({"maxWidth": 360});

        
            var html_20d59b139c0c37e9a46414c1d47989e2 = $(`<div id="html_20d59b139c0c37e9a46414c1d47989e2" style="width: 100.0%; height: 100.0%;"><b>Печатники</b><br>Оператор: Богданов Данил<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 27558.91<br>Автоматов на локации: 20</div>`)[0];
            popup_33c748e508aa826910a54947bf443705.setContent(html_20d59b139c0c37e9a46414c1d47989e2);
        

        circle_marker_3c401dd0b13cafd48af0eb144bb57a77.bindPopup(popup_33c748e508aa826910a54947bf443705)
        ;

        
    
    
            circle_marker_3c401dd0b13cafd48af0eb144bb57a77.bindTooltip(
                `<div>
                     Печатники
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_2a626739b96dda926f4f3cdc9f540873 = L.circleMarker(
                [55.4317, 37.5654],
                {"bubblingMouseEvents": true, "color": "#1e2a78", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#1e2a78", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_e9f3aebe8cb353f0fd4abce6ddb3fd4d);
        
    
        var popup_ee1d0e33528e3597c49bc72d1a2afec4 = L.popup({"maxWidth": 360});

        
            var html_3eb035d51a3b0c23d494d86a77555b0d = $(`<div id="html_3eb035d51a3b0c23d494d86a77555b0d" style="width: 100.0%; height: 100.0%;"><b>Подольск</b><br>Оператор: Богданов Данил<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 17320.32<br>Автоматов на локации: 13</div>`)[0];
            popup_ee1d0e33528e3597c49bc72d1a2afec4.setContent(html_3eb035d51a3b0c23d494d86a77555b0d);
        

        circle_marker_2a626739b96dda926f4f3cdc9f540873.bindPopup(popup_ee1d0e33528e3597c49bc72d1a2afec4)
        ;

        
    
    
            circle_marker_2a626739b96dda926f4f3cdc9f540873.bindTooltip(
                `<div>
                     Подольск
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_04cdc1c5bd7c46ed85f56f644eb79fe4 = L.circleMarker(
                [55.470544, 37.555077],
                {"bubblingMouseEvents": true, "color": "#1e2a78", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#1e2a78", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_e9f3aebe8cb353f0fd4abce6ddb3fd4d);
        
    
        var popup_57aeedc19069a57cab3238fe2de72621 = L.popup({"maxWidth": 360});

        
            var html_11b3b3f8e8191e1cecd7f412219ec123 = $(`<div id="html_11b3b3f8e8191e1cecd7f412219ec123" style="width: 100.0%; height: 100.0%;"><b>Силикатная</b><br>Оператор: Богданов Данил<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 14611.67<br>Автоматов на локации: 8</div>`)[0];
            popup_57aeedc19069a57cab3238fe2de72621.setContent(html_11b3b3f8e8191e1cecd7f412219ec123);
        

        circle_marker_04cdc1c5bd7c46ed85f56f644eb79fe4.bindPopup(popup_57aeedc19069a57cab3238fe2de72621)
        ;

        
    
    
            circle_marker_04cdc1c5bd7c46ed85f56f644eb79fe4.bindTooltip(
                `<div>
                     Силикатная
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_3aa2ec6f1840f01107be8a7e8d96b031 = L.circleMarker(
                [55.579081, 37.619887],
                {"bubblingMouseEvents": true, "color": "#1e2a78", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#1e2a78", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_e9f3aebe8cb353f0fd4abce6ddb3fd4d);
        
    
        var popup_8424043d96e56a6dde22228c9678959d = L.popup({"maxWidth": 360});

        
            var html_c349e33a547ef10dce748fd4933ef9b4 = $(`<div id="html_c349e33a547ef10dce748fd4933ef9b4" style="width: 100.0%; height: 100.0%;"><b>ЭлектроХаб</b><br>Оператор: Богданов Данил<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 2105.0<br>Автоматов на локации: 2</div>`)[0];
            popup_8424043d96e56a6dde22228c9678959d.setContent(html_c349e33a547ef10dce748fd4933ef9b4);
        

        circle_marker_3aa2ec6f1840f01107be8a7e8d96b031.bindPopup(popup_8424043d96e56a6dde22228c9678959d)
        ;

        
    
    
            circle_marker_3aa2ec6f1840f01107be8a7e8d96b031.bindTooltip(
                `<div>
                     ЭлектроХаб
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_306645f5bb765d1b01fb8c2fc6aa3a4a = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_138b6d76fdde033d08f855c4e95ba1d0 = L.circleMarker(
                [55.698807, 37.63853],
                {"bubblingMouseEvents": true, "color": "#1e2a78", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#1e2a78", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_306645f5bb765d1b01fb8c2fc6aa3a4a);
        
    
        var popup_1a5cdcc5e1ace3703236d3c328183c78 = L.popup({"maxWidth": 360});

        
            var html_10cb1a2e4d0bae0e6ff081c3401a56bd = $(`<div id="html_10cb1a2e4d0bae0e6ff081c3401a56bd" style="width: 100.0%; height: 100.0%;"><b>Фитнес</b><br>Оператор: Богданов Данила<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 691.43<br>Автоматов на локации: 1</div>`)[0];
            popup_1a5cdcc5e1ace3703236d3c328183c78.setContent(html_10cb1a2e4d0bae0e6ff081c3401a56bd);
        

        circle_marker_138b6d76fdde033d08f855c4e95ba1d0.bindPopup(popup_1a5cdcc5e1ace3703236d3c328183c78)
        ;

        
    
    
            circle_marker_138b6d76fdde033d08f855c4e95ba1d0.bindTooltip(
                `<div>
                     Фитнес
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_3b414383512d912fc30d4f89dcb1d731 = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_d5eab026a153f5138553bfc17065cb5b = L.circleMarker(
                [55.758587, 37.661738],
                {"bubblingMouseEvents": true, "color": "#92dbbf", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#92dbbf", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_3b414383512d912fc30d4f89dcb1d731);
        
    
        var popup_748be6f2fd22e7e5acd1632afae255e2 = L.popup({"maxWidth": 360});

        
            var html_1131220116d0a6bc0c45b34d5593bd73 = $(`<div id="html_1131220116d0a6bc0c45b34d5593bd73" style="width: 100.0%; height: 100.0%;"><b>Курский</b><br>Оператор: Волков/Воробьев<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 73588.33<br>Автоматов на локации: 35</div>`)[0];
            popup_748be6f2fd22e7e5acd1632afae255e2.setContent(html_1131220116d0a6bc0c45b34d5593bd73);
        

        circle_marker_d5eab026a153f5138553bfc17065cb5b.bindPopup(popup_748be6f2fd22e7e5acd1632afae255e2)
        ;

        
    
    
            circle_marker_d5eab026a153f5138553bfc17065cb5b.bindTooltip(
                `<div>
                     Курский
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_79e1303b598fe0dba4b2ab0f5e1032ff = L.circleMarker(
                [55.731311, 37.637021],
                {"bubblingMouseEvents": true, "color": "#92dbbf", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#92dbbf", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_3b414383512d912fc30d4f89dcb1d731);
        
    
        var popup_a3e89a2a490639510b8afc95917864a9 = L.popup({"maxWidth": 360});

        
            var html_395b8e09991e8209e1dc66010e4187ab = $(`<div id="html_395b8e09991e8209e1dc66010e4187ab" style="width: 100.0%; height: 100.0%;"><b>Павелецкий</b><br>Оператор: Волков/Воробьев<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 33230.0<br>Автоматов на локации: 7</div>`)[0];
            popup_a3e89a2a490639510b8afc95917864a9.setContent(html_395b8e09991e8209e1dc66010e4187ab);
        

        circle_marker_79e1303b598fe0dba4b2ab0f5e1032ff.bindPopup(popup_a3e89a2a490639510b8afc95917864a9)
        ;

        
    
    
            circle_marker_79e1303b598fe0dba4b2ab0f5e1032ff.bindTooltip(
                `<div>
                     Павелецкий
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_8380633e7bd0b610772aa1fb0cb37564 = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_579720b2dc1b8150ba38f7361932b5d9 = L.circleMarker(
                [55.83312, 37.383386],
                {"bubblingMouseEvents": true, "color": "#9ca4e6", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#9ca4e6", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_8380633e7bd0b610772aa1fb0cb37564);
        
    
        var popup_1114acd9dfe5ec3d8d6ba77b9c30f6e0 = L.popup({"maxWidth": 360});

        
            var html_de8095d388c8a682655b6c5c27d229df = $(`<div id="html_de8095d388c8a682655b6c5c27d229df" style="width: 100.0%; height: 100.0%;"><b>Волоколамская</b><br>Оператор: Зайцев Дмитрий<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 31638.6<br>Автоматов на локации: 13</div>`)[0];
            popup_1114acd9dfe5ec3d8d6ba77b9c30f6e0.setContent(html_de8095d388c8a682655b6c5c27d229df);
        

        circle_marker_579720b2dc1b8150ba38f7361932b5d9.bindPopup(popup_1114acd9dfe5ec3d8d6ba77b9c30f6e0)
        ;

        
    
    
            circle_marker_579720b2dc1b8150ba38f7361932b5d9.bindTooltip(
                `<div>
                     Волоколамская
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_4f5202dbd156416dfe73a7db43411478 = L.circleMarker(
                [55.841709, 37.184903],
                {"bubblingMouseEvents": true, "color": "#9ca4e6", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#9ca4e6", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_8380633e7bd0b610772aa1fb0cb37564);
        
    
        var popup_96b76c96345c7bb6bb6989f741ee0c36 = L.popup({"maxWidth": 360});

        
            var html_733e19af90b96d7f438fdda43b9dfa67 = $(`<div id="html_733e19af90b96d7f438fdda43b9dfa67" style="width: 100.0%; height: 100.0%;"><b>Нахабино</b><br>Оператор: Зайцев Дмитрий<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 22908.2<br>Автоматов на локации: 18</div>`)[0];
            popup_96b76c96345c7bb6bb6989f741ee0c36.setContent(html_733e19af90b96d7f438fdda43b9dfa67);
        

        circle_marker_4f5202dbd156416dfe73a7db43411478.bindPopup(popup_96b76c96345c7bb6bb6989f741ee0c36)
        ;

        
    
    
            circle_marker_4f5202dbd156416dfe73a7db43411478.bindTooltip(
                `<div>
                     Нахабино
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_b5f5a85ad8d0693209b6aa02ef8243bc = L.circleMarker(
                [55.823221, 37.247657],
                {"bubblingMouseEvents": true, "color": "#9ca4e6", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#9ca4e6", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_8380633e7bd0b610772aa1fb0cb37564);
        
    
        var popup_3268ab82ace94c5c72005e10f0427bf9 = L.popup({"maxWidth": 360});

        
            var html_9e0deddb5fcf6b58505b2f421a56851d = $(`<div id="html_9e0deddb5fcf6b58505b2f421a56851d" style="width: 100.0%; height: 100.0%;"><b>Опалиха</b><br>Оператор: Зайцев Дмитрий<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 17346.49<br>Автоматов на локации: 20</div>`)[0];
            popup_3268ab82ace94c5c72005e10f0427bf9.setContent(html_9e0deddb5fcf6b58505b2f421a56851d);
        

        circle_marker_b5f5a85ad8d0693209b6aa02ef8243bc.bindPopup(popup_3268ab82ace94c5c72005e10f0427bf9)
        ;

        
    
    
            circle_marker_b5f5a85ad8d0693209b6aa02ef8243bc.bindTooltip(
                `<div>
                     Опалиха
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_61b8547c0810c30df913aabe5cef2bc2 = L.circleMarker(
                [55.821892, 37.361113],
                {"bubblingMouseEvents": true, "color": "#9ca4e6", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#9ca4e6", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_8380633e7bd0b610772aa1fb0cb37564);
        
    
        var popup_039cd67eb5508f1895c0ef3cac359605 = L.popup({"maxWidth": 360});

        
            var html_619312f16d093a4da3c5adf8b9383070 = $(`<div id="html_619312f16d093a4da3c5adf8b9383070" style="width: 100.0%; height: 100.0%;"><b>Пенягино</b><br>Оператор: Зайцев Дмитрий<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 11710.24<br>Автоматов на локации: 8</div>`)[0];
            popup_039cd67eb5508f1895c0ef3cac359605.setContent(html_619312f16d093a4da3c5adf8b9383070);
        

        circle_marker_61b8547c0810c30df913aabe5cef2bc2.bindPopup(popup_039cd67eb5508f1895c0ef3cac359605)
        ;

        
    
    
            circle_marker_61b8547c0810c30df913aabe5cef2bc2.bindTooltip(
                `<div>
                     Пенягино
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_cd492c3773b648b8f239c9a9fe3bbf75 = L.circleMarker(
                [55.810901, 37.460824],
                {"bubblingMouseEvents": true, "color": "#9ca4e6", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#9ca4e6", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_8380633e7bd0b610772aa1fb0cb37564);
        
    
        var popup_07e58f62bdaf5f6970d4a381081de908 = L.popup({"maxWidth": 360});

        
            var html_fcf8e72f1d34e85d2d05e37ad920df7c = $(`<div id="html_fcf8e72f1d34e85d2d05e37ad920df7c" style="width: 100.0%; height: 100.0%;"><b>Щукинская</b><br>Оператор: Зайцев Дмитрий<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 24898.48<br>Автоматов на локации: 17</div>`)[0];
            popup_07e58f62bdaf5f6970d4a381081de908.setContent(html_fcf8e72f1d34e85d2d05e37ad920df7c);
        

        circle_marker_cd492c3773b648b8f239c9a9fe3bbf75.bindPopup(popup_07e58f62bdaf5f6970d4a381081de908)
        ;

        
    
    
            circle_marker_cd492c3773b648b8f239c9a9fe3bbf75.bindTooltip(
                `<div>
                     Щукинская
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_02a76ebcabf632297a9efb51ab14cb0f = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_801a71a626928d3212269527a117208c = L.circleMarker(
                [55.579446, 36.818664],
                {"bubblingMouseEvents": true, "color": "#59b295", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#59b295", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_02a76ebcabf632297a9efb51ab14cb0f);
        
    
        var popup_3dc2f2b34af33e202a0fd542e7801fa8 = L.popup({"maxWidth": 360});

        
            var html_00f949e36f997fd7cfbbfd888ad96f1a = $(`<div id="html_00f949e36f997fd7cfbbfd888ad96f1a" style="width: 100.0%; height: 100.0%;"><b>Патриот</b><br>Оператор: Замолотнев Владислав<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 35265.91<br>Автоматов на локации: 10</div>`)[0];
            popup_3dc2f2b34af33e202a0fd542e7801fa8.setContent(html_00f949e36f997fd7cfbbfd888ad96f1a);
        

        circle_marker_801a71a626928d3212269527a117208c.bindPopup(popup_3dc2f2b34af33e202a0fd542e7801fa8)
        ;

        
    
    
            circle_marker_801a71a626928d3212269527a117208c.bindTooltip(
                `<div>
                     Патриот
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_2188822284e0a7c10a7254cb13f7de73 = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_79ec35849c0791bd64deee706fb29ff4 = L.circleMarker(
                [55.870258, 37.508936],
                {"bubblingMouseEvents": true, "color": "#82cb69", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#82cb69", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_2188822284e0a7c10a7254cb13f7de73);
        
    
        var popup_ecfd70acff87e4c842e9c73d8e581f86 = L.popup({"maxWidth": 360});

        
            var html_551a56f8d772e2dd73a770c991f7552d = $(`<div id="html_551a56f8d772e2dd73a770c991f7552d" style="width: 100.0%; height: 100.0%;"><b>Грачевская</b><br>Оператор: Измаилов Джабраил<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 4773.57<br>Автоматов на локации: 2</div>`)[0];
            popup_ecfd70acff87e4c842e9c73d8e581f86.setContent(html_551a56f8d772e2dd73a770c991f7552d);
        

        circle_marker_79ec35849c0791bd64deee706fb29ff4.bindPopup(popup_ecfd70acff87e4c842e9c73d8e581f86)
        ;

        
    
    
            circle_marker_79ec35849c0791bd64deee706fb29ff4.bindTooltip(
                `<div>
                     Грачевская
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_6a72b991d1ad456ef3dbe04cfe7ee924 = L.circleMarker(
                [55.801163, 37.619416],
                {"bubblingMouseEvents": true, "color": "#82cb69", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#82cb69", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_2188822284e0a7c10a7254cb13f7de73);
        
    
        var popup_ec0c2c52dcace23cfce9ddfbeb6b4219 = L.popup({"maxWidth": 360});

        
            var html_163df344e0c9624a9087ecf1100599c5 = $(`<div id="html_163df344e0c9624a9087ecf1100599c5" style="width: 100.0%; height: 100.0%;"><b>Марьина</b><br>Оператор: Измаилов Джабраил<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 25731.82<br>Автоматов на локации: 10</div>`)[0];
            popup_ec0c2c52dcace23cfce9ddfbeb6b4219.setContent(html_163df344e0c9624a9087ecf1100599c5);
        

        circle_marker_6a72b991d1ad456ef3dbe04cfe7ee924.bindPopup(popup_ec0c2c52dcace23cfce9ddfbeb6b4219)
        ;

        
    
    
            circle_marker_6a72b991d1ad456ef3dbe04cfe7ee924.bindTooltip(
                `<div>
                     Марьина
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_40db0ab597c2fd025b82a884c24d41bb = L.circleMarker(
                [55.815323, 37.487297],
                {"bubblingMouseEvents": true, "color": "#82cb69", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#82cb69", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_2188822284e0a7c10a7254cb13f7de73);
        
    
        var popup_0880f34270983e196243bfc59869052d = L.popup({"maxWidth": 360});

        
            var html_518d634e14fceddfdea33133d4762aa1 = $(`<div id="html_518d634e14fceddfdea33133d4762aa1" style="width: 100.0%; height: 100.0%;"><b>Стрешнево</b><br>Оператор: Измаилов Джабраил<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 34930.52<br>Автоматов на локации: 20</div>`)[0];
            popup_0880f34270983e196243bfc59869052d.setContent(html_518d634e14fceddfdea33133d4762aa1);
        

        circle_marker_40db0ab597c2fd025b82a884c24d41bb.bindPopup(popup_0880f34270983e196243bfc59869052d)
        ;

        
    
    
            circle_marker_40db0ab597c2fd025b82a884c24d41bb.bindTooltip(
                `<div>
                     Стрешнево
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_603020f7853c6e523bd8374d5add5ca0 = L.circleMarker(
                [55.8198, 37.5763],
                {"bubblingMouseEvents": true, "color": "#82cb69", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#82cb69", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_2188822284e0a7c10a7254cb13f7de73);
        
    
        var popup_fd2ba4d65b40da4539e56a1244e48e9c = L.popup({"maxWidth": 360});

        
            var html_2abd7f5f257cccd72124bdf2dd5f3ff7 = $(`<div id="html_2abd7f5f257cccd72124bdf2dd5f3ff7" style="width: 100.0%; height: 100.0%;"><b>Тимирязевская</b><br>Оператор: Измаилов Джабраил<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 19760.63<br>Автоматов на локации: 11</div>`)[0];
            popup_fd2ba4d65b40da4539e56a1244e48e9c.setContent(html_2abd7f5f257cccd72124bdf2dd5f3ff7);
        

        circle_marker_603020f7853c6e523bd8374d5add5ca0.bindPopup(popup_fd2ba4d65b40da4539e56a1244e48e9c)
        ;

        
    
    
            circle_marker_603020f7853c6e523bd8374d5add5ca0.bindTooltip(
                `<div>
                     Тимирязевская
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_749f4f4b6439818203d3fe230e28150e = L.circleMarker(
                [55.894521, 37.45205],
                {"bubblingMouseEvents": true, "color": "#82cb69", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#82cb69", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_2188822284e0a7c10a7254cb13f7de73);
        
    
        var popup_3102d6b9825e9b842120b2910e93f67d = L.popup({"maxWidth": 360});

        
            var html_178ca59739af161b82ca006f14a5d1ed = $(`<div id="html_178ca59739af161b82ca006f14a5d1ed" style="width: 100.0%; height: 100.0%;"><b>Химки</b><br>Оператор: Измаилов Джабраил<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 5618.0<br>Автоматов на локации: 4</div>`)[0];
            popup_3102d6b9825e9b842120b2910e93f67d.setContent(html_178ca59739af161b82ca006f14a5d1ed);
        

        circle_marker_749f4f4b6439818203d3fe230e28150e.bindPopup(popup_3102d6b9825e9b842120b2910e93f67d)
        ;

        
    
    
            circle_marker_749f4f4b6439818203d3fe230e28150e.bindTooltip(
                `<div>
                     Химки
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_ecbbbd2dc1cce83e03e3f61c1504b56b = L.circleMarker(
                [55.880187, 37.485692],
                {"bubblingMouseEvents": true, "color": "#82cb69", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#82cb69", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_2188822284e0a7c10a7254cb13f7de73);
        
    
        var popup_6a5955e4da48732e25321798d3bcb446 = L.popup({"maxWidth": 360});

        
            var html_ac188a37245523aaf7dc1540cf842f90 = $(`<div id="html_ac188a37245523aaf7dc1540cf842f90" style="width: 100.0%; height: 100.0%;"><b>Ховрино</b><br>Оператор: Измаилов Джабраил<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 6852.8<br>Автоматов на локации: 2</div>`)[0];
            popup_6a5955e4da48732e25321798d3bcb446.setContent(html_ac188a37245523aaf7dc1540cf842f90);
        

        circle_marker_ecbbbd2dc1cce83e03e3f61c1504b56b.bindPopup(popup_6a5955e4da48732e25321798d3bcb446)
        ;

        
    
    
            circle_marker_ecbbbd2dc1cce83e03e3f61c1504b56b.bindTooltip(
                `<div>
                     Ховрино
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_994ae5dd0c47d35b6c9eb965fb956007 = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_1c613202babac1ce19dff3a9ed5fe072 = L.circleMarker(
                [56.0097, 37.2005],
                {"bubblingMouseEvents": true, "color": "#63b78f", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#63b78f", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_994ae5dd0c47d35b6c9eb965fb956007);
        
    
        var popup_7a9ce8282e016585e4be2bfa96ce01e2 = L.popup({"maxWidth": 360});

        
            var html_af95c0efdc1828d86181ee84ec90e6ad = $(`<div id="html_af95c0efdc1828d86181ee84ec90e6ad" style="width: 100.0%; height: 100.0%;"><b>Крюково</b><br>Оператор: Кормщиков Максим<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 57167.2<br>Автоматов на локации: 22</div>`)[0];
            popup_7a9ce8282e016585e4be2bfa96ce01e2.setContent(html_af95c0efdc1828d86181ee84ec90e6ad);
        

        circle_marker_1c613202babac1ce19dff3a9ed5fe072.bindPopup(popup_7a9ce8282e016585e4be2bfa96ce01e2)
        ;

        
    
    
            circle_marker_1c613202babac1ce19dff3a9ed5fe072.bindTooltip(
                `<div>
                     Крюково
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_a6a28337a76cf945d1a3d02a78a245ec = L.circleMarker(
                [56.1833, 36.9832],
                {"bubblingMouseEvents": true, "color": "#63b78f", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#63b78f", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_994ae5dd0c47d35b6c9eb965fb956007);
        
    
        var popup_d8dfdb8e6d0a4f94da138ae03b9b1f73 = L.popup({"maxWidth": 360});

        
            var html_127e1720e02c14287c430aca370017c8 = $(`<div id="html_127e1720e02c14287c430aca370017c8" style="width: 100.0%; height: 100.0%;"><b>Подсолнечная</b><br>Оператор: Кормщиков Максим<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 5837.86<br>Автоматов на локации: 2</div>`)[0];
            popup_d8dfdb8e6d0a4f94da138ae03b9b1f73.setContent(html_127e1720e02c14287c430aca370017c8);
        

        circle_marker_a6a28337a76cf945d1a3d02a78a245ec.bindPopup(popup_d8dfdb8e6d0a4f94da138ae03b9b1f73)
        ;

        
    
    
            circle_marker_a6a28337a76cf945d1a3d02a78a245ec.bindTooltip(
                `<div>
                     Подсолнечная
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_be6efe8a135fa082e24c50474ad62eb2 = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_3bc08e34fab3466dcd7f696759a7dc86 = L.circleMarker(
                [55.752169, 38.030534],
                {"bubblingMouseEvents": true, "color": "#b2e05d", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#b2e05d", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_be6efe8a135fa082e24c50474ad62eb2);
        
    
        var popup_4cb5cd7e488ebd017f0f37fc6e279d64 = L.popup({"maxWidth": 360});

        
            var html_5b90203e490d2f4a0a213c4eb8f848b4 = $(`<div id="html_5b90203e490d2f4a0a213c4eb8f848b4" style="width: 100.0%; height: 100.0%;"><b>Балашиха</b><br>Оператор: Кумачев Сергей.<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 2167.86<br>Автоматов на локации: 2</div>`)[0];
            popup_4cb5cd7e488ebd017f0f37fc6e279d64.setContent(html_5b90203e490d2f4a0a213c4eb8f848b4);
        

        circle_marker_3bc08e34fab3466dcd7f696759a7dc86.bindPopup(popup_4cb5cd7e488ebd017f0f37fc6e279d64)
        ;

        
    
    
            circle_marker_3bc08e34fab3466dcd7f696759a7dc86.bindTooltip(
                `<div>
                     Балашиха
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_1b4df8a18df99d9d9c745096630415f4 = L.circleMarker(
                [55.751978, 38.008404],
                {"bubblingMouseEvents": true, "color": "#b2e05d", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#b2e05d", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_be6efe8a135fa082e24c50474ad62eb2);
        
    
        var popup_c12f5167fbc588c1963ecc30b3ea53f4 = L.popup({"maxWidth": 360});

        
            var html_c23ed53dc40c03471dd59c261765cc51 = $(`<div id="html_c23ed53dc40c03471dd59c261765cc51" style="width: 100.0%; height: 100.0%;"><b>Железнодорожный</b><br>Оператор: Кумачев Сергей.<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 36326.87<br>Автоматов на локации: 16</div>`)[0];
            popup_c12f5167fbc588c1963ecc30b3ea53f4.setContent(html_c23ed53dc40c03471dd59c261765cc51);
        

        circle_marker_1b4df8a18df99d9d9c745096630415f4.bindPopup(popup_c12f5167fbc588c1963ecc30b3ea53f4)
        ;

        
    
    
            circle_marker_1b4df8a18df99d9d9c745096630415f4.bindTooltip(
                `<div>
                     Железнодорожный
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_f03f7b44b8f9c5150838c984572c8f84 = L.circleMarker(
                [55.7324, 37.7284],
                {"bubblingMouseEvents": true, "color": "#b2e05d", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#b2e05d", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_be6efe8a135fa082e24c50474ad62eb2);
        
    
        var popup_1cfa7795172e3e7cb9c6dd395dbb0bd1 = L.popup({"maxWidth": 360});

        
            var html_2301aab3c946b77a50f0d8e0ef0a777e = $(`<div id="html_2301aab3c946b77a50f0d8e0ef0a777e" style="width: 100.0%; height: 100.0%;"><b>Нижегородская</b><br>Оператор: Кумачев Сергей.<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 42095.79<br>Автоматов на локации: 15</div>`)[0];
            popup_1cfa7795172e3e7cb9c6dd395dbb0bd1.setContent(html_2301aab3c946b77a50f0d8e0ef0a777e);
        

        circle_marker_f03f7b44b8f9c5150838c984572c8f84.bindPopup(popup_1cfa7795172e3e7cb9c6dd395dbb0bd1)
        ;

        
    
    
            circle_marker_f03f7b44b8f9c5150838c984572c8f84.bindTooltip(
                `<div>
                     Нижегородская
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_f53f7818f9591d75b5992a6758228578 = L.circleMarker(
                [55.744429, 37.81843],
                {"bubblingMouseEvents": true, "color": "#b2e05d", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#b2e05d", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_be6efe8a135fa082e24c50474ad62eb2);
        
    
        var popup_3fdba9db93df45c33ae815240497d136 = L.popup({"maxWidth": 360});

        
            var html_2a374f8980181fc04850b2b093d0606a = $(`<div id="html_2a374f8980181fc04850b2b093d0606a" style="width: 100.0%; height: 100.0%;"><b>Новогиреево</b><br>Оператор: Кумачев Сергей.<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 7823.62<br>Автоматов на локации: 7</div>`)[0];
            popup_3fdba9db93df45c33ae815240497d136.setContent(html_2a374f8980181fc04850b2b093d0606a);
        

        circle_marker_f53f7818f9591d75b5992a6758228578.bindPopup(popup_3fdba9db93df45c33ae815240497d136)
        ;

        
    
    
            circle_marker_f53f7818f9591d75b5992a6758228578.bindTooltip(
                `<div>
                     Новогиреево
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_7497a79db24f9bf32f269c063c93377d = L.circleMarker(
                [55.72395, 37.714895],
                {"bubblingMouseEvents": true, "color": "#b2e05d", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#b2e05d", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_be6efe8a135fa082e24c50474ad62eb2);
        
    
        var popup_4d3039ead066ccbc6f439ad590743e8b = L.popup({"maxWidth": 360});

        
            var html_40172af912f7dc8d0d12a39815b31d97 = $(`<div id="html_40172af912f7dc8d0d12a39815b31d97" style="width: 100.0%; height: 100.0%;"><b>Новохохловская</b><br>Оператор: Кумачев Сергей.<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 7914.64<br>Автоматов на локации: 5</div>`)[0];
            popup_4d3039ead066ccbc6f439ad590743e8b.setContent(html_40172af912f7dc8d0d12a39815b31d97);
        

        circle_marker_7497a79db24f9bf32f269c063c93377d.bindPopup(popup_4d3039ead066ccbc6f439ad590743e8b)
        ;

        
    
    
            circle_marker_7497a79db24f9bf32f269c063c93377d.bindTooltip(
                `<div>
                     Новохохловская
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_49617cc203aea9f8dd475e3eefaae93a = L.circleMarker(
                [55.751605, 37.978611],
                {"bubblingMouseEvents": true, "color": "#b2e05d", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#b2e05d", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_be6efe8a135fa082e24c50474ad62eb2);
        
    
        var popup_72962801d71714bf779fd929b8b25d6a = L.popup({"maxWidth": 360});

        
            var html_40232853d157edbee7269074ff522c41 = $(`<div id="html_40232853d157edbee7269074ff522c41" style="width: 100.0%; height: 100.0%;"><b>Ольгино</b><br>Оператор: Кумачев Сергей.<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 16749.51<br>Автоматов на локации: 11</div>`)[0];
            popup_72962801d71714bf779fd929b8b25d6a.setContent(html_40232853d157edbee7269074ff522c41);
        

        circle_marker_49617cc203aea9f8dd475e3eefaae93a.bindPopup(popup_72962801d71714bf779fd929b8b25d6a)
        ;

        
    
    
            circle_marker_49617cc203aea9f8dd475e3eefaae93a.bindTooltip(
                `<div>
                     Ольгино
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_fcedbfd5c0d3265d867c299da8881940 = L.circleMarker(
                [55.7516, 37.855816],
                {"bubblingMouseEvents": true, "color": "#b2e05d", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#b2e05d", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_be6efe8a135fa082e24c50474ad62eb2);
        
    
        var popup_15338580cdeab2f66203973095b183e6 = L.popup({"maxWidth": 360});

        
            var html_2bfaef9a9174e00041498641cafe530b = $(`<div id="html_2bfaef9a9174e00041498641cafe530b" style="width: 100.0%; height: 100.0%;"><b>Реутов</b><br>Оператор: Кумачев Сергей.<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 3822.75<br>Автоматов на локации: 3</div>`)[0];
            popup_15338580cdeab2f66203973095b183e6.setContent(html_2bfaef9a9174e00041498641cafe530b);
        

        circle_marker_fcedbfd5c0d3265d867c299da8881940.bindPopup(popup_15338580cdeab2f66203973095b183e6)
        ;

        
    
    
            circle_marker_fcedbfd5c0d3265d867c299da8881940.bindTooltip(
                `<div>
                     Реутов
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_064f00f75d1b6c16b29cd2f3f7cfd89b = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_258068919c348d36bd6627519f25dcb2 = L.circleMarker(
                [55.550465, 37.066978],
                {"bubblingMouseEvents": true, "color": "#7ca8d9", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#7ca8d9", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_064f00f75d1b6c16b29cd2f3f7cfd89b);
        
    
        var popup_e17a711d3957d0f19d53bd0dd53de0c8 = L.popup({"maxWidth": 360});

        
            var html_6e037d68bfb0b1652a4622d6e4ae2155 = $(`<div id="html_6e037d68bfb0b1652a4622d6e4ae2155" style="width: 100.0%; height: 100.0%;"><b>Апрелевка</b><br>Оператор: Максимов Дмитрий<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 27625.92<br>Автоматов на локации: 18</div>`)[0];
            popup_e17a711d3957d0f19d53bd0dd53de0c8.setContent(html_6e037d68bfb0b1652a4622d6e4ae2155);
        

        circle_marker_258068919c348d36bd6627519f25dcb2.bindPopup(popup_e17a711d3957d0f19d53bd0dd53de0c8)
        ;

        
    
    
            circle_marker_258068919c348d36bd6627519f25dcb2.bindTooltip(
                `<div>
                     Апрелевка
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_d21ac545f6a1ffe236d85b2f82125919 = L.circleMarker(
                [55.648889, 37.269722],
                {"bubblingMouseEvents": true, "color": "#7ca8d9", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#7ca8d9", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_064f00f75d1b6c16b29cd2f3f7cfd89b);
        
    
        var popup_60b378bcce2162869e595352c2bea818 = L.popup({"maxWidth": 360});

        
            var html_5b7d17b334bc7777cc2139f8d9e28756 = $(`<div id="html_5b7d17b334bc7777cc2139f8d9e28756" style="width: 100.0%; height: 100.0%;"><b>Внуково</b><br>Оператор: Максимов Дмитрий<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 13280.95<br>Автоматов на локации: 9</div>`)[0];
            popup_60b378bcce2162869e595352c2bea818.setContent(html_5b7d17b334bc7777cc2139f8d9e28756);
        

        circle_marker_d21ac545f6a1ffe236d85b2f82125919.bindPopup(popup_60b378bcce2162869e595352c2bea818)
        ;

        
    
    
            circle_marker_d21ac545f6a1ffe236d85b2f82125919.bindTooltip(
                `<div>
                     Внуково
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_1442de014f7458bacd1e458ff896962a = L.circleMarker(
                [55.598772, 37.169431],
                {"bubblingMouseEvents": true, "color": "#7ca8d9", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#7ca8d9", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_064f00f75d1b6c16b29cd2f3f7cfd89b);
        
    
        var popup_19476adb2ff1a7560fbe4160e270a7a0 = L.popup({"maxWidth": 360});

        
            var html_4c0a32111814dea78ab540d96724b0b4 = $(`<div id="html_4c0a32111814dea78ab540d96724b0b4" style="width: 100.0%; height: 100.0%;"><b>Кокошкино</b><br>Оператор: Максимов Дмитрий<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 5677.98<br>Автоматов на локации: 5</div>`)[0];
            popup_19476adb2ff1a7560fbe4160e270a7a0.setContent(html_4c0a32111814dea78ab540d96724b0b4);
        

        circle_marker_1442de014f7458bacd1e458ff896962a.bindPopup(popup_19476adb2ff1a7560fbe4160e270a7a0)
        ;

        
    
    
            circle_marker_1442de014f7458bacd1e458ff896962a.bindTooltip(
                `<div>
                     Кокошкино
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_bf91f17656b36cc4e4e5e891af3f48d7 = L.circleMarker(
                [55.578244, 37.109903],
                {"bubblingMouseEvents": true, "color": "#7ca8d9", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#7ca8d9", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_064f00f75d1b6c16b29cd2f3f7cfd89b);
        
    
        var popup_3ed3a242a5a3e67e5b5d15ce3c9bbfc1 = L.popup({"maxWidth": 360});

        
            var html_ae4d2955acd320996af6e79c7aeb2132 = $(`<div id="html_ae4d2955acd320996af6e79c7aeb2132" style="width: 100.0%; height: 100.0%;"><b>Крекшино</b><br>Оператор: Максимов Дмитрий<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 3558.76<br>Автоматов на локации: 4</div>`)[0];
            popup_3ed3a242a5a3e67e5b5d15ce3c9bbfc1.setContent(html_ae4d2955acd320996af6e79c7aeb2132);
        

        circle_marker_bf91f17656b36cc4e4e5e891af3f48d7.bindPopup(popup_3ed3a242a5a3e67e5b5d15ce3c9bbfc1)
        ;

        
    
    
            circle_marker_bf91f17656b36cc4e4e5e891af3f48d7.bindTooltip(
                `<div>
                     Крекшино
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_08523afa58761829c854d4cd66e24a32 = L.circleMarker(
                [55.631649, 37.218144],
                {"bubblingMouseEvents": true, "color": "#7ca8d9", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#7ca8d9", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_064f00f75d1b6c16b29cd2f3f7cfd89b);
        
    
        var popup_b428101e18dd6fd5e079597f95dc6bd0 = L.popup({"maxWidth": 360});

        
            var html_e11c9fdc46f050090b0e23063a149e6b = $(`<div id="html_e11c9fdc46f050090b0e23063a149e6b" style="width: 100.0%; height: 100.0%;"><b>Лесной</b><br>Оператор: Максимов Дмитрий<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 15154.62<br>Автоматов на локации: 9</div>`)[0];
            popup_b428101e18dd6fd5e079597f95dc6bd0.setContent(html_e11c9fdc46f050090b0e23063a149e6b);
        

        circle_marker_08523afa58761829c854d4cd66e24a32.bindPopup(popup_b428101e18dd6fd5e079597f95dc6bd0)
        ;

        
    
    
            circle_marker_08523afa58761829c854d4cd66e24a32.bindTooltip(
                `<div>
                     Лесной
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_53ab07b7d8ce2efd00813d3af443a924 = L.circleMarker(
                [55.645762, 37.316018],
                {"bubblingMouseEvents": true, "color": "#7ca8d9", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#7ca8d9", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_064f00f75d1b6c16b29cd2f3f7cfd89b);
        
    
        var popup_93ce69f8fbb0b5fac5ef6bb03164f923 = L.popup({"maxWidth": 360});

        
            var html_0756df7152a9497b1e6f16fd50193395 = $(`<div id="html_0756df7152a9497b1e6f16fd50193395" style="width: 100.0%; height: 100.0%;"><b>Мичуринец</b><br>Оператор: Максимов Дмитрий<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 10039.52<br>Автоматов на локации: 9</div>`)[0];
            popup_93ce69f8fbb0b5fac5ef6bb03164f923.setContent(html_0756df7152a9497b1e6f16fd50193395);
        

        circle_marker_53ab07b7d8ce2efd00813d3af443a924.bindPopup(popup_93ce69f8fbb0b5fac5ef6bb03164f923)
        ;

        
    
    
            circle_marker_53ab07b7d8ce2efd00813d3af443a924.bindTooltip(
                `<div>
                     Мичуринец
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_394f5fcc56ad908e76c6870d914a3cbd = L.circleMarker(
                [55.656039, 37.354632],
                {"bubblingMouseEvents": true, "color": "#7ca8d9", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#7ca8d9", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_064f00f75d1b6c16b29cd2f3f7cfd89b);
        
    
        var popup_0f982cfc4428f344df895bfff21d2cc5 = L.popup({"maxWidth": 360});

        
            var html_a460469894771ac3bddaf27782d498cb = $(`<div id="html_a460469894771ac3bddaf27782d498cb" style="width: 100.0%; height: 100.0%;"><b>Переделкино</b><br>Оператор: Максимов Дмитрий<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 23634.45<br>Автоматов на локации: 13</div>`)[0];
            popup_0f982cfc4428f344df895bfff21d2cc5.setContent(html_a460469894771ac3bddaf27782d498cb);
        

        circle_marker_394f5fcc56ad908e76c6870d914a3cbd.bindPopup(popup_0f982cfc4428f344df895bfff21d2cc5)
        ;

        
    
    
            circle_marker_394f5fcc56ad908e76c6870d914a3cbd.bindTooltip(
                `<div>
                     Переделкино
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_a4d66f2e2aba1253f350ff28bd75ba36 = L.circleMarker(
                [55.584754, 37.141833],
                {"bubblingMouseEvents": true, "color": "#7ca8d9", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#7ca8d9", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_064f00f75d1b6c16b29cd2f3f7cfd89b);
        
    
        var popup_16d2ef9bb8dfe66ddf51d3032f8634ac = L.popup({"maxWidth": 360});

        
            var html_ad19c36308850c2f1197068d22a9ad89 = $(`<div id="html_ad19c36308850c2f1197068d22a9ad89" style="width: 100.0%; height: 100.0%;"><b>Победа</b><br>Оператор: Максимов Дмитрий<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 3044.29<br>Автоматов на локации: 3</div>`)[0];
            popup_16d2ef9bb8dfe66ddf51d3032f8634ac.setContent(html_ad19c36308850c2f1197068d22a9ad89);
        

        circle_marker_a4d66f2e2aba1253f350ff28bd75ba36.bindPopup(popup_16d2ef9bb8dfe66ddf51d3032f8634ac)
        ;

        
    
    
            circle_marker_a4d66f2e2aba1253f350ff28bd75ba36.bindTooltip(
                `<div>
                     Победа
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_16677188aef6ee55bbd39d1af14e672c = L.circleMarker(
                [55.584734, 37.141813],
                {"bubblingMouseEvents": true, "color": "#7ca8d9", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#7ca8d9", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_064f00f75d1b6c16b29cd2f3f7cfd89b);
        
    
        var popup_0e665544352f2409537c0ed69672eb54 = L.popup({"maxWidth": 360});

        
            var html_2e0eca8cac9b1d948298e915e319b214 = $(`<div id="html_2e0eca8cac9b1d948298e915e319b214" style="width: 100.0%; height: 100.0%;"><b>Санино</b><br>Оператор: Максимов Дмитрий<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 2650.71<br>Автоматов на локации: 2</div>`)[0];
            popup_0e665544352f2409537c0ed69672eb54.setContent(html_2e0eca8cac9b1d948298e915e319b214);
        

        circle_marker_16677188aef6ee55bbd39d1af14e672c.bindPopup(popup_0e665544352f2409537c0ed69672eb54)
        ;

        
    
    
            circle_marker_16677188aef6ee55bbd39d1af14e672c.bindTooltip(
                `<div>
                     Санино
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_0c40623c4f519672ade42cdf37cbb341 = L.circleMarker(
                [55.607439, 37.185031],
                {"bubblingMouseEvents": true, "color": "#7ca8d9", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#7ca8d9", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_064f00f75d1b6c16b29cd2f3f7cfd89b);
        
    
        var popup_553d6b5a973d3878e9ab0c02037159c0 = L.popup({"maxWidth": 360});

        
            var html_e773c04fe3f301897719b4d2cf1bed2b = $(`<div id="html_e773c04fe3f301897719b4d2cf1bed2b" style="width: 100.0%; height: 100.0%;"><b>Толстопальцево</b><br>Оператор: Максимов Дмитрий<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 2992.31<br>Автоматов на локации: 3</div>`)[0];
            popup_553d6b5a973d3878e9ab0c02037159c0.setContent(html_e773c04fe3f301897719b4d2cf1bed2b);
        

        circle_marker_0c40623c4f519672ade42cdf37cbb341.bindPopup(popup_553d6b5a973d3878e9ab0c02037159c0)
        ;

        
    
    
            circle_marker_0c40623c4f519672ade42cdf37cbb341.bindTooltip(
                `<div>
                     Толстопальцево
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_5e61fd507c7cba7a50e45863c1f1dd4e = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_e2c667a101a42c9bb51ef5122a716543 = L.circleMarker(
                [55.775493, 37.65187],
                {"bubblingMouseEvents": true, "color": "#a2b059", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#a2b059", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_5e61fd507c7cba7a50e45863c1f1dd4e);
        
    
        var popup_2af4c9da20cd1f0029322a650c5003d6 = L.popup({"maxWidth": 360});

        
            var html_30dad900c68466326008e1f240517f5b = $(`<div id="html_30dad900c68466326008e1f240517f5b" style="width: 100.0%; height: 100.0%;"><b>Каланчевская</b><br>Оператор: Назарян Ваник.<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 120119.6<br>Автоматов на локации: 24</div>`)[0];
            popup_2af4c9da20cd1f0029322a650c5003d6.setContent(html_30dad900c68466326008e1f240517f5b);
        

        circle_marker_e2c667a101a42c9bb51ef5122a716543.bindPopup(popup_2af4c9da20cd1f0029322a650c5003d6)
        ;

        
    
    
            circle_marker_e2c667a101a42c9bb51ef5122a716543.bindTooltip(
                `<div>
                     Каланчевская
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_01fbdb1c8c750a98b71ba82487873caf = L.circleMarker(
                [55.77635, 37.655833],
                {"bubblingMouseEvents": true, "color": "#a2b059", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#a2b059", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_5e61fd507c7cba7a50e45863c1f1dd4e);
        
    
        var popup_43dc5748103686266f2c972cc6c91ece = L.popup({"maxWidth": 360});

        
            var html_37bd6f184026ad38e7a7ef333c3fa306 = $(`<div id="html_37bd6f184026ad38e7a7ef333c3fa306" style="width: 100.0%; height: 100.0%;"><b>Ярославский</b><br>Оператор: Назарян Ваник.<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 90982.89<br>Автоматов на локации: 25</div>`)[0];
            popup_43dc5748103686266f2c972cc6c91ece.setContent(html_37bd6f184026ad38e7a7ef333c3fa306);
        

        circle_marker_01fbdb1c8c750a98b71ba82487873caf.bindPopup(popup_43dc5748103686266f2c972cc6c91ece)
        ;

        
    
    
            circle_marker_01fbdb1c8c750a98b71ba82487873caf.bindTooltip(
                `<div>
                     Ярославский
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_671b121e0d58d1f728cd48b0ee357bea = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_67f8a1d27f3fb22f86967a8a37204b9a = L.circleMarker(
                [55.696667, 37.468056],
                {"bubblingMouseEvents": true, "color": "#606fab", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#606fab", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_671b121e0d58d1f728cd48b0ee357bea);
        
    
        var popup_6e3dbbfffb4d0c4d9b30778c6d7b8a17 = L.popup({"maxWidth": 360});

        
            var html_33fd4e601208bd069ccb72906866f9d7 = $(`<div id="html_33fd4e601208bd069ccb72906866f9d7" style="width: 100.0%; height: 100.0%;"><b>Аминьевская</b><br>Оператор: Намаконов Олег<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 57504.87<br>Автоматов на локации: 17</div>`)[0];
            popup_6e3dbbfffb4d0c4d9b30778c6d7b8a17.setContent(html_33fd4e601208bd069ccb72906866f9d7);
        

        circle_marker_67f8a1d27f3fb22f86967a8a37204b9a.bindPopup(popup_6e3dbbfffb4d0c4d9b30778c6d7b8a17)
        ;

        
    
    
            circle_marker_67f8a1d27f3fb22f86967a8a37204b9a.bindTooltip(
                `<div>
                     Аминьевская
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_42e8850c9a15d53fef84bab1cb27fe12 = L.circleMarker(
                [55.704843, 37.481743],
                {"bubblingMouseEvents": true, "color": "#606fab", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#606fab", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_671b121e0d58d1f728cd48b0ee357bea);
        
    
        var popup_96f2abddc47feb99aa85de165c002ea1 = L.popup({"maxWidth": 360});

        
            var html_aed9fde586a1a8f0308465766ff5ea69 = $(`<div id="html_aed9fde586a1a8f0308465766ff5ea69" style="width: 100.0%; height: 100.0%;"><b>Матвеевская</b><br>Оператор: Намаконов Олег<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 3964.05<br>Автоматов на локации: 4</div>`)[0];
            popup_96f2abddc47feb99aa85de165c002ea1.setContent(html_aed9fde586a1a8f0308465766ff5ea69);
        

        circle_marker_42e8850c9a15d53fef84bab1cb27fe12.bindPopup(popup_96f2abddc47feb99aa85de165c002ea1)
        ;

        
    
    
            circle_marker_42e8850c9a15d53fef84bab1cb27fe12.bindTooltip(
                `<div>
                     Матвеевская
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_078211649f862eec53783eaaadab3af9 = L.circleMarker(
                [55.666667, 37.424444],
                {"bubblingMouseEvents": true, "color": "#606fab", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#606fab", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_671b121e0d58d1f728cd48b0ee357bea);
        
    
        var popup_82badc7c00ac1399f0bb326dc615ca51 = L.popup({"maxWidth": 360});

        
            var html_3772cb9c9b055cd6deb1dcd1d0a4b1a9 = $(`<div id="html_3772cb9c9b055cd6deb1dcd1d0a4b1a9" style="width: 100.0%; height: 100.0%;"><b>Мещерская</b><br>Оператор: Намаконов Олег<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 4610.81<br>Автоматов на локации: 3</div>`)[0];
            popup_82badc7c00ac1399f0bb326dc615ca51.setContent(html_3772cb9c9b055cd6deb1dcd1d0a4b1a9);
        

        circle_marker_078211649f862eec53783eaaadab3af9.bindPopup(popup_82badc7c00ac1399f0bb326dc615ca51)
        ;

        
    
    
            circle_marker_078211649f862eec53783eaaadab3af9.bindTooltip(
                `<div>
                     Мещерская
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_ad3c8af2e35331ccd25094e29d197b74 = L.circleMarker(
                [55.723145, 37.499152],
                {"bubblingMouseEvents": true, "color": "#606fab", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#606fab", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_671b121e0d58d1f728cd48b0ee357bea);
        
    
        var popup_0b177d7910eba31a9140bedf0d2b08f6 = L.popup({"maxWidth": 360});

        
            var html_21d866a9804a8224658c29c9313481fb = $(`<div id="html_21d866a9804a8224658c29c9313481fb" style="width: 100.0%; height: 100.0%;"><b>Минская</b><br>Оператор: Намаконов Олег<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 12226.67<br>Автоматов на локации: 7</div>`)[0];
            popup_0b177d7910eba31a9140bedf0d2b08f6.setContent(html_21d866a9804a8224658c29c9313481fb);
        

        circle_marker_ad3c8af2e35331ccd25094e29d197b74.bindPopup(popup_0b177d7910eba31a9140bedf0d2b08f6)
        ;

        
    
    
            circle_marker_ad3c8af2e35331ccd25094e29d197b74.bindTooltip(
                `<div>
                     Минская
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_7a0905c4215f4d1c0f5e887ccfc6140c = L.circleMarker(
                [55.683114, 37.450363],
                {"bubblingMouseEvents": true, "color": "#606fab", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#606fab", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_671b121e0d58d1f728cd48b0ee357bea);
        
    
        var popup_7b561c0073b69f92f3cc840e7ea8d9dd = L.popup({"maxWidth": 360});

        
            var html_964a895530144602f8bb7369aa2e683c = $(`<div id="html_964a895530144602f8bb7369aa2e683c" style="width: 100.0%; height: 100.0%;"><b>Очаково</b><br>Оператор: Намаконов Олег<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 7591.9<br>Автоматов на локации: 5</div>`)[0];
            popup_7b561c0073b69f92f3cc840e7ea8d9dd.setContent(html_964a895530144602f8bb7369aa2e683c);
        

        circle_marker_7a0905c4215f4d1c0f5e887ccfc6140c.bindPopup(popup_7b561c0073b69f92f3cc840e7ea8d9dd)
        ;

        
    
    
            circle_marker_7a0905c4215f4d1c0f5e887ccfc6140c.bindTooltip(
                `<div>
                     Очаково
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_a9504228b54713ffa65c1d824aaa4dbc = L.circleMarker(
                [55.723149, 37.396265],
                {"bubblingMouseEvents": true, "color": "#606fab", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#606fab", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_671b121e0d58d1f728cd48b0ee357bea);
        
    
        var popup_f15dd5513c69f3b997321b4274a52c6b = L.popup({"maxWidth": 360});

        
            var html_b1859cd0b7c14fc01e93b4e11f2f29e3 = $(`<div id="html_b1859cd0b7c14fc01e93b4e11f2f29e3" style="width: 100.0%; height: 100.0%;"><b>Сетунь</b><br>Оператор: Намаконов Олег<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 5140.89<br>Автоматов на локации: 5</div>`)[0];
            popup_f15dd5513c69f3b997321b4274a52c6b.setContent(html_b1859cd0b7c14fc01e93b4e11f2f29e3);
        

        circle_marker_a9504228b54713ffa65c1d824aaa4dbc.bindPopup(popup_f15dd5513c69f3b997321b4274a52c6b)
        ;

        
    
    
            circle_marker_a9504228b54713ffa65c1d824aaa4dbc.bindTooltip(
                `<div>
                     Сетунь
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_2a7d6049c6d61484171469f1b11f45f4 = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_6b6310f568c0a1db30d490fde5819d43 = L.circleMarker(
                [55.91472, 37.76164],
                {"bubblingMouseEvents": true, "color": "#97e3a3", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#97e3a3", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_2a7d6049c6d61484171469f1b11f45f4);
        
    
        var popup_9a82f25a77c89047f8ccd11b1a0915a2 = L.popup({"maxWidth": 360});

        
            var html_0a4e665315564d8d165fed58a8fd4a0a = $(`<div id="html_0a4e665315564d8d165fed58a8fd4a0a" style="width: 100.0%; height: 100.0%;"><b>Мытищи</b><br>Оператор: Скворцов Артем<br>Маршрут: Маршрут №1 Север<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 3376.1<br>Автоматов на локации: 3</div>`)[0];
            popup_9a82f25a77c89047f8ccd11b1a0915a2.setContent(html_0a4e665315564d8d165fed58a8fd4a0a);
        

        circle_marker_6b6310f568c0a1db30d490fde5819d43.bindPopup(popup_9a82f25a77c89047f8ccd11b1a0915a2)
        ;

        
    
    
            circle_marker_6b6310f568c0a1db30d490fde5819d43.bindTooltip(
                `<div>
                     Мытищи
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_8b0337ea53cc81518ff572f635fdb822 = L.circleMarker(
                [55.842325, 37.670162],
                {"bubblingMouseEvents": true, "color": "#97e3a3", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#97e3a3", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_2a7d6049c6d61484171469f1b11f45f4);
        
    
        var popup_299cb0f673c2a06bd8d90c17e3ab5504 = L.popup({"maxWidth": 360});

        
            var html_6e1c3d7c8a297b0df72f0385283c0b59 = $(`<div id="html_6e1c3d7c8a297b0df72f0385283c0b59" style="width: 100.0%; height: 100.0%;"><b>Ростокино</b><br>Оператор: Скворцов Артем<br>Маршрут: Маршрут №1 Север<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 4252.14<br>Автоматов на локации: 1</div>`)[0];
            popup_299cb0f673c2a06bd8d90c17e3ab5504.setContent(html_6e1c3d7c8a297b0df72f0385283c0b59);
        

        circle_marker_8b0337ea53cc81518ff572f635fdb822.bindPopup(popup_299cb0f673c2a06bd8d90c17e3ab5504)
        ;

        
    
    
            circle_marker_8b0337ea53cc81518ff572f635fdb822.bindTooltip(
                `<div>
                     Ростокино
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_e795106e90e8cc0a50c945d781cef283 = L.circleMarker(
                [55.781579, 37.688012],
                {"bubblingMouseEvents": true, "color": "#97e3a3", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#97e3a3", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_2a7d6049c6d61484171469f1b11f45f4);
        
    
        var popup_3b4b9aeaf8a4aea211df11a319d40c3d = L.popup({"maxWidth": 360});

        
            var html_dbeef717840a355302daae34e342ce06 = $(`<div id="html_dbeef717840a355302daae34e342ce06" style="width: 100.0%; height: 100.0%;"><b>Склад</b><br>Оператор: Скворцов Артем<br>Маршрут: Маршрут №1 Север<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 531.54<br>Автоматов на локации: 1</div>`)[0];
            popup_3b4b9aeaf8a4aea211df11a319d40c3d.setContent(html_dbeef717840a355302daae34e342ce06);
        

        circle_marker_e795106e90e8cc0a50c945d781cef283.bindPopup(popup_3b4b9aeaf8a4aea211df11a319d40c3d)
        ;

        
    
    
            circle_marker_e795106e90e8cc0a50c945d781cef283.bindTooltip(
                `<div>
                     Склад
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_0ca8403ee0a398bb75b6e4b95bcca399 = L.circleMarker(
                [55.781579, 37.688012],
                {"bubblingMouseEvents": true, "color": "#97e3a3", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#97e3a3", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_2a7d6049c6d61484171469f1b11f45f4);
        
    
        var popup_7efb4aee89ae124fc46605be1ea47119 = L.popup({"maxWidth": 360});

        
            var html_648a3f056e80c6a8cba18f62e1ab4e75 = $(`<div id="html_648a3f056e80c6a8cba18f62e1ab4e75" style="width: 100.0%; height: 100.0%;"><b>Центросоюзный</b><br>Оператор: Скворцов Артем<br>Маршрут: Маршрут №1 Север<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 3719.29<br>Автоматов на локации: 3</div>`)[0];
            popup_7efb4aee89ae124fc46605be1ea47119.setContent(html_648a3f056e80c6a8cba18f62e1ab4e75);
        

        circle_marker_0ca8403ee0a398bb75b6e4b95bcca399.bindPopup(popup_7efb4aee89ae124fc46605be1ea47119)
        ;

        
    
    
            circle_marker_0ca8403ee0a398bb75b6e4b95bcca399.bindTooltip(
                `<div>
                     Центросоюзный
                 </div>`,
                {"sticky": true}
            );
        
    
            var poly_line_a877a2168ed4b4b0f3e844a002b33b87 = L.polyline(
                [[55.842325, 37.670162], [55.842325, 37.670162], [55.781579, 37.688012], [55.781579, 37.688012], [55.781579, 37.688012], [55.91472, 37.76164], [55.91472, 37.76164]],
                {"bubblingMouseEvents": true, "color": "#97e3a3", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "#97e3a3", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.7, "smoothFactor": 1.0, "stroke": true, "weight": 2}
            ).addTo(feature_group_2a7d6049c6d61484171469f1b11f45f4);
        
    
            poly_line_a877a2168ed4b4b0f3e844a002b33b87.bindTooltip(
                `<div>
                     Маршрут: Маршрут №1 Север
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_831d2dbb5e0d3d82483e9925d875a58f = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_bc8f7bc81d79b09d381a22b7160d1bc8 = L.circleMarker(
                [55.730229, 37.470871],
                {"bubblingMouseEvents": true, "color": "#ac7882", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#ac7882", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_831d2dbb5e0d3d82483e9925d875a58f);
        
    
        var popup_22e08d94d7326011af3389bcfe9cfc7b = L.popup({"maxWidth": 360});

        
            var html_2be305a435c9ba998b8d005e4417bb8f = $(`<div id="html_2be305a435c9ba998b8d005e4417bb8f" style="width: 100.0%; height: 100.0%;"><b>Славянский</b><br>Оператор: Собакин Вячеслав<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 81340.19<br>Автоматов на локации: 34</div>`)[0];
            popup_22e08d94d7326011af3389bcfe9cfc7b.setContent(html_2be305a435c9ba998b8d005e4417bb8f);
        

        circle_marker_bc8f7bc81d79b09d381a22b7160d1bc8.bindPopup(popup_22e08d94d7326011af3389bcfe9cfc7b)
        ;

        
    
    
            circle_marker_bc8f7bc81d79b09d381a22b7160d1bc8.bindTooltip(
                `<div>
                     Славянский
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_5722cef74aa7400b02b2a2ec120f5e8e = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_c94bfadc45b93a8cf31d1450e071e68a = L.circleMarker(
                [55.940026, 37.520204],
                {"bubblingMouseEvents": true, "color": "#e16c64", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#e16c64", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_5722cef74aa7400b02b2a2ec120f5e8e);
        
    
        var popup_5d996a1adf06b910768a552b86f785ca = L.popup({"maxWidth": 360});

        
            var html_45b6351c79587340afa65f62b51db332 = $(`<div id="html_45b6351c79587340afa65f62b51db332" style="width: 100.0%; height: 100.0%;"><b>Долгопрудная</b><br>Оператор: Устюгов Николай<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 18116.95<br>Автоматов на локации: 15</div>`)[0];
            popup_5d996a1adf06b910768a552b86f785ca.setContent(html_45b6351c79587340afa65f62b51db332);
        

        circle_marker_c94bfadc45b93a8cf31d1450e071e68a.bindPopup(popup_5d996a1adf06b910768a552b86f785ca)
        ;

        
    
    
            circle_marker_c94bfadc45b93a8cf31d1450e071e68a.bindTooltip(
                `<div>
                     Долгопрудная
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_e3db19e9055be16a5ea1e6b551201678 = L.circleMarker(
                [55.899754, 37.54732],
                {"bubblingMouseEvents": true, "color": "#e16c64", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#e16c64", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_5722cef74aa7400b02b2a2ec120f5e8e);
        
    
        var popup_5798eca69234856a8adb0126a3259360 = L.popup({"maxWidth": 360});

        
            var html_2f097f48a777a524047faa80c453090f = $(`<div id="html_2f097f48a777a524047faa80c453090f" style="width: 100.0%; height: 100.0%;"><b>Лианозово</b><br>Оператор: Устюгов Николай<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 35227.31<br>Автоматов на локации: 20</div>`)[0];
            popup_5798eca69234856a8adb0126a3259360.setContent(html_2f097f48a777a524047faa80c453090f);
        

        circle_marker_e3db19e9055be16a5ea1e6b551201678.bindPopup(popup_5798eca69234856a8adb0126a3259360)
        ;

        
    
    
            circle_marker_e3db19e9055be16a5ea1e6b551201678.bindTooltip(
                `<div>
                     Лианозово
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_2e6ad8f8b145c6ca19e12f6691250d2d = L.circleMarker(
                [55.924999, 37.527637],
                {"bubblingMouseEvents": true, "color": "#e16c64", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#e16c64", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_5722cef74aa7400b02b2a2ec120f5e8e);
        
    
        var popup_91c1c8ed3be0eb2927a4ae296a4711ba = L.popup({"maxWidth": 360});

        
            var html_58700d0e7bc27bac2abb54545bb894f6 = $(`<div id="html_58700d0e7bc27bac2abb54545bb894f6" style="width: 100.0%; height: 100.0%;"><b>Новодачная</b><br>Оператор: Устюгов Николай<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 4969.49<br>Автоматов на локации: 5</div>`)[0];
            popup_91c1c8ed3be0eb2927a4ae296a4711ba.setContent(html_58700d0e7bc27bac2abb54545bb894f6);
        

        circle_marker_2e6ad8f8b145c6ca19e12f6691250d2d.bindPopup(popup_91c1c8ed3be0eb2927a4ae296a4711ba)
        ;

        
    
    
            circle_marker_2e6ad8f8b145c6ca19e12f6691250d2d.bindTooltip(
                `<div>
                     Новодачная
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_04e230b51c0327336f5db48c5c779761 = L.circleMarker(
                [55.84765, 37.573679],
                {"bubblingMouseEvents": true, "color": "#e16c64", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#e16c64", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_5722cef74aa7400b02b2a2ec120f5e8e);
        
    
        var popup_15fd71e01ebe36de6613dfb4e8127f4c = L.popup({"maxWidth": 360});

        
            var html_caca54a2abb9ec0d3dbf7c94fc18c575 = $(`<div id="html_caca54a2abb9ec0d3dbf7c94fc18c575" style="width: 100.0%; height: 100.0%;"><b>Окружная</b><br>Оператор: Устюгов Николай<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 65127.34<br>Автоматов на локации: 32</div>`)[0];
            popup_15fd71e01ebe36de6613dfb4e8127f4c.setContent(html_caca54a2abb9ec0d3dbf7c94fc18c575);
        

        circle_marker_04e230b51c0327336f5db48c5c779761.bindPopup(popup_15fd71e01ebe36de6613dfb4e8127f4c)
        ;

        
    
    
            circle_marker_04e230b51c0327336f5db48c5c779761.bindTooltip(
                `<div>
                     Окружная
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_212ef9daf81c5f9190d7107b08ebf3c0 = L.circleMarker(
                [55.834268, 37.631999],
                {"bubblingMouseEvents": true, "color": "#e16c64", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#e16c64", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_5722cef74aa7400b02b2a2ec120f5e8e);
        
    
        var popup_50f26b3bea1dd47138fc24df01468ba9 = L.popup({"maxWidth": 360});

        
            var html_33d96507a52a32cf3796b1a39adc67e0 = $(`<div id="html_33d96507a52a32cf3796b1a39adc67e0" style="width: 100.0%; height: 100.0%;"><b>Опера</b><br>Оператор: Устюгов Николай<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 1235.83<br>Автоматов на локации: 1</div>`)[0];
            popup_50f26b3bea1dd47138fc24df01468ba9.setContent(html_33d96507a52a32cf3796b1a39adc67e0);
        

        circle_marker_212ef9daf81c5f9190d7107b08ebf3c0.bindPopup(popup_50f26b3bea1dd47138fc24df01468ba9)
        ;

        
    
    
            circle_marker_212ef9daf81c5f9190d7107b08ebf3c0.bindTooltip(
                `<div>
                     Опера
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_2e08935ee0bbc5c79ffd602c57ef8ad1 = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var circle_marker_094d65c92cbd52e9074438dbaf38f5a1 = L.circleMarker(
                [55.7089, 37.585],
                {"bubblingMouseEvents": true, "color": "#d8a4a7", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#d8a4a7", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_2e08935ee0bbc5c79ffd602c57ef8ad1);
        
    
        var popup_045351e8cb9098ef2fea7c65deb5c2f5 = L.popup({"maxWidth": 360});

        
            var html_c2ebebcbae7d45a3bd9d2fffdfac607f = $(`<div id="html_c2ebebcbae7d45a3bd9d2fffdfac607f" style="width: 100.0%; height: 100.0%;"><b>Гагарина</b><br>Оператор: Хакимов Рамиль<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 26652.06<br>Автоматов на локации: 19</div>`)[0];
            popup_045351e8cb9098ef2fea7c65deb5c2f5.setContent(html_c2ebebcbae7d45a3bd9d2fffdfac607f);
        

        circle_marker_094d65c92cbd52e9074438dbaf38f5a1.bindPopup(popup_045351e8cb9098ef2fea7c65deb5c2f5)
        ;

        
    
    
            circle_marker_094d65c92cbd52e9074438dbaf38f5a1.bindTooltip(
                `<div>
                     Гагарина
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_f71b6bb95469e1d72eacd3b08cf8a350 = L.circleMarker(
                [55.741, 37.5338],
                {"bubblingMouseEvents": true, "color": "#d8a4a7", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#d8a4a7", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_2e08935ee0bbc5c79ffd602c57ef8ad1);
        
    
        var popup_18caf60ec7f8afddd2bdff52a4dc7804 = L.popup({"maxWidth": 360});

        
            var html_be39b4bb60a65d1ff5f8ed8e6b08d0c6 = $(`<div id="html_be39b4bb60a65d1ff5f8ed8e6b08d0c6" style="width: 100.0%; height: 100.0%;"><b>Кутузовская</b><br>Оператор: Хакимов Рамиль<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 28111.3<br>Автоматов на локации: 27</div>`)[0];
            popup_18caf60ec7f8afddd2bdff52a4dc7804.setContent(html_be39b4bb60a65d1ff5f8ed8e6b08d0c6);
        

        circle_marker_f71b6bb95469e1d72eacd3b08cf8a350.bindPopup(popup_18caf60ec7f8afddd2bdff52a4dc7804)
        ;

        
    
    
            circle_marker_f71b6bb95469e1d72eacd3b08cf8a350.bindTooltip(
                `<div>
                     Кутузовская
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_64bc38864b00afcfe57160ab422cfa20 = L.circleMarker(
                [55.750081, 37.530664],
                {"bubblingMouseEvents": true, "color": "#d8a4a7", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#d8a4a7", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_2e08935ee0bbc5c79ffd602c57ef8ad1);
        
    
        var popup_d7acc9b692e515c10aa81be76b68a38e = L.popup({"maxWidth": 360});

        
            var html_456eb9a70418abb6cebb8e4f436c189c = $(`<div id="html_456eb9a70418abb6cebb8e4f436c189c" style="width: 100.0%; height: 100.0%;"><b>Москва</b><br>Оператор: Хакимов Рамиль<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 18648.74<br>Автоматов на локации: 14</div>`)[0];
            popup_d7acc9b692e515c10aa81be76b68a38e.setContent(html_456eb9a70418abb6cebb8e4f436c189c);
        

        circle_marker_64bc38864b00afcfe57160ab422cfa20.bindPopup(popup_d7acc9b692e515c10aa81be76b68a38e)
        ;

        
    
    
            circle_marker_64bc38864b00afcfe57160ab422cfa20.bindTooltip(
                `<div>
                     Москва
                 </div>`,
                {"sticky": true}
            );
        
    
            var circle_marker_5f430b6657e2ab40cf980cabb3ff68cb = L.circleMarker(
                [55.732258, 37.520823],
                {"bubblingMouseEvents": true, "color": "#d8a4a7", "dashArray": null, "dashOffset": null, "fill": true, "fillColor": "#d8a4a7", "fillOpacity": 0.95, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "opacity": 1.0, "radius": 5, "stroke": true, "weight": 3}
            ).addTo(feature_group_2e08935ee0bbc5c79ffd602c57ef8ad1);
        
    
        var popup_a9c5a92e77dd10a50846ea2ab13ff8c6 = L.popup({"maxWidth": 360});

        
            var html_e59f80b0e9a71d7939a4bdf82e129f56 = $(`<div id="html_e59f80b0e9a71d7939a4bdf82e129f56" style="width: 100.0%; height: 100.0%;"><b>Поклонная</b><br>Оператор: Хакимов Рамиль<br>Маршрут: -<br>Класс: A | Частота: 3×/нед<br>Среднесуточные продажи (сумма): 9222.64<br>Автоматов на локации: 7</div>`)[0];
            popup_a9c5a92e77dd10a50846ea2ab13ff8c6.setContent(html_e59f80b0e9a71d7939a4bdf82e129f56);
        

        circle_marker_5f430b6657e2ab40cf980cabb3ff68cb.bindPopup(popup_a9c5a92e77dd10a50846ea2ab13ff8c6)
        ;

        
    
    
            circle_marker_5f430b6657e2ab40cf980cabb3ff68cb.bindTooltip(
                `<div>
                     Поклонная
                 </div>`,
                {"sticky": true}
            );
        
    
            var feature_group_0913fef201cf2ba95882bae04f001240 = L.featureGroup(
                {}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
    
            var layer_control_45591ec8dfc103d01761b1849d7cd3ab = {
                base_layers : {
                    "openstreetmap" : tile_layer_6e898b4075cd2e7676d2c2eca9a39422,
                },
                overlays :  {
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u0410\u043b\u0438\u0435\u0432 \u0410\u0439\u0440\u0430\u0442" : feature_group_6511f606fd47dcbae96b7341165e6072,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u0410\u043b\u0438\u0435\u0432 \u0420\u0443\u0441\u043b\u0430\u043d" : feature_group_6d456887ed388438edae8b7dbef889c9,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u0410\u043c\u0438\u043d\u043e\u0432 \u0420\u0443\u0441\u043b\u0430\u043d" : feature_group_557b5e70d013d8e76e6b53b90f4e580f,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u0411\u043e\u0433\u0434\u0430\u043d\u043e\u0432 \u0414\u0430\u043d\u0438\u043b" : feature_group_e9f3aebe8cb353f0fd4abce6ddb3fd4d,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u0411\u043e\u0433\u0434\u0430\u043d\u043e\u0432 \u0414\u0430\u043d\u0438\u043b\u0430" : feature_group_306645f5bb765d1b01fb8c2fc6aa3a4a,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u0412\u043e\u043b\u043a\u043e\u0432/\u0412\u043e\u0440\u043e\u0431\u044c\u0435\u0432" : feature_group_3b414383512d912fc30d4f89dcb1d731,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u0417\u0430\u0439\u0446\u0435\u0432 \u0414\u043c\u0438\u0442\u0440\u0438\u0439" : feature_group_8380633e7bd0b610772aa1fb0cb37564,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u0417\u0430\u043c\u043e\u043b\u043e\u0442\u043d\u0435\u0432 \u0412\u043b\u0430\u0434\u0438\u0441\u043b\u0430\u0432" : feature_group_02a76ebcabf632297a9efb51ab14cb0f,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u0418\u0437\u043c\u0430\u0438\u043b\u043e\u0432 \u0414\u0436\u0430\u0431\u0440\u0430\u0438\u043b" : feature_group_2188822284e0a7c10a7254cb13f7de73,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u041a\u043e\u0440\u043c\u0449\u0438\u043a\u043e\u0432 \u041c\u0430\u043a\u0441\u0438\u043c" : feature_group_994ae5dd0c47d35b6c9eb965fb956007,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u041a\u0443\u043c\u0430\u0447\u0435\u0432 \u0421\u0435\u0440\u0433\u0435\u0439." : feature_group_be6efe8a135fa082e24c50474ad62eb2,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u041c\u0430\u043a\u0441\u0438\u043c\u043e\u0432 \u0414\u043c\u0438\u0442\u0440\u0438\u0439" : feature_group_064f00f75d1b6c16b29cd2f3f7cfd89b,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u041d\u0430\u0437\u0430\u0440\u044f\u043d \u0412\u0430\u043d\u0438\u043a." : feature_group_5e61fd507c7cba7a50e45863c1f1dd4e,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u041d\u0430\u043c\u0430\u043a\u043e\u043d\u043e\u0432 \u041e\u043b\u0435\u0433" : feature_group_671b121e0d58d1f728cd48b0ee357bea,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u0421\u043a\u0432\u043e\u0440\u0446\u043e\u0432 \u0410\u0440\u0442\u0435\u043c" : feature_group_2a7d6049c6d61484171469f1b11f45f4,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u0421\u043e\u0431\u0430\u043a\u0438\u043d \u0412\u044f\u0447\u0435\u0441\u043b\u0430\u0432" : feature_group_831d2dbb5e0d3d82483e9925d875a58f,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u0423\u0441\u0442\u044e\u0433\u043e\u0432 \u041d\u0438\u043a\u043e\u043b\u0430\u0439" : feature_group_5722cef74aa7400b02b2a2ec120f5e8e,
                    "\u041e\u043f\u0435\u0440\u0430\u0442\u043e\u0440: \u0425\u0430\u043a\u0438\u043c\u043e\u0432 \u0420\u0430\u043c\u0438\u043b\u044c" : feature_group_2e08935ee0bbc5c79ffd602c57ef8ad1,
                    "\u0411\u0435\u0437 \u043e\u043f\u0435\u0440\u0430\u0442\u043e\u0440\u0430" : feature_group_0913fef201cf2ba95882bae04f001240,
                },
            };
            L.control.layers(
                layer_control_45591ec8dfc103d01761b1849d7cd3ab.base_layers,
                layer_control_45591ec8dfc103d01761b1849d7cd3ab.overlays,
                {"autoZIndex": true, "collapsed": false, "position": "topright"}
            ).addTo(map_07240632b07852a755665ada692280cf);
        
</script>
<button id="toggleOp">≡</button><div id="opControlWrapper" style="display: flex !important;"><div aria-haspopup="true" class="leaflet-control-layers leaflet-control-layers-expanded leaflet-control"><a class="leaflet-control-layers-toggle" href="#" title="Layers"></a><div id="extrasBar"><input id="opSearch" placeholder="Поиск по операторам..." type="search"/><div id="quickBtns"><button id="resetView">Сброс</button><button id="locateMe">Моё местоположение</button></div><div class="mini">Размер точек: <input id="sizeSlider" max="24" min="2" step="1" type="range" value="8"/></div><label class="mini"><input id="soloMode" type="checkbox"/> Соло-режим</label><label class="mini"><input id="viewportOnly" type="checkbox"/> Только в кадре</label><button id="openFullList">Открыть список на весь экран</button></div><div id="opRefreshBar"><button id="refreshOps">Обновить список операторов</button></div><div id="editBar"><label class="mini"><input id="editMode" type="checkbox"/> Режим редактирования</label><span class="mini">Выбрано: <span class="count" id="selCount">0</span></span><span class="mini">Новый оператор:</span><select id="targetOperator"><option value="Оператор: Алиев Айрат">Оператор: Алиев Айрат</option><option value="Оператор: Алиев Руслан">Оператор: Алиев Руслан</option><option value="Оператор: Аминов Руслан">Оператор: Аминов Руслан</option><option value="Оператор: Богданов Данил">Оператор: Богданов Данил</option><option value="Оператор: Богданов Данила">Оператор: Богданов Данила</option><option value="Оператор: Волков/Воробьев">Оператор: Волков/Воробьев</option><option value="Оператор: Зайцев Дмитрий">Оператор: Зайцев Дмитрий</option><option value="Оператор: Замолотнев Владислав">Оператор: Замолотнев Владислав</option><option value="Оператор: Измаилов Джабраил">Оператор: Измаилов Джабраил</option><option value="Оператор: Кормщиков Максим">Оператор: Кормщиков Максим</option><option value="Оператор: Кумачев Сергей.">Оператор: Кумачев Сергей.</option><option value="Оператор: Максимов Дмитрий">Оператор: Максимов Дмитрий</option><option value="Оператор: Назарян Ваник.">Оператор: Назарян Ваник.</option><option value="Оператор: Намаконов Олег">Оператор: Намаконов Олег</option><option value="Оператор: Скворцов Артем">Оператор: Скворцов Артем</option><option value="Оператор: Собакин Вячеслав">Оператор: Собакин Вячеслав</option><option value="Оператор: Устюгов Николай">Оператор: Устюгов Николай</option><option value="Оператор: Хакимов Рамиль">Оператор: Хакимов Рамиль</option><option value="Без оператора">Без оператора</option></select><button id="assignOp">Назначить</button><button id="showLastAssigned">Показать последние</button><button id="undoAssign">Отменить назначение</button><button id="clearOp">Без оператора</button><button id="unselectAll">Снять выделение</button><button id="exportChanges">Экспорт изменений</button></div><div id="onlyChangedWrap"><label class="mini"><input id="onlyChanged" type="checkbox"/> Показать только изменённые</label></div><div id="moveBar"><label class="mini"><input id="moveMode" type="checkbox"/> Перемещение точек</label><span class="mini" id="moveHint" style="opacity:.85">Нажми на точку → затем ткни по карте куда перенести.</span><button id="undoMove">Отменить последнее</button><button id="exportMoves">Экспорт перемещений</button></div><div id="persistBar"><button id="btnApplyNow">Применить в этой сессии</button><button id="btnSaveHTML">Скачать обновлённый HTML</button><span style="align-self:center;font-size:12px;opacity:.7">Назначения сохраняются по названию локации (1-я строка попапа)</span></div><div id="allExportBar"><button id="exportAll">Экспорт всех изменений (CSV)</button></div><div id="bulkBtns"><button id="bulkAll">Выделить всех</button><button id="bulkNone">Снять всех</button></div><section class="leaflet-control-layers-list"><div class="leaflet-control-layers-base"><label><div><input checked="checked" class="leaflet-control-layers-selector" name="leaflet-base-layers_260" type="radio"/><span> openstreetmap</span></div></label></div><div class="leaflet-control-layers-separator"></div><div id="opScroll" style="height: 422.594px; max-height: 422.594px;"><div class="leaflet-control-layers-overlays"><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Алиев Айрат</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Алиев Руслан</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Аминов Руслан</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Богданов Данил</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Богданов Данила</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Волков/Воробьев</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Зайцев Дмитрий</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Замолотнев Владислав</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Измаилов Джабраил</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Кормщиков Максим</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Кумачев Сергей.</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Максимов Дмитрий</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Назарян Ваник.</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Намаконов Олег</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Скворцов Артем</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Собакин Вячеслав</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Устюгов Николай</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Оператор: Хакимов Рамиль</span></div></label><label><div><input checked="" class="leaflet-control-layers-selector" type="checkbox"/><span> Без оператора</span></div></label></div></div></section></div></div><div id="opSheet"><div class="bar"><div class="title">Операторы</div><div><button id="sheetClose">Закрыть</button></div></div><div id="opSheetContent"></div></div></html>
