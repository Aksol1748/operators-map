<script>
(() => {
  // ======= Источники (оставил ваши) =======
  const POINTS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ60bXKqgYfT7N7M5Le0ZWLn4r1ybhUxuYwzAg4hjroeMZHUT_omLa4GwahRBfrEzlG8RKLWMhrKiOP/pub?gid=0&single=true&output=csv";
  const OPERATORS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ60bXKqgYfT7N7M5Le0ZWLn4r1ybhUxuYwzAg4hjroeMZHUT_omLa4GwahRBfrEzlG8RKLWMhrKiOP/pub?gid=304610077&single=true&output=csv";

  const badge = document.getElementById('statusBadge');
  const setBadge = (msg) => { if (badge) badge.textContent = msg; };

  // ======= Карта (без изменений) =======
  const map = L.map('map', { zoomControl: true }).setView([55.75, 37.62], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // ======= Утилиты =======
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const addCacheBuster = (url) => url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();

  // «Умная» декодировка текста
  async function decodeSmart(res) {
    const buf = await res.arrayBuffer();
    let txt = new TextDecoder('utf-8').decode(buf);
    const bads = (txt.match(/\uFFFD/g) || []).length;
    if (bads > 8) { // много � — попробуем CP1251
      try { txt = new TextDecoder('windows-1251').decode(buf); } catch {}
    }
    return txt;
  }

  // Жёсткий fetch с таймаутом
  async function hardFetch(url, { timeout = 12000 } = {}) {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), timeout);
    const res = await fetch(addCacheBuster(url), {
      signal: controller.signal,
      mode: 'cors',
      cache: 'no-store',
      credentials: 'omit',
      redirect: 'follow',
      referrerPolicy: 'no-referrer'
    });
    clearTimeout(timer);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return decodeSmart(res);
  }

  // Фолбэк-цепочка: прямой → прокси A → прокси B
  async function fetchCsvResilient(url) {
    const chain = [
      url,
      'https://cors.isomorphic-git.org/' + url,
      'https://api.allorigins.win/raw?url=' + encodeURIComponent(url),
    ];

    let lastErr = null;
    for (let i = 0; i < chain.length; i++) {
      const u = chain[i];
      try {
        setBadge(`Загрузка CSV (${i+1}/${chain.length})…`);
        const text = await hardFetch(u);
        console.info('[CSV OK]', u, text.slice(0, 120));
        return text;
      } catch (e) {
        lastErr = e;
        console.warn('[CSV FAIL]', u, e);
        setBadge(`Не вышло: ${i+1}/${chain.length} — пробуем ещё…`);
        await sleep(300 * (i + 1));
      }
    }
    throw lastErr;
  }

  const num = (v) => typeof v === 'string' ? Number(v.replace(',', '.').trim()) : Number(v);
  const norm = (s) => (s ?? '').toString().trim();
  function detectColumn(keys, candidates) {
    const lower = keys.map(k => k.toLowerCase());
    for (const c of candidates) {
      const i = lower.indexOf(c.toLowerCase());
      if (i !== -1) return keys[i];
    }
    return null;
  }

  const palette = ["#e6194B","#3cb44b","#ffe119","#4363d8","#f58231","#911eb4","#46f0f0","#f032e6",
                   "#bcf60c","#fabebe","#008080","#e6beff","#9A6324","#fffac8","#800000","#aaffc3",
                   "#808000","#ffd8b1","#000075","#808080","#000000"];
  let paletteIdx = 0; const nextColor = () => palette[(paletteIdx++) % palette.length];

  // ======= Главный поток =======
  (async function init() {
    try {
      setBadge('Грузим CSV…');
      const [pointsCsv, opsCsv] = await Promise.all([
        fetchCsvResilient(POINTS_URL),
        fetchCsvResilient(OPERATORS_URL),
      ]);

      // Парсим через Papa
      const pointsParsed = Papa.parse(pointsCsv, { header: true, skipEmptyLines: true });
      const opsParsed = Papa.parse(opsCsv, { header: true, skipEmptyLines: true });

      const pointsRaw = pointsParsed.data || [];
      const opsRaw = opsParsed.data || [];
      if (!pointsRaw.length) throw new Error('CSV точек пустой или не распознан');
      console.info('[Parsed]', { points: pointsRaw.length, ops: opsRaw.length });

      const pointKeys = Object.keys(pointsRaw[0] || {});
      const opKeys    = Object.keys(opsRaw[0] || {});

      const latKey = detectColumn(pointKeys, ['lat','latitude','широта','y','Lat']);
      const lngKey = detectColumn(pointKeys, ['lng','lon','longitude','долгота','x','Lon','Long']);
      const operatorKey = detectColumn(pointKeys, ['operator','оператор','отв.пользователь','Оператор']);
      const nameKey = detectColumn(pointKeys, ['name','название','локация','Location','Адрес']);

      if (!latKey || !lngKey) {
        console.error('Колонки координат не найдены. Доступные ключи:', pointKeys);
        setBadge('Ошибка: нет колонок lat/lng в CSV');
        return;
      }

      const opNameKey = detectColumn(opKeys, ['operator','оператор','name','имя','ФИО']);
      const opColorKey = detectColumn(opKeys, ['color','цвет','hex','код']);
      const operatorColors = new Map();
      if (opsRaw.length && opNameKey) {
        for (const row of opsRaw) {
          const name = norm(row[opNameKey]); if (!name) continue;
          const color = opColorKey ? norm(row[opColorKey]) : '';
          operatorColors.set(name, color || nextColor());
        }
      }

      const layersByOperator = new Map();
      const countsByOperator = new Map();
      const allMarkers = [];
      function layerFor(opName) {
        if (!layersByOperator.has(opName)) layersByOperator.set(opName, L.layerGroup().addTo(map));
        return layersByOperator.get(opName);
      }

      let ok = 0, bad = 0;
      for (const r of pointsRaw) {
        const lat = num(r[latKey]), lng = num(r[lngKey]);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) { bad++; continue; }
        const op = norm(r[operatorKey]) || 'Без оператора';
        const title = norm(r[nameKey]) || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        if (!operatorColors.has(op)) operatorColors.set(op, nextColor());
        const color = operatorColors.get(op);
        const marker = L.circleMarker([lat, lng], {
          radius: 7, weight: 2, opacity: 1, color: '#222', fillColor: color, fillOpacity: 0.85
        }).bindPopup(`<b>${title}</b><br>${op}`);
        layerFor(op).addLayer(marker);
        allMarkers.push(marker);
        countsByOperator.set(op, (countsByOperator.get(op) || 0) + 1);
        ok++;
      }

      if (allMarkers.length) {
        const group = L.featureGroup(allMarkers);
        map.fitBounds(group.getBounds().pad(0.2));
      }

      const uniqueOps = [...countsByOperator.keys()].sort((a,b)=>(countsByOperator.get(b)||0)-(countsByOperator.get(a)||0));
      setBadge(`${uniqueOps.length} операторов • ${ok} точек${bad ? ` • пропусков: ${bad}` : ''}`);

      // Рисуем фильтры
      const opsListEl = document.getElementById('opsList');
      const operatorsCountEl = document.getElementById('operatorsCount');
      if (operatorsCountEl) operatorsCountEl.textContent = uniqueOps.length;

      for (const op of uniqueOps) {
        const color = operatorColors.get(op) || '#999';
        const count = countsByOperator.get(op) || 0;
        const li = document.createElement('li');
        li.innerHTML = `
          <input type="checkbox" id="op_${btoa(op)}" checked />
          <span class="swatch" style="background:${color}"></span>
          <label for="op_${btoa(op)}">${op}</label>
          <span class="count">${count}</span>
        `;
        const cb = li.querySelector('input');
        cb.addEventListener('change', () => {
          const layer = layersByOperator.get(op);
          if (!layer) return;
          if (cb.checked) layer.addTo(map); else map.removeLayer(layer);
        });
        opsListEl.appendChild(li);
      }

      document.getElementById('opSearch').addEventListener('input', (e) => {
        const q = e.target.value.toLowerCase().trim();
        for (const li of opsListEl.querySelectorAll('li')) {
          const label = li.querySelector('label')?.textContent?.toLowerCase() || '';
          li.style.display = label.includes(q) ? '' : 'none';
        }
      });

    } catch (e) {
      console.error('Критическая ошибка загрузки CSV:', e);
      setBadge('Ошибка загрузки CSV (см. console)');
    }
  })();

  // Сворачивание панели (мобила — как было)
  const filters = document.getElementById('filters');
  const toggleBtn = document.getElementById('filtersToggle');
  toggleBtn?.addEventListener('click', () => filters.classList.toggle('open'));
})();
</script>
