<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ASPGroupMap — операторы поверх техников</title>
  <style>
    html, body {height:100%; margin:0;}
    #map {position:absolute; inset:0; background:#f4f4f4;}
    .status-badge{position:absolute; top:8px; right:8px; z-index:10000; background:rgba(0,0,0,.85); color:#fff; padding:6px 10px; border-radius:12px; font:500 13px/1.2 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    .filters-toggle{position:absolute; top:8px; left:8px; z-index:10001; background:#fff; border:1px solid #ddd; border-radius:10px; padding:8px 10px; font:600 13px system-ui,-apple-system,Segoe UI,Roboto,sans-serif; box-shadow:0 2px 8px rgba(0,0,0,.12); cursor:pointer;}
    aside#filters{position:absolute; top:52px; left:8px; z-index:1000; width:300px; max-width:calc(100vw - 16px); max-height:calc(100vh - 60px); overflow:auto; background:#fff; border:1px solid #ddd; border-radius:14px; box-shadow:0 6px 24px rgba(0,0,0,.15); padding:10px; font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; transition: transform .25s ease;}
    body.filters-closed aside#filters { transform: translateX(-110%); }
    #filters h3{margin:4px 6px 6px; font-size:14px; position: sticky; top:0; background:#fff; z-index:4; padding-top:6px;}
    #filters .muted{color:#666; font-size:12px; margin-left:6px;}
    .legend{display:flex; gap:10px; align-items:center; padding:6px; font-size:12px; color:#444; position: sticky; top:22px; background:#fff; z-index:3;}
    .legend .dot{width:12px; height:12px; border-radius:50%; border:1px solid #222; background:#bbb; display:inline-block;}
    .legend .tri{width:12px; height:12px; display:inline-block; clip-path: polygon(50% 0%, 0% 100%, 100% 100%); border:1px solid #222; background:#bbb;}
    .quick{display:flex; gap:6px; padding:6px; position: sticky; top:44px; background:#fff; z-index:3;}
    .quick button{flex:1 1 33%; padding:6px 8px; border:1px solid #ddd; background:#f7f7f7; border-radius:8px; font:600 12px; cursor:pointer;}
    .view-toggle{display:flex; gap:10px; align-items:center; padding:6px; position: sticky; top:78px; background:#fff; z-index:3;}
    .view-toggle label{display:flex; align-items:center; gap:6px; font-size:12px; cursor:pointer;}
    .tabs{display:flex; gap:6px; padding:6px; position: sticky; top:108px; background:#fff; z-index:2;}
    .tabs button{flex:1 1 50%; padding:6px 8px; border:1px solid #ddd; background:#f7f7f7; border-radius:8px; font:600 12px; cursor:pointer;}
    .tabs button.active{background:#fff; border-color:#bbb;}
    .toolbar{display:flex; gap:8px; margin:4px 6px 6px; position: sticky; top:140px; background:#fff; z-index:2; padding-bottom:6px;}
    .toolbar button{flex:1 1 auto; padding:6px 8px; border:1px solid #ddd; border-radius:8px; background:#f8f8f8; font:600 12px; cursor:pointer;}
    .toolbar .secondary{background:#fff;}
    .search{margin:6px; position: sticky; top:174px; background:#fff; z-index:2; padding-bottom:6px;}
    .search input{width:100%; padding:6px 8px; border:1px solid #ddd; border-radius:8px;}
    #opsList, #techList{list-style:none; margin:8px 6px 10px; padding:0;}
    #opsList li, #techList li{display:flex; align-items:center; gap:8px; padding:6px 0;}
    .swatch{width:14px; height:14px; border-radius:50%; border:1px solid rgba(0,0,0,.2); flex:0 0 14px;}
    .swatch.tri{border-radius:3px; clip-path: polygon(50% 0%, 0% 100%, 100% 100%);}
    .count{margin-left:auto; color:#888; font-size:12px;}
    .fatal {position:absolute; left:8px; right:8px; bottom:8px; z-index:10002; background:#fff; border:1px solid #ddd; border-radius:12px; padding:10px; font:14px system-ui,-apple-system,Segoe UI,Roboto,sans-serif; box-shadow:0 2px 8px rgba(0,0,0,.12);}
    .leaflet-control-attribution a[href*="leafletjs.com"]{ display:none !important; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="status-badge" id="statusBadge">Загрузка…</div>
  <button class="filters-toggle" id="filtersToggle">Фильтры</button>

  <aside id="filters" aria-label="Фильтры">
    <h3>Списки <span class="muted" id="totals"></span></h3>

    <div class="legend">
      <span class="dot"></span> — оператор
      <span class="tri"></span> — техник
    </div>

    <div class="quick">
      <button id="qOnlyOps">Только операторы</button>
      <button id="qOnlyTech">Только техники</button>
      <button id="qBoth">Оба</button>
    </div>

    <div class="view-toggle">
      <label><input type="checkbox" id="toggleOps" checked>Операторы</label>
      <!-- старт: техники выключены -->
      <label><input type="checkbox" id="toggleTech">Техники</label>
    </div>

    <div class="tabs">
      <button id="tabOps" class="active">Операторы</button>
      <button id="tabTech">Техники</button>
    </div>

    <div class="toolbar">
      <button id="btnShowAll">Показать всех</button>
      <button id="btnHideAll" class="secondary">Скрыть всех</button>
    </div>

    <div class="search"><input id="searchBox" placeholder="Поиск по активной вкладке…"/></div>

    <ul id="opsList"></ul>
    <ul id="techList" style="display:none;"></ul>
  </aside>

  <noscript>Нужен JavaScript</noscript>

<script type="module">
/* btoa shim */
(function(){ const native = window.btoa ? window.btoa.bind(window) : null;
  window.btoa = function(s){ try { return native ? native(s) : ''; } catch(e) { return native ? native(unescape(encodeURIComponent(s))) : ''; } };
})();

/* === Док и листы === */
const DOC_ID = "2PACX-1vQ60bXKqgYfT7N7M5Le0ZWLn4r1ybhUxuYwzAg4hjroeMZHUT_omLa4GwahRBfrEzlG8RKLWMhrKiOP";
const POINTS_PUB = `https://docs.google.com/spreadsheets/d/e/${DOC_ID}/pub?gid=0&single=true&output=csv`;
const POINTS_EXP = `https://docs.google.com/spreadsheets/d/${DOC_ID}/export?format=csv&id=${DOC_ID}&gid=0`;
const OPER_PUB   = `https://docs.google.com/spreadsheets/d/e/${DOC_ID}/pub?gid=304610077&single=true&output=csv`;
const OPER_EXP   = `https://docs.google.com/spreadsheets/d/${DOC_ID}/export?format=csv&id=${DOC_ID}&gid=304610077`;

/* UI helpers */
const badge = document.getElementById('statusBadge');
const setBadge = (msg) => badge.textContent = msg;
function showFatal(title, links){
  setBadge('Ошибка');
  const d=document.createElement('div'); d.className='fatal';
  let html = `<b>Критическая ошибка</b><br>${title}`;
  if(links){
    html += `<div style="margin-top:6px;font-size:12px">CSV: `;
    html += links.map(([label,url])=>`<a href="${url}" target="_blank" rel="noopener">${label}</a>`).join(' • ');
    html += `</div>`;
  }
  d.innerHTML = html; document.body.appendChild(d);
}

/* === Мульти-CDN === */
function addBuster(u){ return u + (u.includes('?')?'&':'?') + 'v=' + Date.now(); }
async function loadStyleChain(list){ let last=null; for(const href of list){ try{ await new Promise((res,rej)=>{const l=document.createElement('link');l.rel='stylesheet';l.href=addBuster(href);l.onload=res;l.onerror=()=>rej(new Error(href));document.head.appendChild(l);}); return; }catch(e){ last=e; } } throw last||new Error('CSS fail'); }
async function loadScriptChain(list){ let last=null; for(const src of list){ try{ await new Promise((res,rej)=>{const s=document.createElement('script');s.src=addBuster(src);s.async=true;s.onload=res;s.onerror=()=>rej(new Error(src));document.head.appendChild(s);}); return; }catch(e){ last=e; } } throw last||new Error('JS fail'); }

setBadge('Грузим библиотеки…');
await loadStyleChain([
  'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css',
  'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css',
  'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css'
]);
await loadScriptChain([
  'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js',
  'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
  'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js'
]);
await loadScriptChain([
  'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js',
  'https://unpkg.com/papaparse@5.4.1/papaparse.min.js',
  'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js'
]);
if(!window.L || !window.Papa){ showFatal('Не загрузились Leaflet/PapaParse.'); throw new Error('libs-missing'); }

/* === Карта + pane'ы === */
const map = L.map('map', { attributionControl: false }).setView([55.75,37.62],9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'© OpenStreetMap contributors' }).addTo(map);
L.control.attribution({prefix:false}).addTo(map);

/* два отдельных pane: техники ниже, операторы выше */
map.createPane('techPane');  map.getPane('techPane').style.zIndex = 430;
map.createPane('opPane');    map.getPane('opPane').style.zIndex   = 450;

/* === Резильентная загрузка CSV === */
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
function proxyChain(url){
  return [
    addBuster(url),
    'https://r.jina.ai/http/' + url.replace(/^https?:\/\//,''),
    'https://cors.isomorphic-git.org/' + url,
    'https://api.allorigins.win/raw?url=' + encodeURIComponent(url)
  ];
}
async function fetchCsvMany(urls, label){
  let lastErr=null;
  for(const base of urls){
    for(const u of proxyChain(base)){
      try{
        setBadge(`Загрузка ${label}…`);
        const c=new AbortController(); const t=setTimeout(()=>c.abort(), 12000);
        const r=await fetch(u,{signal:c.signal,cache:'no-store',credentials:'omit'}); clearTimeout(t);
        if(!r.ok) throw new Error('HTTP '+r.status);
        const text=await r.text();
        if(!text || text.length<5) throw new Error('Пустой ответ');
        if(/^<!doctype|^<html/i.test(text.trim())) throw new Error('HTML вместо CSV');
        return text;
      }catch(e){ lastErr=e; await sleep(350); }
    }
  }
  throw lastErr || new Error('CSV load failed');
}

/* === Утилиты === */
const num  = (v)=> typeof v==='string'?Number(v.replace(',','.').trim()):Number(v);
const norm = (s)=> (s??'').toString().trim();
function detect(keys, cands){ const lower=keys.map(k=>k.toLowerCase()); for(const c of cands){ const i=lower.indexOf(c.toLowerCase()); if(i!==-1) return keys[i]; } for(const k of keys){ const lk=k.toLowerCase(); if(cands.some(c=>lk.includes(c.toLowerCase()))) return k; } return null; }
const safeId = (str)=> 'id_'+Array.from(str).map(ch=>ch.charCodeAt(0).toString(16)).join('');
const splitMany = (s)=> norm(s).split(/[,\|;/]/).map(x=>x.trim()).filter(Boolean);

/* === Глобальное состояние === */
const ST = { opLayers:new Map(), opCounts:new Map(), opList:[], techLayers:new Map(), techCounts:new Map(), techList:[] };
function layerFor(mapObj, name){ if(!mapObj.has(name)) mapObj.set(name, L.layerGroup().addTo(map)); return mapObj.get(name); }
function getVisibleBounds(){
  const groups=[];
  for(const [n,lg] of ST.techLayers){ const el=document.getElementById(safeId('tech:'+n)); if(document.getElementById('toggleTech').checked && el?.checked) groups.push(lg); }
  for(const [n,lg] of ST.opLayers){ const el=document.getElementById(safeId('op:'+n)); if(document.getElementById('toggleOps').checked && el?.checked) groups.push(lg); }
  if(!groups.length) return null;
  const fs = groups.map(g=>L.featureGroup(g.getLayers()));
  return fs.reduce((acc,g)=> acc? acc.extend(g.getBounds()): g.getBounds(), null);
}
function animateToVisible(){ const b=getVisibleBounds(); if(b && b.isValid()) map.flyToBounds(b.pad(0.2),{duration:0.8,easeLinearity:0.25}); }

/* === Маркеры === */
function triangleMarker(latlng, color){
  const svg = `<svg width="22" height="22" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
    <polygon points="12,3 2,21 22,21" fill="${color}" stroke="#222" stroke-width="2"/></svg>`;
  const icon = L.divIcon({ html: svg, className:'', iconSize:[22,22], iconAnchor:[11,18] });
  return L.marker(latlng,{ icon, pane:'techPane' });
}

try{
  const pointsCsv = await fetchCsvMany([POINTS_PUB, POINTS_EXP], 'точек');
  const opsCsv    = await fetchCsvMany([OPER_PUB,   OPER_EXP],   'операторов');

  const points = Papa.parse(pointsCsv,{header:true,skipEmptyLines:true}).data || [];
  const ops    = Papa.parse(opsCsv,{header:true,skipEmptyLines:true}).data || [];
  if(!points.length){ showFatal('CSV точек пуст', [['points (pub)',POINTS_PUB],['points (export)',POINTS_EXP]]); throw new Error('no points'); }

  const pKeys=Object.keys(points[0]||{});
  const oKeys=Object.keys(ops[0]||{});

  const latKey   = detect(pKeys,['lat','latitude','широта','y']);
  const lngKey   = detect(pKeys,['lng','lon','longitude','долгота','x']);
  const nameKey  = detect(pKeys,['name','название','локация','адрес']);
  const opKey    = detect(pKeys,['operator','оператор','отв.пользователь']);
  const techKey  = detect(pKeys,['technician','tech','тех']);

  const opNameKey = detect(oKeys,['operator','оператор','фио','name']);
  const opColorKey= detect(oKeys,['color','цвет','hex']);

  if(!latKey || !lngKey){
    showFatal('Не найдены столбцы широты/долготы.', [['points (pub)',POINTS_PUB],['points (export)',POINTS_EXP]]);
    throw new Error('no lat/lng');
  }

  // палитры
  const paletteOps  = ["#e6194B","#3cb44b","#ffe119","#4363d8","#f58231","#911eb4","#46f0f0","#f032e6","#bcf60c","#fabebe","#008080","#e6beff","#9A6324","#fffac8","#800000","#aaffc3","#808000","#ffd8b1","#000075","#808080","#000000"];
  const paletteTech = ["#2E86AB","#FF7F50","#7D3C98","#2ECC71","#E67E22","#1ABC9C","#D35400","#C0392B","#16A085","#AF7AC5","#5DADE2","#45B39D","#52BE80","#F4D03F","#DC7633","#626567"];
  let iOp=0, iTech=0; const nextOp=()=>paletteOps[(iOp++)%paletteOps.length]; const nextTech=()=>paletteTech[(iTech++)%paletteTech.length];

  const opColors = new Map();
  for(const row of ops){ const n=norm(row[opNameKey]); if(!n) continue; opColors.set(n, norm(row[opColorKey]) || nextOp()); }
  const techColors = new Map(); const colorForTech=(n)=>{ if(!techColors.has(n)) techColors.set(n, nextTech()); return techColors.get(n); };

  let ok=0,bad=0; const all=[];
  for(const r of points){
    const lat=num(r[latKey]), lng=num(r[lngKey]);
    if(!isFinite(lat)||!isFinite(lng)){ bad++; continue; }
    const title = norm(r[nameKey]) || `${lat.toFixed(4)}, ${lng.toFixed(4)}`;

    // техники: собираем (по умолчанию не показываем)
    if(techKey){
      const techs = splitMany(r[techKey]);
      for(const t of techs){
        const col=colorForTech(t);
        const tm = triangleMarker([lat,lng], col).bindPopup(`<b>${title}</b><br>Техник: ${t}`);
        layerFor(ST.techLayers, t).addLayer(tm);
        ST.techCounts.set(t,(ST.techCounts.get(t)||0)+1); all.push(tm);
      }
    }

    // операторы: показываем сразу
    const op = norm(r[opKey]) || 'Без оператора';
    const opColor = opColors.get(op) || (opColors.set(op,nextOp()), opColors.get(op));
    const cm = L.circleMarker([lat,lng],{ pane:'opPane', radius:7, weight:2, color:'#222', fillColor:opColor, fillOpacity:.9 })
      .bindPopup(`<b>${title}</b><br>Оператор: ${op}`);
    layerFor(ST.opLayers, op).addLayer(cm);
    ST.opCounts.set(op,(ST.opCounts.get(op)||0)+1); all.push(cm); ok++;
  }

  if(all.length){ const g=L.featureGroup(all); map.fitBounds(g.getBounds().pad(0.2)); }

  ST.opList   = [...ST.opCounts.keys()].sort((a,b)=>(ST.opCounts.get(b)||0)-(ST.opCounts.get(a)||0));
  ST.techList = [...ST.techCounts.keys()].sort((a,b)=>(ST.techCounts.get(b)||0)-(ST.techCounts.get(a)||0));

  document.getElementById('totals').textContent =
    `${ST.opList.length} операторов • ${ST.techList.length} техников • ${ok} точек${bad?` • пропусков:${bad}`:''}`;
  setBadge(`${ST.opList.length} операторов • ${ST.techList.length} техников • ${ok} точек`);

  /* списки */
  const opsList = document.getElementById('opsList');
  const techList= document.getElementById('techList');

  function addRow(targetUl, kind, name, color, count, initiallyChecked){
    const id = safeId(`${kind}:${name}`);
    const sw = kind==='tech' ? 'swatch tri' : 'swatch';
    const li = document.createElement('li');
    li.innerHTML = `<input type="checkbox" id="${id}">
      <span class="${sw}" style="background:${color}"></span>
      <label for="${id}">${name}</label>
      <span class="count">${count}</span>`;
    const cb = li.querySelector('input');
    cb.checked = initiallyChecked;

    const mapObj = (kind==='tech') ? ST.techLayers : ST.opLayers;
    if (initiallyChecked) mapObj.get(name).addTo(map); else map.removeLayer(mapObj.get(name));

    cb.onchange = () => {
      const layer = mapObj.get(name);
      if(cb.checked) layer.addTo(map); else map.removeLayer(layer);
      const b=getVisibleBounds(); if(b&&b.isValid()) map.panInsideBounds(b.pad(0.2));
    };
    targetUl.appendChild(li);
  }

  const INIT_OPS_CHECKED  = true;
  const INIT_TECH_CHECKED = false;

  for(const op of ST.opList)  addRow(opsList,  'op',   op,  opColors.get(op)||'#999', ST.opCounts.get(op)||0,  INIT_OPS_CHECKED);
  for(const t  of ST.techList)addRow(techList, 'tech', t,  colorForTech(t),            ST.techCounts.get(t)||0, INIT_TECH_CHECKED);

  /* верхние переключатели */
  const toggleOps  = document.getElementById('toggleOps');
  const toggleTech = document.getElementById('toggleTech');
  toggleOps.checked  = INIT_OPS_CHECKED;
  toggleTech.checked = INIT_TECH_CHECKED;

  function applyTopToggles(){
    for(const [n,lg] of ST.opLayers){
      const el=document.getElementById(safeId('op:'+n));
      if(toggleOps.checked){ if(el?.checked) lg.addTo(map);} else map.removeLayer(lg);
    }
    for(const [n,lg] of ST.techLayers){
      const el=document.getElementById(safeId('tech:'+n));
      if(toggleTech.checked){ if(el?.checked) lg.addTo(map);} else map.removeLayer(lg);
    }
  }
  toggleOps.onchange  = applyTopToggles;
  toggleTech.onchange = applyTopToggles;

  /* вкладки */
  let activeTab='ops';
  const tabOpsBtn=document.getElementById('tabOps');
  const tabTechBtn=document.getElementById('tabTech');
  const searchBox=document.getElementById('searchBox');
  function setTab(tab){
    activeTab=tab;
    tabOpsBtn.classList.toggle('active', tab==='ops');
    tabTechBtn.classList.toggle('active', tab==='tech');
    opsList.style.display  = tab==='ops'  ? '' : 'none';
    techList.style.display = tab==='tech' ? '' : 'none';
    searchBox.value=''; for(const ul of [opsList, techList]) for(const li of ul.children) li.style.display='';
  }
  tabOpsBtn.onclick = ()=>setTab('ops');
  tabTechBtn.onclick= ()=>setTab('tech');

  /* поиск по активной вкладке */
  searchBox.oninput=(e)=>{
    const q=e.target.value.toLowerCase().trim();
    const ul= activeTab==='ops' ? opsList : techList;
    for(const li of ul.children){
      const t=li.querySelector('label').textContent.toLowerCase();
      li.style.display = t.includes(q) ? '' : 'none';
    }
  };

  /* быстрый тумблер */
  document.getElementById('qOnlyOps').onclick = ()=>{
    toggleOps.checked = true;  toggleTech.checked = false;
    // включить все чекбоксы операторов, выключить все у техников
    for(const name of ST.opList){ const cb=document.getElementById(safeId('op:'+name)); if(cb && !cb.checked) cb.checked=true; }
    for(const name of ST.techList){ const cb=document.getElementById(safeId('tech:'+name)); if(cb && cb.checked) cb.checked=false; }
    applyTopToggles(); animateToVisible();
  };
  document.getElementById('qOnlyTech').onclick = ()=>{
    toggleOps.checked = false; toggleTech.checked = true;
    for(const name of ST.opList){ const cb=document.getElementById(safeId('op:'+name)); if(cb && cb.checked) cb.checked=false; }
    for(const name of ST.techList){ const cb=document.getElementById(safeId('tech:'+name)); if(cb && !cb.checked) cb.checked=true; }
    applyTopToggles(); animateToVisible();
  };
  document.getElementById('qBoth').onclick = ()=>{
    toggleOps.checked = true;  toggleTech.checked = true;
    // ничего не меняем у индивидуальных чекбоксов — просто включаем группы
    applyTopToggles(); animateToVisible();
  };

  /* массовые кнопки по вкладке */
  document.getElementById('btnShowAll').onclick=()=>{
    const list = activeTab==='ops' ? ST.opList : ST.techList;
    const mapObj = activeTab==='ops' ? ST.opLayers : ST.techLayers;
    const pref = activeTab==='ops' ? 'op:' : 'tech:';
    for(const name of list){
      const id=safeId(pref+name), cb=document.getElementById(id);
      if(cb && !cb.checked){ cb.checked=true; if((activeTab==='ops' && toggleOps.checked) || (activeTab==='tech' && toggleTech.checked)) mapObj.get(name).addTo(map); }
    }
    animateToVisible();
  };
  document.getElementById('btnHideAll').onclick=()=>{
    const list = activeTab==='ops' ? ST.opList : ST.techList;
    const mapObj = activeTab==='ops' ? ST.opLayers : ST.techLayers;
    const pref = activeTab==='ops' ? 'op:' : 'tech:';
    for(const name of list){
      const id=safeId(pref+name), cb=document.getElementById(id);
      if(cb && cb.checked){ cb.checked=false; map.removeLayer(mapObj.get(name)); }
    }
  };

}catch(e){
  console.error(e);
  showFatal('Не удалось инициализировать: ' + (e.message || e), [
    ['points (pub)', POINTS_PUB], ['points (export)', POINTS_EXP],
    ['operators (pub)', OPER_PUB], ['operators (export)', OPER_EXP]
  ]);
}

/* Сворачивание панели */
document.getElementById('filtersToggle').onclick=()=>{ document.body.classList.toggle('filters-closed'); };
</script>
</body>
</html>
