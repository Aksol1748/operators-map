<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Карта операторов</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .leaflet-popup-content { font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ВСТАВЬ СЮДА свой URL веб-приложения, который отдаёт JSON
    const DATA_URL = 'https://script.google.com/macros/s/AKfycbx4cRvIJBKjs9sxfLOUYB9Im6z2dsXwKEjmN8dammHdQJBCzy2OI4UkT4Qrp-at72t13w/exec';

    // 1) создаём карту
    const map = L.map('map', { zoomControl: true }).setView([55.75, 37.62], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '© OpenStreetMap'
    }).addTo(map);

    // 2) загружаем JSON и рисуем точки
    (async () => {
      try {
        const res  = await fetch(DATA_URL + '?t=' + Date.now()); // отключаем кеш
        const data = await res.json();

        const layer = L.layerGroup().addTo(map);
        const bounds = [];

        for (const p of data.points || []) {
          const lat = Number(p.lat), lng = Number(p.lng);
          if (!isFinite(lat) || !isFinite(lng)) continue;

          L.circleMarker([lat, lng], {
            radius: 6, weight: 1, color: '#2d6cdf', fillColor: '#2d6cdf', fillOpacity: 0.85
          })
          .bindPopup(
            `<b>${p.name ?? ''}</b><br>` +
            `${p.operator ?? ''}` +
            (p.class ? `<br>Класс: ${p.class}` : '') +
            (p.freq  ? `<br>Частота: ${p.freq}` : '') +
            (p.sales ? `<br>Продажи: ${p.sales}` : '')
          )
          .addTo(layer);

          bounds.push([lat, lng]);
        }

        if (bounds.length) map.fitBounds(bounds, { padding: [20, 20] });
        console.log('Операторов:', (data.operators || []).length, 'Точек:', (data.points || []).length);
      } catch (e) {
        console.error('Ошибка загрузки данных:', e);
        alert('Не удалось загрузить данные. Проверь DATA_URL и доступ «Anyone» у веб-приложения.');
      }
    })();
  </script>
</body>
</html>
