<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ASPGroupMap — один лист «Маршруты»</title>
<style>
  html,body{height:100%;margin:0}
  #map{position:absolute;inset:0;background:#f4f4f4}
  .status-badge{position:absolute;top:8px;right:8px;z-index:10000;background:rgba(0,0,0,.85);color:#fff;padding:6px 10px;border-radius:12px;font:500 13px/1.2 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .filters-toggle{position:absolute;top:8px;left:8px;z-index:10001;background:#fff;border:1px solid #ddd;border-radius:10px;padding:8px 10px;font:600 13px system-ui,-apple-system,Segoe UI,Roboto,sans-serif;box-shadow:0 2px 8px rgba(0,0,0,.12);cursor:pointer}
  aside#filters{position:absolute;top:52px;left:8px;z-index:1000;width:320px;max-width:calc(100vw - 16px);max-height:calc(100vh - 60px);overflow:auto;background:#fff;border:1px solid #ddd;border-radius:14px;box-shadow:0 6px 24px rgba(0,0,0,.15);padding:10px;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;transition:transform .25s ease}
  body.filters-closed aside#filters{transform:translateX(-110%)}
  #filters h3{margin:4px 6px 6px;font-size:14px;position:sticky;top:0;background:#fff;z-index:3;padding-top:6px}
  #filters .muted{color:#666;font-size:12px;margin-left:6px}
  .view-toggle{display:flex;gap:10px;align-items:center;padding:6px;position:sticky;top:28px;background:#fff;z-index:3}
  .view-toggle label{display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer}
  .tabs{display:flex;gap:6px;padding:6px;position:sticky;top:60px;background:#fff;z-index:2}
  .tabs button{flex:1 1 33%;padding:6px 8px;border:1px solid #ddd;background:#f7f7f7;border-radius:8px;font:600 12px;cursor:pointer}
  .tabs button.active{background:#fff;border-color:#bbb}
  .toolbar{display:flex;gap:8px;margin:4px 6px 6px;position:sticky;top:92px;background:#fff;z-index:2;padding-bottom:6px}
  .toolbar button{flex:1 1 auto;padding:6px 8px;border:1px solid #ddd;border-radius:8px;background:#f8f8f8;font:600 12px;cursor:pointer}
  #opsList,#techList{list-style:none;margin:8px 6px 10px;padding:0}
  #opsList li,#techList li{display:flex;align-items:center;gap:8px;padding:6px 0}
  .swatch{width:14px;height:14px;border-radius:50%;border:1px solid rgba(0,0,0,.2);flex:0 0 14px;cursor:pointer;position:relative}
  .swatch.tri{border-radius:3px;clip-path:polygon(50% 0%,0% 100%,100% 100%)}
  .swatch input[type=color]{position:absolute;inset:0;opacity:0;cursor:pointer}
  .count{margin-left:auto;color:#888;font-size:12px}
  .route-box{border-top:1px dashed #e3e3e3;margin:6px;padding:10px 6px 4px}
  .route-row{display:flex;gap:8px;margin:6px 0}
  .route-row select,.route-row button{flex:1 1 auto;padding:6px 8px;border:1px solid #ddd;border-radius:8px;background:#fff;font:600 12px;cursor:pointer}
  .route-row button.primary{background:#2f80ed;color:#fff;border-color:#2f80ed}
  .route-actions{display:flex;gap:8px;margin:6px 0}
  .route-actions button{flex:1 1 auto;padding:6px 8px;border:1px solid #ddd;border-radius:8px;background:#f8f8f8;font:600 12px;cursor:pointer}
  .route-meta{font-size:12px;color:#555;margin:4px 0 0 2px}
  .fatal{position:absolute;left:8px;right:8px;bottom:8px;z-index:10002;background:#fff;border:1px solid #ddd;border-radius:12px;padding:10px;font:14px system-ui,-apple-system,Segoe UI,Roboto,sans-serif;box-shadow:0 2px 8px rgba(0,0,0,.12)}
  .leaflet-control-attribution a[href*="leafletjs.com"]{display:none!important}
  .route-index{background:#222;color:#fff;border-radius:10px;font:700 11px/16px system-ui;width:16px;height:16px;text-align:center;display:inline-block;transform:translate(-9px,-9px);pointer-events:none}
  .leaflet-tooltip.mini-label{pointer-events:none;background:rgba(255,255,255,.9);color:#111;border:1px solid rgba(0,0,0,.15);padding:1px 4px;border-radius:6px;font:600 11px/1.1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;box-shadow:0 1px 2px rgba(0,0,0,.08);z-index:8000}
  /* утилиты для попапов смены */
  .as-link{color:#2f80ed;cursor:pointer;text-decoration:underline;font-weight:600}
  .picker{display:none;margin-top:6px}
  .picker select{padding:6px 8px;border:1px solid #ddd;border-radius:8px;font:600 12px system-ui}
  .picker button{margin-left:6px;padding:6px 8px;border:1px solid #ddd;border-radius:8px;background:#f8f8f8;font:600 12px;cursor:pointer}
</style>
</head>
<body>
<div id="map"></div>
<div class="status-badge" id="statusBadge">Загрузка…</div>
<button class="filters-toggle" id="filtersToggle">Фильтры</button>

<aside id="filters" aria-label="Фильтры">
  <h3>Списки <span class="muted" id="totals"></span></h3>

  <div class="view-toggle">
    <label><input type="checkbox" id="toggleOps" checked>Операторы</label>
    <label><input type="checkbox" id="toggleTech">Техники</label>
  </div>

  <div class="tabs">
    <button id="tabOps" class="active">Операторы</button>
    <button id="tabTech">Техники</button>
    <button id="tabRoute">Маршруты</button>
  </div>

  <div class="toolbar">
    <button id="btnShowAll">Показать всех</button>
    <button id="btnHideAll">Скрыть всех</button>
  </div>

  <ul id="opsList"></ul>
  <ul id="techList" style="display:none"></ul>

  <!-- Панель построения маршрута -->
  <div id="routePanel" class="route-box" style="display:none">
    <div class="route-row">
      <select id="routeRole">
        <option value="op" selected>Операторы</option>
        <option value="tech">Техники</option>
      </select>
      <select id="routeName">
        <option value="" selected disabled>— выберите —</option>
      </select>
    </div>
    <div class="route-row">
      <select id="routeDay">
        <option value="TODAY">Сегодня</option>
        <option value="ALL" selected>Все дни</option>
        <option value="Пн">Пн</option><option value="Вт">Вт</option><option value="Ср">Ср</option>
        <option value="Чт">Чт</option><option value="Пт">Пт</option><option value="Сб">Сб</option><option value="Вс">Вс</option>
      </select>
    </div>
    <div class="route-row">
      <button id="btnBuild" class="primary">Построить маршрут</button>
      <button id="btnClear">Очистить</button>
    </div>
    <div class="route-actions">
      <button id="btnDownload" disabled>Скачать CSV</button>
    </div>
    <div id="routeMeta" class="route-meta">Маршрут не построен.</div>
    <div class="route-meta">⚠️ По дорогам (OSRM), без пробок.</div>
  </div>

  <!-- Панель несохранённых изменений (fallback, если нет SAVE_URL) -->
  <div id="changesPanel" class="route-box" style="display:none">
    <div class="route-row" style="gap:6px;flex-wrap:wrap">
      <strong style="font-size:13px">Изменения (не сохранены):</strong>
      <div id="changesList" style="width:100%;max-height:180px;overflow:auto;border:1px dashed #ddd;border-radius:8px;padding:6px 8px;font:12px/1.35 system-ui"></div>
    </div>
    <div class="route-actions">
      <button id="btnRevertAll" title="Откатить все несохранённые изменения">Откатить</button>
      <button id="btnExportCSV" title="Скачать список изменений CSV">Экспорт CSV</button>
      <button id="btnConfirmAll" class="primary" title="Отправить изменения в таблицу">Подтвердить</button>
    </div>
    <div class="route-meta" id="changesHint">Для записи в таблицу нужен URL скрипта. Пока доступен экспорт CSV.</div>
  </div>
</aside>

<noscript>Нужен JavaScript</noscript>

<script type="module">
/* btoa-shim для старых браузеров */
(function(){const n=window.btoa?window.btoa.bind(window):null;window.btoa=function(s){try{return n?n(s):''}catch(e){return n?n(unescape(encodeURIComponent(s))):''}}})();
/* === КОНФИГ === */
const DOC_ID="2PACX-1vQ60bXKqgYfT7N7M5Le0ZWLn4r1ybhUxuYwzAg4hjroeMZHUT_omLa4GwahRBfrEzlG8RKLWMhrKiOP";
const ROUTES_CSV=`https://docs.google.com/spreadsheets/d/e/${DOC_ID}/pub?gid=1063730162&single=true&output=csv`;

/* синхронизация цветов (опционально) */
const COLOR_SYNC_URL="https://script.google.com/macros/s/AKfycbx6CILKNKa2466bOsKkWzXjrTBd0-zNNIqwrMsEVWV6KdIFLc4gkqlKOCLpvt81y9e0ZQ/exec";
const ENABLE_SYNC=!!COLOR_SYNC_URL&&/^https?:\/\//.test(COLOR_SYNC_URL);
const COLOR_SYNC_GET=ENABLE_SYNC?("https://r.jina.ai/http/"+COLOR_SYNC_URL.replace(/^https?:\/\//,"")):"";

/* адрес Apps Script для записи изменений */
const SAVE_URL='https://script.google.com/macros/s/AKfycbw1WkvohPWKQK3K8ATGMFaxRvX2k9Cgh7yxt6P2gPb0MAtzX1C--I6UN72rHuOLiB-Igw/exec'; // ← поставь URL веб-приложения GAS; если пусто — будет режим «Подтвердить/Экспорт CSV»
const HAS_SAVE=typeof SAVE_URL==='string' && /^https?:\/\//.test(SAVE_URL);

/* === УТИЛИТЫ === */
const badge=document.getElementById("statusBadge");
const setBadge=(msg)=>{badge.textContent=msg};

async function loadStyle(href){await new Promise((resolve,reject)=>{const el=document.createElement("link");el.rel="stylesheet";el.href=href;el.onload=resolve;el.onerror=reject;document.head.appendChild(el);});}
async function loadScript(src){await new Promise((resolve,reject)=>{const el=document.createElement("script");el.src=src;el.onload=resolve;el.onerror=reject;document.head.appendChild(el);});}
function addBuster(url){return url+(url.includes("?")?"&":"?")+"v="+Date.now();}
async function fetchCsv(url){
  const resp=await fetch(addBuster(url),{cache:"no-store"});
  if(!resp.ok) throw new Error("HTTP "+resp.status);
  const text=await resp.text();
  if(/^</.test(text)) throw new Error("HTML вместо CSV");
  return text;
}
const toNum=(v)=>typeof v==="string"?Number(v.replace(",",".").trim()):Number(v);
const norm=(s)=>String(s??"").trim();
function detect(keys,cands){
  const lower=keys.map(k=>k.toLowerCase());
  for(const cand of cands){const idx=lower.indexOf(cand.toLowerCase()); if(idx!==-1) return keys[idx];}
  for(const k of keys){const lk=k.toLowerCase(); if(cands.some(cc=>lk.includes(cc.toLowerCase()))) return k;}
  return null;
}
const safeId=(str)=>"id_"+Array.from(str).map(ch=>ch.charCodeAt(0).toString(16)).join("");
function djb2(str){let h=5381;for(let i=0;i<str.length;i++){h=((h<<5)+h)+str.charCodeAt(i);h|=0;}return Math.abs(h);}
function hslToHex(h,s,l){
  h/=360; s/=100; l/=100;
  const q = l<.5 ? l*(1+s) : l+s-l*s, p = 2*l - q;
  const hue = (x)=>{ if(x<0)x+=1; if(x>1)x-=1;
    if(x<1/6) return p+(q-p)*6*x;
    if(x<1/2) return q;
    if(x<2/3) return p+(q-p)*(2/3-x)*6;
    return p;
  };
  const r=Math.round(255*hue(h+1/3)),
        g=Math.round(255*hue(h)),
        b=Math.round(255*hue(h-1/3));
  return `#${r.toString(16).padStart(2,"0")}${g.toString(16).padStart(2,"0")}${b.toString(16).padStart(2,"0")}`;
}
const autoColor=(key)=>{const h=djb2(key.toLowerCase());return hslToHex(h%360,55+(h%30),45+((h/7|0)%20));};

/* === СИНХРОН ЦВЕТОВ === */
const LS_KEY="operators-map:colors";
function loadLocal(){try{return JSON.parse(localStorage.getItem(LS_KEY)||"{}");}catch{return{}}}
function saveLocal(obj){localStorage.setItem(LS_KEY,JSON.stringify(obj));}
const savedLocal=loadLocal();
async function loadRemoteColors(){
  if(!ENABLE_SYNC) return {};
  try{
    const resp=await fetch(COLOR_SYNC_GET,{cache:"no-store"});
    const txt=await resp.text();
    const data=JSON.parse(txt);
    return data&&data.ok?(data.colors||{}):{};
  }catch{return {}}
}
async function saveRemoteColor(kind,name,color){
  if(!ENABLE_SYNC) return;
  try{
    await fetch(COLOR_SYNC_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({kind,name,color})});
  }catch{}
}
function getColor(kind,name,base){const key=`${kind}:${name}`;return savedLocal[key]||base||autoColor(key);}
function setColor(kind,name,hex){const key=`${kind}:${name}`;savedLocal[key]=hex;saveLocal(savedLocal);saveRemoteColor(kind,name,hex);}

/* === Корзина изменений (fallback, если нет SAVE_URL) === */
const PENDING=[]; // {locId,title,lat,lng,kind:'tech'|'op',from,to,ts}
function addChange(rec){
  const i=PENDING.findIndex(x=>x.locId===rec.locId && x.kind===rec.kind);
  if(i>=0){PENDING[i].to=rec.to;PENDING[i].ts=Date.now();}
  else{PENDING.push({...rec,ts:Date.now()});}
  renderChangesPanel();
}
function renderChangesPanel(){
  const box=document.getElementById('changesPanel');
  const list=document.getElementById('changesList');
  const hint=document.getElementById('changesHint');
  if(!box||!list) return;
  if(!PENDING.length){box.style.display='none';list.innerHTML='';return;}
  box.style.display='';
  hint.textContent = HAS_SAVE ? 'Проверьте список. «Подтвердить» — запишет в таблицу.' : 'URL скрипта не задан — доступен экспорт CSV.';
  list.innerHTML=PENDING.map((r,i)=>`
    <div style="display:flex;gap:6px;align-items:center;padding:2px 0">
      <span style="opacity:.65">${i+1}.</span>
      <span style="flex:1 1 auto">${r.title}</span>
      <code style="opacity:.75">${r.kind==='tech'?'Техник':'Оператор'}:</code>
      <span style="text-decoration:line-through;opacity:.65">${r.from||'—'}</span>
      <span>→</span>
      <strong>${r.to||'—'}</strong>
    </div>`).join('');
}
function exportPendingCSV(){
  const rows=[['locId','title','lat','lng','kind','from','to','timestamp']];
  for(const r of PENDING){rows.push([r.locId,r.title,r.lat,r.lng,r.kind,r.from,r.to,new Date(r.ts).toISOString()]);}
  const csv=rows.map(r=>r.map(v=>String(v).replace(/"/g,'""')).map(v=>`"${v}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='asp_changes.csv'; document.body.appendChild(a); a.click(); a.remove();
}
async function confirmPending(){
  if(!HAS_SAVE){exportPendingCSV();return;}
  setBadge('Запись в таблицу…');
  try{
    const r=await fetch(SAVE_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({changes:PENDING})});
    if(!r.ok){ throw new Error('HTTP '+r.status); }
    PENDING.length=0; renderChangesPanel(); setBadge('Готово');
  }catch(e){ setBadge('Ошибка записи'); alert('Не удалось записать в таблицу: '+(e.message||e)); }
}
function revertAll(mapUndo){
  for(let i=PENDING.length-1;i>=0;i--){mapUndo(PENDING[i]);}
  PENDING.length=0; renderChangesPanel();
}

/* === Автозапись одной правки (если SAVE_URL задан) === */
async function postChange(rec, undo){
  if(!HAS_SAVE){ addChange(rec); return; } // fallback в «Корзину», если SAVE_URL пуст
  try{
    setBadge('Запись в таблицу…');
    await fetch(SAVE_URL, {
      method:'POST',
      mode:'no-cors',                         // важно: без префлайта
      headers:{'Content-Type':'text/plain'},  // simple request
      body: JSON.stringify({changes:[rec]})
    });
    // Ответ прочитать нельзя (opaque), но на сервер запрос уйдёт, таблица обновится
    setBadge('Отправлено'); 
  }catch(e){
    setBadge('Ошибка записи');
    if(typeof undo==='function') undo(); // откатим на карте
    alert('Не удалось записать в таблицу: '+(e.message||e));
  }
}

/* === КАРТА === */
setBadge("Грузим библиотеки…");
await loadStyle("https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css");
await loadScript("https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js");
await loadScript("https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js");
if(!window.L||!window.Papa) throw new Error("Либы не загрузились");

const map=L.map("map",{attributionControl:false}).setView([55.75,37.62],9);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"© OpenStreetMap contributors"}).addTo(map);
L.control.attribution({prefix:false}).addTo(map);
map.createPane("techPane"); map.getPane("techPane").style.zIndex=430;
map.createPane("opPane");   map.getPane("opPane").style.zIndex=450;

/* === РАФ-полифилы для мобильных (исключаем miniRaf ошибки) === */
const RAF=(typeof requestAnimationFrame==='function')?requestAnimationFrame:(fn)=>setTimeout(fn,0);
const CAF=(typeof cancelAnimationFrame==='function')?cancelAnimationFrame:(id)=>clearTimeout(id);

/* === МИНИ-ЛЕЙБЛЫ === */
const IS_MOBILE=matchMedia('(pointer:coarse)').matches;
const MINI_ZOOM=11;
const MAX_MINI_LABELS=IS_MOBILE?100:120;
let miniRafId=null;

/* === СЛОИ / СТАТЫ === */
const ST={opCounts:new Map(),opDevices:new Map(),techCounts:new Map(),techDevices:new Map(),allMarkers:[]};
const opsByName=new Map(), techByName=new Map();

function layerFor(mapObj,name){if(!mapObj.has(name))mapObj.set(name,L.layerGroup().addTo(map));return mapObj.get(name);}
function triangleMarker(latlng,color){
  const svg=`<svg width="22" height="22" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><polygon points="12,3 2,21 22,21" fill="${color}" stroke="#222" stroke-width="2"/></svg>`;
  const icon=L.divIcon({html:svg,className:"",iconSize:[22,22],iconAnchor:[11,18]});
  return L.marker(latlng,{icon,pane:"techPane"});
}
function recolorTriangleMarker(marker,color){const el=marker.getElement();if(!el)return;const pg=el.querySelector("polygon");if(pg)pg.setAttribute("fill",color);}
function ensureMini(marker,title){ if(marker._mini) return marker._mini; marker._mini=L.tooltip({permanent:true,direction:"right",offset:[10,-2],className:"mini-label"}).setContent(title); return marker._mini; }
function showMini(marker){ if(!marker._mini) return; marker._mini.setLatLng(marker.getLatLng()).addTo(map); }
function hideMini(marker){ if(marker._mini) marker._mini.remove(); }

/* списки имён */
function getAllTechNames(){ return [...ST.techCounts.keys()].sort((a,b)=>a.localeCompare(b,'ru')); }
function getAllOpNames(){ return [...ST.opCounts.keys()].sort((a,b)=>a.localeCompare(b,'ru')); }

/* единый попап (смена оператора/техника) */
function popupHTML({title, op, tech, cntText='', daysText='', locId}){
  return `<b>${title}</b><br>
    Оператор: <span class="as-link js-change-op" data-loc="${locId}">${op||'—'}</span><br>
    Техник: <span class="as-link js-change-tech" data-loc="${locId}">${tech||'—'}</span>
    ${cntText}${daysText}
    <div class="picker op-picker" data-loc="${locId}">
      <select class="op-select">${getAllOpNames().map(n=>`<option value="${n}" ${n===op?'selected':''}>${n}</option>`).join('')}</select>
      <button class="apply-op">Применить</button>
      <button class="cancel-op">Отмена</button>
    </div>
    <div class="picker tech-picker" data-loc="${locId}">
      <select class="tech-select">${getAllTechNames().map(n=>`<option value="${n}" ${n===tech?'selected':''}>${n}</option>`).join('')}</select>
      <button class="apply-tech">Применить</button>
      <button class="cancel-tech">Отмена</button>
    </div>`;
}

/* поиск маркера по locId и виду */
  
function findMarkerByLoc(kind, locId){
  return ST.allMarkers.find(m => m._locId===locId && (kind==='op' ? !!m.setStyle : !m.setStyle));
}
function updatePopupForLoc(locId){
  const opM   = findMarkerByLoc('op',   locId);
  const techM = findMarkerByLoc('tech', locId);

  const any = opM || techM; if(!any) return;
  const title   = any._miniTitle || '';
  const cntText = any._cntText   || '';
  const daysText= any._daysText  || '';
  const opName   = (opM   && opM._opName)   || (techM && techM._opName)   || '';
  const techName = (techM && techM._techName) || (opM   && opM._techName) || '';

  if(opM){
    opM._opName   = opName;
    opM._techName = techName;
    opM.setPopupContent(popupHTML({title, op: opName, tech: techName, cntText, daysText, locId: opM._locId}));
  }
  if(techM){
    techM._opName   = opName;
    techM._techName = techName;
    techM.setPopupContent(popupHTML({title, op: opName, tech: techName, cntText, daysText, locId: techM._locId}));
  }
}

/* перенос маркера между группами (ТЕХНИК) + автосейв */
async function reassignTech(marker, newTech, opts={record:true}){
  const oldTech = marker._techName || '';
    // ...
  marker._techName = newTech;

  // также обновим связанный опер-маркер и оба попапа
  const opMarker = findMarkerByLoc('op', marker._locId);
  if(opMarker){ opMarker._techName = newTech; }
  updatePopupForLoc(marker._locId);

  if(opts.record){
    const ll = marker.getLatLng();
    postChange(
      {locId: marker._locId, title: marker._miniTitle||'', lat: ll.lat, lng: ll.lng, kind: 'tech', from: oldTech, to: newTech},
      ()=> reassignTech(marker, oldTech, {record:false}) // откат на карте если запись сорвётся
    );
  }


  if(!newTech || newTech===oldTech) return;

  const oldLg = techByName.get(oldTech); if(oldLg) oldLg.removeLayer(marker);
  let newLg = techByName.get(newTech); if(!newLg){ newLg=L.layerGroup(); techByName.set(newTech,newLg); }
  newLg.addLayer(marker);

  ST.techCounts.set(oldTech, Math.max(0,(ST.techCounts.get(oldTech)||1)-1));
  ST.techCounts.set(newTech, (ST.techCounts.get(newTech)||0)+1);

  const hex=getColor('tech',newTech,autoColor('tech:'+newTech));
  recolorTriangleMarker(marker,hex); marker._color=hex;

  marker._techName=newTech;
  const html=popupHTML({title:marker._miniTitle||'',op:marker._opName||'',tech:newTech,cntText:marker._cntText||'',daysText:marker._daysText||'',locId:marker._locId});
  marker.setPopupContent(html);

  if(opts.record){
    const ll=marker.getLatLng();
    const rec = {locId:marker._locId,title:marker._miniTitle||'',lat:ll.lat,lng:ll.lng,kind:'tech',from:oldTech,to:newTech};
    await postChange(rec, ()=> reassignTech(marker, oldTech, {record:false}));
  }
}

/* перенос маркера между группами (ОПЕРАТОР) + автосейв */
async function reassignOp(marker, newOp, opts={record:true}){
  const techMarker = findMarkerByLoc('tech', marker._locId);
  if(techMarker){ techMarker._opName = newOp; }
  updatePopupForLoc(marker._locId);

  const oldOp=marker._opName||'';
  if(!newOp || newOp===oldOp) return;

  const oldLg=opsByName.get(oldOp); if(oldLg) oldLg.removeLayer(marker);
  let newLg=opsByName.get(newOp); if(!newLg){newLg=L.layerGroup(); opsByName.set(newOp,newLg);}
  newLg.addLayer(marker);

  ST.opCounts.set(oldOp, Math.max(0,(ST.opCounts.get(oldOp)||1)-1));
  ST.opCounts.set(newOp, (ST.opCounts.get(newOp)||0)+1);

  const hex=getColor('op',newOp,autoColor(newOp));
  marker.setStyle?.({fillColor:hex}); marker._color=hex;

  marker._opName=newOp;
  const html=popupHTML({title:marker._miniTitle||'',op:newOp,tech:marker._techName||'',cntText:marker._cntText||'',daysText:marker._daysText||'',locId:marker._locId});
  marker.setPopupContent(html);

  if(opts.record){
    const ll=marker.getLatLng();
    const rec = {locId:marker._locId,title:marker._miniTitle||'',lat:ll.lat,lng:ll.lng,kind:'op',from:oldOp,to:newOp};
    await postChange(rec, ()=> reassignOp(marker, oldOp, {record:false}));
  }
}

/* обработчики внутри попапа */
map.on('popupopen',(e)=>{
  const root=e.popup.getElement(); if(!root) return;
  const src=e.popup._source; const locId=src?._locId;

  const opLink=root.querySelector('.js-change-op');
  const techLink=root.querySelector('.js-change-tech');
  const opPicker=root.querySelector('.op-picker');
  const techPicker=root.querySelector('.tech-picker');

  opLink && opLink.addEventListener('click',()=>{ if(opPicker) opPicker.style.display='block'; });
  techLink && techLink.addEventListener('click',()=>{ if(techPicker) techPicker.style.display='block'; });

  opPicker?.querySelector('.cancel-op')?.addEventListener('click',()=> opPicker.style.display='none');
  techPicker?.querySelector('.cancel-tech')?.addEventListener('click',()=> techPicker.style.display='none');

  opPicker?.querySelector('.apply-op')?.addEventListener('click', async ()=>{
    const newOp=opPicker.querySelector('.op-select').value;
    const opMarker=findMarkerByLoc('op',locId)||src;
    await reassignOp(opMarker,newOp,{record:true});
  });
  techPicker?.querySelector('.apply-tech')?.addEventListener('click', async ()=>{
    const newTech=techPicker.querySelector('.tech-select').value;
    const techMarker=findMarkerByLoc('tech',locId)||src;
    await reassignTech(techMarker,newTech,{record:true});
  });
});
/* === OSRM / маршрут === */
const OSRM="https://router.project-osrm.org/route/v1/driving/"; const KMH_FALLBACK=30;
function haversine(a,b){
  const R=6371, toRad=(d)=>d*Math.PI/180;
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const s=Math.sin(dLat/2)**2+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}
function nnRoute(points){
  if(points.length<=2) return points.map((p,i)=>({i,...p}));
  const used=new Set(); const route=[]; let current=0;
  used.add(current); route.push(points[current]);
  while(route.length<points.length){
    let best=-1, bestD=1e9, last=route[route.length-1];
    for(let i=0;i<points.length;i++){ if(used.has(i)) continue;
      const d=haversine(last,points[i]); if(d<bestD){bestD=d; best=i;} }
    used.add(best); route.push(points[best]);
  }
  return route.map((p,i)=>({i,...p}));
}
function twoOpt(route){
  const n=route.length; if(n<4) return route;
  const dist=(i,j)=>haversine(route[i],route[j]);
  let improved=true;
  while(improved){
    improved=false;
    for(let i=1;i<n-2;i++)for(let k=i+1;k<n-1;k++){
      const d1=dist(i-1,i)+dist(k,k+1), d2=dist(i-1,k)+dist(i,k+1);
      if(d2+1e-9<d1){const rev=route.slice(i,k+1).reverse(); route=[...route.slice(0,i),...rev,...route.slice(k+1)]; improved=true;}
    }
  }
  return route;
}
let routeLayer=null, routeIndices=[];
function clearRoute(){
  if(routeLayer){map.removeLayer(routeLayer); routeLayer=null;}
  routeIndices.forEach(el=>el.remove()); routeIndices=[];
  document.getElementById("routeMeta").textContent="Маршрут не построен.";
  document.getElementById("btnDownload").disabled=true;
}
async function osrmEdge(a,b){
  const url=`${OSRM}${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
  try{
    const resp=await fetch(url,{cache:"no-store"}); if(!resp.ok) throw new Error("osrm http "+resp.status);
    const json=await resp.json(); const r=json.routes&&json.routes[0]; if(!r) throw new Error("osrm empty");
    return {geom:r.geometry, distKm:r.distance/1000, durMin:r.duration/60};
  }catch(e){
    const d=haversine(a,b);
    return {geom:{type:"LineString",coordinates:[[a.lng,a.lat],[b.lng,b.lat]]}, distKm:d, durMin:(d/KMH_FALLBACK)*60};
  }
}
async function drawRoadRoute(ordered){
  clearRoute();
  let totalKm=0,totalMin=0; const features=[];
  for(let i=1;i<ordered.length;i++){
    const a=ordered[i-1], b=ordered[i];
    const seg=await osrmEdge(a,b);
    totalKm+=seg.distKm; totalMin+=seg.durMin;
    features.push({type:"Feature",geometry:seg.geom,properties:{}});
    await new Promise(r=>setTimeout(r,120));
  }
  const fc={type:"FeatureCollection",features};
  routeLayer=L.geoJSON(fc,{style:{color:"#2f80ed",weight:5,opacity:0.9}}).addTo(map);
  ordered.forEach((p,idx)=>{
    const div=L.divIcon({className:"",html:`<div class="route-index">${idx+1}</div>`});
    routeIndices.push(L.marker([p.lat,p.lng],{icon:div,interactive:false,zIndexOffset:1000}).addTo(map));
  });
  map.fitBounds(routeLayer.getBounds().pad(0.2));
  return {totalKm,totalMin};
}

/* === ЗАГРУЗКА ДАННЫХ и МАРКЕРЫ === */
try{
  Object.assign(savedLocal,await loadRemoteColors()); saveLocal(savedLocal);

  setBadge("Загрузка «Маршрутов»…");
  const csvText=await fetchCsv(ROUTES_CSV);
  const rows=Papa.parse(csvText,{header:true,skipEmptyLines:true}).data||[];
  if(!rows.length) throw new Error("Пустой CSV");

  const keys=Object.keys(rows[0]||{});
  const techKey=detect(keys,["фио техника","technician","tech","техник"]);
  const opKey=detect(keys,["фио оператора","оператор","fio","name","operator"]);
  const nameKey=detect(keys,["маршрут всего локации","маршрут","локация","название","адрес","name"]);
  const latKey=detect(keys,["lat","latitude","широта","y"]);
  const lngKey=detect(keys,["lng","lon","longitude","долгота","x"]);
  const dayCols=[
    {full:detect(keys,["понедельник","monday"]),short:"Пн"},
    {full:detect(keys,["вторник","tuesday"]),short:"Вт"},
    {full:detect(keys,["среда","wednesday"]),short:"Ср"},
    {full:detect(keys,["четверг","thursday"]),short:"Чт"},
    {full:detect(keys,["пятница","friday"]),short:"Пт"},
    {full:detect(keys,["суббота","saturday"]),short:"Сб"},
    {full:detect(keys,["воскресенье","sunday"]),short:"Вс"},
  ].filter(d=>d.full);
  const countCols=keys.filter(k=>/колич|аппарат/i.test(k));
  if(!latKey||!lngKey) throw new Error("Не найдены координаты (lat/lng)");
  if(!nameKey) throw new Error("Не найдено название локации");

  function firstOrMaxCount(row){
    let best=null;
    for(const k of countCols){
      const v=Number(String(row[k]??"").replace(",",".")); if(!isFinite(v)) continue;
      best = best==null ? v : Math.max(best,v);
    }
    return best;
  }
  const tagMarker=(m,title,days,color)=>{m._miniTitle=title; m._days=days||[]; m._color=color; return m;}

  for(const r of rows){
    const lat=toNum(r[latKey]), lng=toNum(r[lngKey]); if(!isFinite(lat)||!isFinite(lng)) continue;
    const title=norm(r[nameKey])||`${lat.toFixed(4)}, ${lng.toFixed(4)}`;
    const op=opKey?norm(r[opKey]):""; const tech=techKey?norm(r[techKey]):"";
    const cnt=firstOrMaxCount(r);
    const days=dayCols.filter(d=>norm(r[d.full])).map(d=>d.short);
    const cntText=cnt!=null?` • Аппаратов: ${cnt}`:"";
    const daysText=days.length?` • Обслуживание: ${days.join(", ")}`:"";
    const locId=safeId(`pt:${title}|${lat}|${lng}`);

    if(tech){
      const color=getColor("tech",tech,autoColor("tech:"+tech));
      const lg=layerFor(techByName,tech);
      const m=triangleMarker([lat,lng],color).bindTooltip(title,{sticky:true,direction:"top",offset:[0,-10]});
      m._locId=locId; m._techName=tech; m._opName=op||''; m._cntText=cntText; m._daysText=daysText;
      m.bindPopup(popupHTML({title,op:m._opName,tech:m._techName,cntText:cntText,daysText:daysText,locId}));
      tagMarker(m,title,days,color);
      lg.addLayer(m);
      ST.techCounts.set(tech,(ST.techCounts.get(tech)||0)+1);
      if(cnt!=null) ST.techDevices.set(tech,(ST.techDevices.get(tech)||0)+cnt);
      ST.allMarkers.push(m);
    }
    if(op){
      const color=getColor("op",op,autoColor(op));
      const lg=layerFor(opsByName,op);
      const m=L.circleMarker([lat,lng],{pane:"opPane",radius:7,weight:2,color:"#222",fillColor:color,fillOpacity:.9})
        .bindTooltip(title,{sticky:true,direction:"top",offset:[0,-10]});
      m._locId=locId; m._opName=op; m._techName=tech||''; m._cntText=cntText; m._daysText=daysText;
      m.bindPopup(popupHTML({title,op:op,tech:m._techName,cntText:cntText,daysText:daysText,locId}));
      tagMarker(m,title,days,color);
      lg.addLayer(m);
      ST.opCounts.set(op,(ST.opCounts.get(op)||0)+1);
      if(cnt!=null) ST.opDevices.set(op,(ST.opDevices.get(op)||0)+cnt);
      ST.allMarkers.push(m);
    }
  }

  if(ST.allMarkers.length){
    const g=L.featureGroup(ST.allMarkers); map.fitBounds(g.getBounds().pad(0.2));
    RAF(updateMiniLabels);
  }

  const opsList=[...ST.opCounts.keys()].sort((a,b)=>(ST.opCounts.get(b)||0)-(ST.opCounts.get(a)||0));
  const techList=[...ST.techCounts.keys()].sort((a,b)=>(ST.techCounts.get(b)||0)-(ST.techCounts.get(a)||0));
  document.getElementById("totals").textContent=`${opsList.length} операторов • ${techList.length} техников • ${ST.allMarkers.length} точек`;
  setBadge(`${opsList.length} операторов • ${techList.length} техников • ${ST.allMarkers.length} точек`);

  const opsUL=document.getElementById("opsList"), techUL=document.getElementById("techList");

  function mountColorSwatch(div,kind,name,initColor){
    div.style.background=initColor;
    const input=document.createElement("input"); input.type="color";
    input.value=/^#[0-9A-Fa-f]{6}$/.test(initColor)?initColor:"#888888";
    div.appendChild(input);
    div.addEventListener("click",()=>input.click());
    input.addEventListener("input",()=>{
      const hex=input.value; setColor(kind,name,hex); div.style.background=hex;
      const store=kind==="op"?opsByName:techByName;
      const layer=store.get(name);
      layer.eachLayer(m=> kind==="op" ? m.setStyle?.({fillColor:hex}) : recolorTriangleMarker(m,hex));
      layer.eachLayer(m=>{ m._color=hex; });
      updateMiniLabels();
    });
  }
  function addRow(targetUl,kind,name,count,devices){
    const id=safeId(`${kind}:${name}`); const sw=kind==="tech"?"swatch tri":"swatch";
    const li=document.createElement("li");
    const devicesText=devices?` (ТА${devices})`:"";
    li.innerHTML=`<input type="checkbox" id="${id}" checked>
      <span class="${sw}"></span>
      <label for="${id}">${name}</label>
      <span class="count">${count}${devicesText}</span>`;
    const cb=li.querySelector("input");
    mountColorSwatch(li.querySelector(".swatch"),kind,name,getColor(kind,name,autoColor(kind==="op"?name:"tech:"+name)));
    const layer=(kind==="op"?opsByName:techByName).get(name);
    cb.onchange=()=>{ if(cb.checked){ const on=(kind==="op"?toggleOps.checked:toggleTech.checked); if(on) layer.addTo(map);} else { map.removeLayer(layer);} updateMiniLabels(); clearRoute(); };
    targetUl.appendChild(li);
  }
  for(const op of opsList){addRow(opsUL,"op",op,ST.opCounts.get(op)||0,ST.opDevices.get(op)||0);}
  for(const t of techList){addRow(techUL,"tech",t,ST.techCounts.get(t)||0,ST.techDevices.get(t)||0);}
  /* === ПЕРЕКЛЮЧАТЕЛИ === */
  const toggleOps=document.getElementById("toggleOps");
  const toggleTech=document.getElementById("toggleTech");

  function updateMiniLabels(){
    if(miniRafId!==null) CAF(miniRafId);
    miniRafId = RAF(()=>{
      const showZoom=map.getZoom()>=MINI_ZOOM;
      const bounds=map.getBounds();
      const visible=[];
      const opOn=toggleOps.checked, techOn=toggleTech.checked;

      for(const [n,lg] of opsByName){
        const cb=document.getElementById(safeId(`op:${n}`));
        const on=opOn && cb?.checked;
        lg.eachLayer(m=>{ if(on && bounds.contains(m.getLatLng())) visible.push(m); else hideMini(m); });
      }
      for(const [n,lg] of techByName){
        const cb=document.getElementById(safeId(`tech:${n}`));
        const on=techOn && cb?.checked;
        lg.eachLayer(m=>{ if(on && bounds.contains(m.getLatLng())) visible.push(m); else hideMini(m); });
      }
      if(!showZoom){ visible.forEach(hideMini); return; }
      const limit=Math.min(MAX_MINI_LABELS,visible.length);
      for(let i=0;i<visible.length;i++){
        const m=visible[i];
        if(i<limit){ if(!m._mini) ensureMini(m,m._miniTitle||""); showMini(m); } else hideMini(m);
      }
    });
  }

  function resetMarkerStyle(m){
    if(m.setStyle){
      m.setStyle({ fillColor:m._color, fillOpacity:0.9, color:"#222", opacity:1 });
    }else{
      const el=m.getElement(); if(!el) return;
      const pg=el.querySelector("polygon"); if(pg) pg.setAttribute("fill",m._color);
      el.style.opacity=1; el.style.pointerEvents="";
    }
  }

  function currentDayShort(){ return ["Вс","Пн","Вт","Ср","Чт","Пт","Сб"][new Date().getDay()]; }
  function applyDayFilter(){
    const daySel=document.getElementById('routeDay').value;
    const showAll=(daySel==="ALL");
    if(showAll){ ST.allMarkers.forEach(resetMarkerStyle); updateMiniLabels(); clearRoute(); return; }
    const target = (daySel==="TODAY") ? currentDayShort() : daySel;
    const styleForMatch=(m,match)=>{
      if(m.setStyle){
        m.setStyle({fillColor: match ? m._color : "#c8c8c8", fillOpacity: match ? 0.9 : 0.15, color:"#222", opacity: match ? 1 : 0.2});
      }else{
        const el=m.getElement(); if(!el) return;
        const pg=el.querySelector("polygon"); if(pg) pg.setAttribute("fill", match ? m._color : "#c8c8c8");
        el.style.opacity = match ? 1 : 0.35; el.style.pointerEvents = "";
      }
      if(!match) hideMini(m);
    };
    ST.allMarkers.forEach(m=>{ const match=(m._days||[]).includes(target); styleForMatch(m,match); });
    updateMiniLabels(); clearRoute();
  }

  function applyVisibility(){
    const opOn=toggleOps.checked, techOn=toggleTech.checked;
    for(const [,lg] of opsByName) map.removeLayer(lg);
    for(const [,lg] of techByName) map.removeLayer(lg);
    if(opOn){ for(const [n,lg] of opsByName){ const cb=document.getElementById(safeId(`op:${n}`)); if(cb&&cb.checked) lg.addTo(map);} }
    if(techOn){ for(const [n,lg] of techByName){ const cb=document.getElementById(safeId(`tech:${n}`)); if(cb&&cb.checked) lg.addTo(map);} }
    updateMiniLabels(); applyDayFilter();
  }
  toggleOps.onchange=applyVisibility;
  toggleTech.onchange=applyVisibility;
  applyVisibility();

  /* === ВКЛАДКИ / МАСС-КНОПКИ === */
  let activeTab="ops";
  const tabOpsBtn=document.getElementById("tabOps"), tabTechBtn=document.getElementById("tabTech"), tabRouteBtn=document.getElementById("tabRoute");
  const routePanel=document.getElementById("routePanel");
  function setTab(t){
    activeTab=t;
    tabOpsBtn.classList.toggle("active",t==="ops");
    tabTechBtn.classList.toggle("active",t==="tech");
    tabRouteBtn.classList.toggle("active",t==="route");
    document.getElementById("opsList").style.display=t==="ops"?"":"none";
    document.getElementById("techList").style.display=t==="tech"?"":"none";
    routePanel.style.display=t==="route"?"":"none";
    updateMiniLabels(); clearRoute();
  }
  tabOpsBtn.onclick=()=>setTab("ops");
  tabTechBtn.onclick=()=>setTab("tech");
  tabRouteBtn.onclick=()=>setTab("route");

  document.getElementById("btnShowAll").onclick=()=>{
    const list=activeTab==="ops"?[...ST.opCounts.keys()]:[...ST.techCounts.keys()];
    const store=activeTab==="ops"?opsByName:techByName;
    const pref=activeTab==="ops"?"op:":"tech:";
    for(const n of list){ const id=safeId(pref+n), cb=document.getElementById(id); if(cb && !cb.checked){ cb.checked=true; store.get(n).addTo(map);} }
    updateMiniLabels(); applyDayFilter();
  };
  document.getElementById("btnHideAll").onclick=()=>{
    const list=activeTab==="ops"?[...ST.opCounts.keys()]:[...ST.techCounts.keys()];
    const store=activeTab==="ops"?opsByName:techByName;
    const pref=activeTab==="ops"?"op:":"tech:";
    for(const n of list){ const id=safeId(pref+n), cb=document.getElementById(id); if(cb && cb.checked){ cb.checked=false; map.removeLayer(store.get(n)); } }
    updateMiniLabels(); clearRoute();
  };

  /* === Маршруты (UI) === */
  const routeRole=document.getElementById("routeRole"),
        routeName=document.getElementById("routeName"),
        routeDay=document.getElementById("routeDay"),
        btnBuild=document.getElementById("btnBuild"),
        btnClear=document.getElementById("btnClear"),
        btnDownload=document.getElementById("btnDownload"),
        routeMeta=document.getElementById("routeMeta");

  function fillRouteNames(){
    const list=routeRole.value==="op"?[...ST.opCounts.keys()]:[...ST.techCounts.keys()];
    routeName.innerHTML=`<option value="" disabled selected>— выберите —</option>`+list.map(n=>`<option>${n}</option>`).join("");
  }
  routeRole.onchange=()=>{fillRouteNames(); clearRoute();};
  routeName.onchange=clearRoute;
  routeDay.onchange=applyDayFilter;

  function collectPoints(kind,name,dayFilter){
    const store=kind==="op"?opsByName:techByName;
    const layer=store.get(name); if(!layer) return [];
    const groupOn=kind==="op"?toggleOps.checked:toggleTech.checked; if(!groupOn) return [];
    const targetDay = dayFilter==="TODAY" ? currentDayShort() : dayFilter;
    const isAll = (dayFilter==="ALL");
    const pts=[];
    layer.eachLayer(m=>{
      const ll=m.getLatLng(), nm=(m.getTooltip()?.getContent())||"", days=m._days||[];
      const allowed = isAll || days.includes(targetDay);
      if(allowed) pts.push({lat:ll.lat,lng:ll.lng,title:nm});
    });
    return pts;
  }
  function toCsv(route){
    const rows=[["order","name","lat","lng","cum_km"]]; let sum=0;
    for(let i=0;i<route.length;i++){ if(i>0) sum+=haversine(route[i-1],route[i]); rows.push([i+1,route[i].title||"",route[i].lat,route[i].lng,sum.toFixed(3)]); }
    return rows.map(r=>r.map(v=>String(v).replace(/"/g,'""')).map(v=>`"${v}"`).join(",")).join("\n");
  }

  btnBuild.onclick=async()=>{
    const kind=routeRole.value, name=routeName.value, day=routeDay.value;
    if(!name){routeMeta.textContent="Выберите имя.";return;}
    const pts=collectPoints(kind,name,day);
    if(pts.length<2){routeMeta.textContent="Недостаточно точек по выбранному дню (или слой скрыт).";clearRoute();return;}
    const MAX=200; let route=twoOpt(nnRoute(pts.slice(0,MAX)));
    const dayLabel = day==="TODAY" ? `сегодня (${currentDayShort()})` : (day==="ALL"?"все дни":day);
    setBadge("Маршрут по дорогам…");
    const {totalKm,totalMin}=await drawRoadRoute(route);
    setBadge(`${[...ST.opCounts.keys()].length} операторов • ${[...ST.techCounts.keys()].length} техников • ${ST.allMarkers.length} точек`);
    routeMeta.textContent=`День: ${dayLabel} • Точек: ${route.length} • Длина: ${totalKm.toFixed(2)} км • Время: ${totalMin.toFixed(0)} мин (OSRM)`;
    const csv=toCsv(route);
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"}); const url=URL.createObjectURL(blob);
    btnDownload.onclick=()=>{ const a=document.createElement("a"); a.href=url; a.download=`route_${kind}_${name}_${day}.csv`; document.body.appendChild(a); a.click(); a.remove(); };
    btnDownload.disabled=false;
  };
  btnClear.onclick=clearRoute;

  // Панель изменений (fallback)
  document.getElementById('btnExportCSV').onclick=exportPendingCSV;
  document.getElementById('btnConfirmAll').onclick=confirmPending;
  document.getElementById('btnRevertAll').onclick=()=>revertAll((r)=>{
    const m=findMarkerByLoc(r.kind,r.locId);
    if(!m) return;
    if(r.kind==='tech') reassignTech(m,r.from,{record:false});
    else reassignOp(m,r.from,{record:false});
  });

  // стартовые действия
  fillRouteNames();
  applyDayFilter();
  updateMiniLabels();
  map.on("zoomend moveend",updateMiniLabels);
  map.on("layeradd layerremove",updateMiniLabels);

}catch(err){
  console.error(err);
  const d=document.createElement("div"); d.className="fatal";
  d.innerHTML=`<b>Критическая ошибка</b><br>${err.message||err}`;
  document.body.appendChild(d);
  setBadge("Ошибка");
}

document.getElementById("filtersToggle").onclick=()=>document.body.classList.toggle("filters-closed");
</script>
</body>
</html>
